<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<link rel="stylesheet" href="../styles/bootstrap-4.0.0_alpha2.min.css">
<link rel="stylesheet" href="../styles/sidebar_menu.css">
<link rel="stylesheet" href="../styles/font-awesome-4.5.0.min.css">
<link rel="stylesheet" href="../styles/jquery-ui-1.11.4.min.css">
<link rel="stylesheet" href="../styles/autocomplete.css">
<link rel="stylesheet" href="../styles/spinner.css">
</head>
<body>
  <nav class="navbar navbar-full navbar-light bg-primary">
    <!-- Brand and toggle get grouped for better mobile display -->
    <a class="navbar-brand">Jecstar ETM</a>      
    <div class="nav">
      <div id="spinner" class="pull-right" style="display: none;">
        <div class="spinner_line"></div>
        <div class="spinner_line spinner_line_2"></div>
        <div class="spinner_line spinner_line_3"></div>
        <div class="spinner_line spinner_line_4"></div>
      </div>
      <button type="button" class="navbar-toggler hidden-md-up" data-toggle="collapse" id="menu-toggle">
        <span class="fa fa-bars" aria-hidden="true"></span>
      </button>
      <button type="button" class="navbar-toggler hidden-sm-down" data-toggle="collapse" id="menu-toggle-2">
        <span class="fa fa-bars" aria-hidden="true"></span>
      </button>
    </div>
    
    <!-- navbar-header-->
  </nav>
  <div id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
      <ul class="sidebar-nav nav-pills nav-stacked" id="menu">
        <li class="nav-item">
          <a href="../dashboard/" class="nav-link"><span class="fa-stack fa-lg pull-left"><i class="fa fa-dashboard fa-stack-1x"></i></span> Dashboard</a>
        </li>
        <li class="nav-item">
          <a href="../search/" class="nav-link"><span class="fa-stack fa-lg pull-left"><i class="fa fa-search fa-stack-1x"></i></span> Search</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link"><span class="fa-stack fa-lg pull-left"><i class="fa fa-user fa-stack-1x"></i></span>User preferences</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link"><span class="fa-stack fa-lg pull-left"><i class="fa fa-wrench fa-stack-1x"></i></span>Settings</a>
        </li>
      </ul>
    </div>
      <div class="spinner pull-right">
        <div class="double-bounce1"></div>
        <div class="double-bounce2"></div>
      </div>
    <!-- /#sidebar-wrapper -->
    <!-- Page Content -->
    <div id="page-content-wrapper">
      <div class="container-fluid">
         <div class="row">
           <div class="col-md-3 col-md-push-9">
             <div class="card card-block">
               <h5 class="card-title">Templates</h5>
               <div id="search_templates" class="card-text">
                <ul id="list-template-links" style="padding-left: 1em;"></ul>
               </div>
               <div class="input-group input-group-sm">
                 <input id="template-name" type="text" class="form-control" placeholder="Template name..." disabled="disabled">
                 <span class="input-group-btn">
                   <button id="btn-save-template"class="btn btn-primary" type="button" disabled="disabled">Save</button>
                 </span>
               </div>
             </div>
           </div>
           
           <div class="col-md-9 col-md-pull-3">
             <div class="row">
               <div class="card card-block">
                 <h5 class="card-title">Search</h5>
                 <div class="card-text">
                   <p>Please select the event types you want to search for, and fill in a search term in the search bar.</p>
                   <div id="errorBox" class="alert alert-danger" style="display: none;" role="alert"></div>
                   <label class="checkbox-inline">
                     <input type="checkbox" id="check-type-business" value="business" checked="checked"> Business
                   </label>
                   <label class="checkbox-inline">
                     <input type="checkbox" id="check-type-http" value="http" checked="checked"> Http
                   </label>
                   <label class="checkbox-inline">
                     <input type="checkbox" id="check-type-log" value="log" checked="checked"> Log
                   </label>                 
                   <label class="checkbox-inline">
                     <input type="checkbox" id="check-type-messaging" value="messaging" checked="checked"> Messaging
                   </label>                 
                   <label class="checkbox-inline">
                     <input type="checkbox" id="check-type-sql" value="sql" checked="checked"> SQL
                   </label>                 
                   <div class="input-group">
                     <input id="query-string" type="text" class="form-control" placeholder="Search for..." autofocus autocomplete="off">
                     <span class="input-group-btn">
                       <button id="btn-search" class="btn btn-primary" type="button" disabled="disabled">Search</button>
                     </span>
                   </div>
                 </div>
               </div>
             </div>
             <div class="row" id="result_block" style="display: none">
               <div class="card card-block">
                 <h5 class="card-title">Search results<small id="search-stats"></small><small style="font-size: 100%;"><a id="link-edit-table" href="#" class="fa fa-pencil-square-o pull-right"></a></small></h5>
                 <div id="result_card" class="card-text">
                 </div>
               </div>
             </div>
           </div>
         </div>
      </div>
    </div>
    <!-- /#page-content-wrapper -->
  </div>
  
  <div class="modal fade" id="modal-template-overwrite" tabindex="-1" role="dialog" aria-labelledby="template-overwrite-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="template-overwrite-modal-label">Name already exists</h4>
        </div>
        <div class="modal-body">
          A template with the name '<i id="overwrite-template-name"></i>' already exists. Do you want to overwrite that template?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button id="btn-overwrite-template" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modal-template-remove" tabindex="-1" role="dialog" aria-labelledby="template-remove-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="template-remove-modal-label">Confirm removal</h4>
        </div>
        <div class="modal-body">
          Are you sure you want to remove the template '<i id="remove-template-name"></i>' ?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button id="btn-remove-template" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modal-table-settings" tabindex="-1" role="dialog" aria-labelledby="table-settings-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="table-settings-modal-label">Table settings</h4>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="table-settings-sort-field">Sort field</label>
                <input id="table-settings-sort-field" type="text" class="form-control" />
            </div>
            <div class="form-group">
                <label for="table-settings-sort-order">Sort order</label>
                <select id="table-settings-sort-order" class="form-control" >
                  <option value="asc">Ascending</option>
                  <option value="desc">Descending</option>
                </select>
            </div>
            <div class="card card-block">
                <div class="card-title"><h5>Columns</h5></div>
                <div id="table-settings-columns">
                </div>
            </div>    
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button id="btn-apply-table-settings" type="button" class="btn btn-primary">Apply</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- jQuery first, then Bootstrap JS. -->
  <script src="../scripts/jquery-2.2.2.min.js"></script>
  <script src="../scripts/jquery-ui-1.11.4.min.js"></script>
  <script src="../scripts/bootstrap-4.0.0_alpha2.min.js"></script>
  <script src="../scripts/moment-2.12.0.min.js"></script>
  <script src="../scripts/moment-timezone-with-data-2010-2020.min.js"></script>
  <script src="../scripts/sidebar_menu.js"></script>
  <script src="../scripts/autocomplete_fields.js"></script>
  
  <script>
    var queryKeywords = null;
    $.ajax({
        type: 'GET',
        async: false,
        contentType: 'application/json',
        url: '../rest/search/keywords/etm_event_all',
        success: function(data) {
            if (!data || !data.keywords) {
                return;
            }
            queryKeywords = data.keywords;
        }
    });
    
    var tableLayout = {
        fields: [
            {name: 'Timestamp', field: 'endpoints.writing_endpoint_handler.handling_time', format: 'isodate', array: 'lowest' }, 
            {name: 'Name', field: 'name', format: 'plain', array: 'first'}
        ],
        sort_field: 'endpoints.writing_endpoint_handler.handling_time',
        sort_order: 'desc',
        getFieldNames: function () {
            return this.fields.map(function(item, index) {
                return item.name;
            })
        },
        getInternalFieldNames: function () {
            return this.fields.map(function(item, index) {
                return item.field;
            })
        },
        getValueFromSource: function(source, tableColumn, timeZone) {
            var fieldParts = tableColumn.field.split("\.");
            var values = [];
            tableLayout.retrieveValuesFromSource(source, fieldParts, values);
            if (values.length == 0) {
                return ''
            } else if (values.length == 1) {
                return tableLayout.formatValue(values[0], tableColumn, timeZone);
            }
            if ('first' === (tableColumn.array)) {
                return tableLayout.formatValue(values[0], tableColumn, timeZone);
            } else if ('last' === (tableColumn.array)) {
                return tableLayout.formatValue(values[values.length -1], tableColumn, timeZone);
            } else if ('lowest' === (tableColumn.array)) {
                return tableLayout.formatValue(values.sort()[0], tableColumn, timeZone);
            } else if ('highest' === (tableColumn.array)) {
                return tableLayout.formatValue(values.sort()[values.length -1], tableColumn, timeZone);
            } 
            return tableLayout.formatValue(values[0], tableColumn, timeZone);
        },
        retrieveValuesFromSource: function(source, fields, values) {
            var currentObject = source;
            $(fields).each(function (index, fieldName) {
                var container = currentObject[fieldName];
                if (container) {
                    if (tableLayout.isArray(container)) {
                        $(container).each(function (i,v){
                            tableLayout.retrieveValuesFromSource(v, fields.slice(index + 1), values);
                        });
                    } else {
                        currentObject = container;
                        if (index + 1 == fields.length) {
                            values.push(container);
                        }
                    }
                } else {
                    return true;
                }
            });
        },
        formatValue: function(value, tableColumn, timeZone) {
            if ('plain' === (tableColumn.format)) {
                return value;
            } else if ('isoutcdate' === tableColumn.format) {
                if (value) {
                    return new Date(value).toISOString();
                } else {
                    return ''; 
                }
            } else if ('isodate' === tableColumn.format) {
                if (value) {
                    return moment.tz(value, timeZone).format();
                } else {
                    return ''; 
                }
            }
            return value;
        },
        isArray: function(fieldToTest) {
            return Object.prototype.toString.call(fieldToTest) === '[object Array]';
        },
        
    }
    
    $(document).ajaxStart(function () {
        $("#errorBox").hide('fast');
        $('#spinner').fadeIn(250);
    }).ajaxStop(function () {
        $('#spinner').fadeOut(500);
    }).ajaxError(function(event, jqXHR, settings, thrownError) {
        $("#errorBox").text('Error executing query: ' +  jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')');
        $("#errorBox").show('fast');
    });
  
    $('[id^=check-type-]').on('change', function() {
        enableOrDisableSearchButton();
        if ($('[id^=check-type-]:checked').size() == 0) {
            $('#query-string').attr('disabled', 'disabled');
        } else {
            $('#query-string').removeAttr('disabled');
        }
    });
    
    // Disable or enable the search button, template name inputfield and save button if the query field contains data.
    $('#query-string').on('input', enableOrDisableSearchButton)
    .bind('keydown', function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete('instance').menu.active ) {
            event.preventDefault();
        } else if ( event.keyCode === $.ui.keyCode.DOWN && !$(this).autocomplete('instance').menu.active) {
            if ($(this).val() === '') {
                $(this).autocomplete( "search", "" );
            }
        } else if ( event.keyCode === $.ui.keyCode.ENTER && !$(this).autocomplete('instance').menu.active && $(this).val()) {
            executeQuery(createQuery());
        }
    }).autocompleteFieldQuery({queryKeywords: queryKeywords});
    
    $('#table-settings-sort-field').bind('keydown', function( event ) {
        if (event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete('instance').menu.active) {
            event.preventDefault();
        } else if ( event.keyCode === $.ui.keyCode.DOWN && !$(this).autocomplete('instance').menu.active) {
            if ($(this).val() === '') {
                $(this).autocomplete( "search", "" );
            }
        } else if (event.keyCode === $.ui.keyCode.ESCAPE && $(this).autocomplete('instance').menu.active) {
            event.stopPropagation();
        }
    }).autocompleteFieldQuery({queryKeywords: queryKeywords, mode: 'field'});
    
    
    $('#btn-search').click(function() {
        executeQuery(createQuery());
    });
    
    $('#template-name').on('input', function() {
        if (!$(this).val()) {
            $('#btn-save-template').attr('disabled', 'disabled');
        } else {
            $('#btn-save-template').removeAttr('disabled');
        }
    });

    $('#btn-save-template').click(function() {
        var template = createTemplate();
        var current = $('#list-template-links > li > a').filter(function() {
            return $(this).text() === template.name;
        }).toArray();
        if (current.length != 0) {
            $('#overwrite-template-name').text(template.name);
            $('#modal-template-overwrite').modal();
        } else {
            storeTemplate(template, false);
        }
    });

    $('#btn-overwrite-template').click(function() {
        $('#modal-template-overwrite').modal('hide');
        storeTemplate(createTemplate(), true);
    });
    
    $('#btn-remove-template').click(function() {
        var templateName = $('#remove-template-name').text();
        $.ajax({
            type: 'DELETE',
            contentType: 'application/json',
            url: '../rest/search/templates/' + encodeURIComponent(templateName),
            success: function() {
                $('#list-template-links > li > a').filter(function() {
                        return $(this).text() === templateName;
                    }).parent().remove();
            }
        });        
        $('#modal-template-remove').modal('hide');
    });
    
    $('#link-edit-table').click(function () {
        $('#table-settings-sort-field').val(tableLayout.sort_field);
        $('#table-settings-sort-order').val(tableLayout.sort_order);
        $('#table-settings-columns').empty();
        $(tableLayout.fields).each(function(index, column) {
            $('#table-settings-columns').append(
                $('<div>').addClass('form-inline').attr('style', 'margin: 5px;').append(
                    $('<input>').attr('type', 'text').addClass('form-control form-control-sm').attr('placeholder', 'Name').val(column.name),
                    '&nbsp;',
                    $('<input>').attr('type', 'text').addClass('form-control form-control-sm').attr('placeholder', 'Field').val(column.field)
                        .bind('keydown', function( event ) {
                             if (event.keyCode === $.ui.keyCode.ESCAPE && $(this).autocomplete('instance').menu.active) {
                                 event.stopPropagation();
                             }
                         })
                        .autocompleteFieldQuery({queryKeywords: queryKeywords, mode: 'field'}),
                    '&nbsp;',
                    $('<select>').addClass('form-control form-control-sm')
                        .append($('<option>').attr('value', 'plain').text('Plain'))
                        .append($('<option>').attr('value', 'isodate').text('ISO Date'))
                        .append($('<option>').attr('value', 'isoutcdate').text('ISO UTC Date')).val(column.format),
                    '&nbsp;',    
                    $('<select>').addClass('form-control form-control-sm')
                        .append($('<option>').attr('value', 'lowest').text('Lowest'))
                        .append($('<option>').attr('value', 'highest').text('Highest'))
                        .append($('<option>').attr('value', 'first').text('First'))
                        .append($('<option>').attr('value', 'last').text('Last')).val(column.array)
                )
            )
        }); 
        $('#modal-table-settings').modal();
    });
    
    $('#btn-apply-table-settings').click(function () {
        var changed = false;
        if (tableLayout.sort_field !== $('#table-settings-sort-field').val()) {
            changed = true;
            tableLayout.sort_field = $('#table-settings-sort-field').val();
        }
        if (tableLayout.sort_order !== $('#table-settings-sort-order').val()) {
            changed = true;
            tableLayout.sort_order = $('#table-settings-sort-order').val();
        }
        if (changed) {
            executeQuery(createQuery());    
        }
        $('#modal-table-settings').modal('hide');
    });
    
    // Load the stores search templates.
    $.ajax({
        type: 'GET',
        contentType: 'application/json',
        url: '../rest/search/templates',
        success: function(data) {
            if (!data || !data.searchtemplates) {
                return;
            }
            $.each(data.searchtemplates, function(index, template){
                $('#list-template-links').append(
                    $('<li>').append(
                        $('<a href="#">').click(function() {
                           setValuesFromTemplate(template)
                        }).text(template.name)
                    ,
                        $('<a href="#" class="fa fa-times pull-right" style="color: #a94442;">').click(function() {
                           askRemoveTemplate(template)
                        })
                    )
                );
            });
        }
    });
    
    function enableOrDisableSearchButton() {
        if (!$('#query-string').val() || $('[id^=check-type-]:checked').size() == 0) {
            $('#btn-search, #template-name, #btn-save-template').attr('disabled', 'disabled');
        } else {
            $('#btn-search, #template-name').removeAttr("disabled");
            if ($('#template-name').val()) {
                $('#btn-save-template').removeAttr("disabled");
            }
        }
    }
    
    function createQuery() {
        if (!$('#query-string').val() || $('[id^=check-type-]:checked').size() == 0) {
            return null;
        }
        var query = { 
            query: $('#query-string').val(),
            types: $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get(),
            fields: tableLayout.getInternalFieldNames(),
            sort_field: tableLayout.sort_field,
            sort_order: tableLayout.sort_order
        };
        return query;
    }
    
    function executeQuery(queryParameters) {
        if (!queryParameters) {
            return;
        }
        $('#result_block').show();
        $.ajax({
            type: 'POST',
            contentType: 'application/json',
            url: '../rest/search/query',
            data: JSON.stringify(queryParameters),
            success: function(data) {
                $('#search-stats').text(':  ' + data.hits_as_string + ' hits found in ' + data.query_time_as_string + 'ms.');
                $('#result_card').empty();
                if (data.hits === 0) {
                    $('#result_card').append($('<p>').text('No results found'));
                } else {
                    var resultTable = $('<table>')
                    $(resultTable)
                        .addClass('table table-hover table-sm')
                        .append($('<thead>')
                            .append(function () {
                                var tr = $('<tr>');
                                $(tableLayout.fields).each(function (index, tableColumn) {
                                    $(tr).append($('<th style="padding: 0.1rem">').text(tableColumn.name))       
                                });    
                                return $(tr);
                            })
                        )
                        .append(function() {
                            var body = $('<tbody>')
                            $(data.results).each(function (index, searchResult) {
                                $(body).append(function () {
                                    var tr = $('<tr>');
                                    $(tableLayout.fields).each(function (index, field) {
                                        $(tr).append($('<td style="padding: 0.1rem">').text(tableLayout.getValueFromSource(searchResult.source, field, data.timeZone)))       
                                    });    
                                    return $(tr);
                                })
                            });
                            return $(body);
                        })
                    $('#result_card').append($(resultTable));    
                }
            }
        });    
    }
    
    function setValuesFromTemplate(template) {
        $('[id^=check-type-]').prop('checked', false);
        $.each(template.types, function(index, type){
            $('#check-type-' + type).prop('checked', true);    
        });
        $('#query-string').val(template.query);
        $('#template-name').val(template.name);
        tableLayout.fields = template.fields;
        tableLayout.sort_field = template.sort_field;
        tableLayout.sort_order = template.sort_order;
        $('#query-string').removeAttr('disabled').trigger('input');
    }
    
    function createTemplate() {
        var template = { 
            name: $('#template-name').val(),
            query: $('#query-string').val(),
            types: $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get(),
            fields: tableLayout.fields,
            sort_field: tableLayout.sort_field,
            sort_order: tableLayout.sort_order            
        };
        return template;
    }
    
    function storeTemplate(template, isOverwrite) {
        $.ajax({
            type: 'PUT',
            contentType: 'application/json',
            url: '../rest/search/templates/' + encodeURIComponent($('#template-name').val()),
            data: JSON.stringify(template),
            success: function() {
                $('#template-name').val('');
                if (isOverwrite) {
                    $('#list-template-links > li > a').filter(function() {
                        return $(this).text() === template.name;
                    }).unbind('click').click(function() {
                        setValuesFromTemplate(template)
                    });
                } else {
                    $('#list-template-links').append(
                        $('<li>').append(
                            $('<a href="#">').click(function() {
                               setValuesFromTemplate(template)
                            }).text(template.name)
                        ,
                            $('<a href="#" class="fa fa-times pull-right" style="color: #a94442;">').click(function() {
                               askRemoveTemplate(template)
                            })
                        )
                    );
                }
            }
        });
    }
    
    function askRemoveTemplate(template) {
        $('#remove-template-name').text(template.name);
        $('#modal-template-remove').modal();
    }
    
    function escapeToHtml(stringToEscape) {
        return $("<div></div>").text(stringToEscape).html();
    }
    

    
  </script>
  
</body>
</html>
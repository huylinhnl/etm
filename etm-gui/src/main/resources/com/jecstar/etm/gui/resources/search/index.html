<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<link rel="stylesheet" href="../styles/bootstrap-4.0.0_alpha2.min.css">
<link rel="stylesheet" href="../styles/sidebar_menu.css">
<link rel="stylesheet" href="../styles/font-awesome-4.5.0.min.css">
<link rel="stylesheet" href="../styles/jquery-ui-1.11.4.min.css">
<link rel="stylesheet" href="../styles/autocomplete.css">
</head>
<body>
  <nav class="navbar navbar-full navbar-light bg-primary">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header fixed-brand">
      <button type="button" class="navbar-toggler hidden-sm-up" data-toggle="collapse" id="menu-toggle">
        <span class="fa fa-bars" aria-hidden="true"></span>
      </button>
      <button type="button" class="navbar-toggler hidden-xs-down" data-toggle="collapse" id="menu-toggle-2">
        <span class="fa fa-bars" aria-hidden="true"></span>
      </button>
      <a class="navbar-brand">Jecstar ETM</a>
    </div>
    <!-- navbar-header-->
  </nav>
  <div id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
      <ul class="sidebar-nav nav-pills nav-stacked" id="menu">
        <li class="nav-item">
          <a href="../dashboard/" class="nav-link"><span class="fa-stack fa-lg pull-left"><i class="fa fa-dashboard fa-stack-1x"></i></span> Dashboard</a>
        </li>
        <li class="nav-item">
          <a href="../search/" class="nav-link"><span class="fa-stack fa-lg pull-left"><i class="fa fa-search fa-stack-1x"></i></span> Search</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link"><span class="fa-stack fa-lg pull-left"><i class="fa fa-user fa-stack-1x"></i></span>User preferences</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link"><span class="fa-stack fa-lg pull-left"><i class="fa fa-wrench fa-stack-1x"></i></span>Settings</a>
        </li>
      </ul>
    </div>
    <!-- /#sidebar-wrapper -->
    <!-- Page Content -->
    <div id="page-content-wrapper">
      <div class="container-fluid">
         <div class="row">
           <div class="col-sm-9">
             <div class="card card-block">
               <h5 class="card-title">Search</h5>
               <div class="card-text">
                 <p>Please select the event types you want to search for, and fill in a search term in the search bar.</p>
                 <label class="checkbox-inline">
                   <input type="checkbox" id="check-type-business" value="business" checked="checked"> Business
                 </label>
                 <label class="checkbox-inline">
                   <input type="checkbox" id="check-type-http" value="http" checked="checked"> Http
                 </label>
                 <label class="checkbox-inline">
                   <input type="checkbox" id="check-type-log" value="log" checked="checked"> Log
                 </label>                 
                 <label class="checkbox-inline">
                   <input type="checkbox" id="check-type-messaging" value="messaging" checked="checked"> Messaging
                 </label>                 
                 <label class="checkbox-inline">
                   <input type="checkbox" id="check-type-sql" value="sql" checked="checked"> SQL
                 </label>                 
                 <div class="input-group">
                   <input id="query-string" type="text" class="form-control" placeholder="Search for..." autofocus autocomplete="off">
                   <span class="input-group-btn">
                     <button id="btn-search" class="btn btn-primary" type="button" disabled="disabled">Search</button>
                   </span>
                 </div>
               </div>
             </div>
           </div>
           <div class="col-sm-3">
             <div class="card card-block">
               <h5 class="card-title">Templates</h5>
               <div id="search_templates" class="card-text">
                <ul id="list-template-links"></ul>
               </div>
               <div class="input-group input-group-sm">
                 <input id="template-name" type="text" class="form-control" placeholder="Template name..." disabled="disabled">
                 <span class="input-group-btn">
                   <button id="btn-save-template"class="btn btn-primary" type="button" disabled="disabled">Save</button>
                 </span>
               </div>
             </div>
           </div>
         </div>
      </div>
    </div>
    <!-- /#page-content-wrapper -->
  </div>
  
  <div class="modal fade" id="modal-template-overwrite" tabindex="-1" role="dialog" aria-labelledby="template-overwrite-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="template-overwrite-modal-label">Name already exists</h4>
        </div>
        <div class="modal-body">
          A template with the name '<i id="overwrite-template-name"></i>' already exists. Do you want to overwrite that template?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button id="btn-overwrite-template" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modal-template-remove" tabindex="-1" role="dialog" aria-labelledby="template-remove-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="template-remove-modal-label">Confirm removal</h4>
        </div>
        <div class="modal-body">
          Are you sure you want to remove the template '<i id="remove-template-name"></i>' ?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button id="btn-remove-template" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- jQuery first, then Bootstrap JS. -->
  <script src="../scripts/jquery-2.2.2.min.js"></script>
  <script src="../scripts/jquery-ui-1.11.4.min.js"></script>
  <script src="../scripts/bootstrap-4.0.0_alpha2.min.js"></script>
  <script src="../scripts/sidebar_menu.js"></script>
  
  <script>
    var queryKeywords = null;
    var queryOperators = ['AND', 'AND NOT', 'OR'];
    var queryForFields = ['_exists_', '_missing_'];
  
    $('[id^=check-type-]').on('change', enableOrDisableSearchButton);
    
    // Disable or enable the search button, template name inputfield and save button if the query field contains data.
    $('#query-string').on('input', enableOrDisableSearchButton)
    .bind('keydown', function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete('instance').menu.active ) {
            event.preventDefault();
        } else if ( event.keyCode === $.ui.keyCode.DOWN && !$(this).autocomplete('instance').menu.active) {
            if ($(this).val() === '') {
                $(this).autocomplete( "search", "" );
            }
        } else if ( event.keyCode === $.ui.keyCode.ENTER && !$(this).autocomplete('instance').menu.active && $(this).val()) {
            executeQuery(createQuery());
        }
    // TODO! Autocomplete on mobile devices. 
    }).autocomplete({
        minLength: 0,
        source: function( request, response ) {
          var query = extractAutocompleteTerm(request.term);
          if (query.queryTerm === null) {
            return;
          }
          if ("fieldTermValue" === query.queryType) {
            var fieldSuggestions = $.grep(getCurrentKeywords(), function( n, i ) {
                return queryForFields.indexOf(n) == -1;
            });
            response($.ui.autocomplete.filter(fieldSuggestions, query.queryTerm));
          } else if ("field" === query.queryType) {
            response($.ui.autocomplete.filter(getCurrentKeywords(), query.queryTerm));
          }
        },
        focus: function() {
          // prevent value inserted on focus
          return false;
        },
        select: function( event, ui ) {
          var query = extractAutocompleteTerm(this.value);
          if ('' === query.queryTerm) {
            this.value += ui.item.value;
          } else {
            var ix = this.value.lastIndexOf(query.queryTerm);
            if (ix != -1) {
                this.value = this.value.substring(0, ix) + ui.item.value;
            }
          }
          if ("field" === query.queryType) {
            this.value += ':'
          }
          this.value += ' '
          return false;
        }
    });
    
    $('#btn-search').click(function() {
        executeQuery(createQuery());
    });
    
    $('#template-name').on('input', function(){
        if (!$(this).val()) {
            $('#btn-save-template').attr('disabled', 'disabled');
        } else {
            $('#btn-save-template').removeAttr("disabled");
        }
    });

    $('#btn-save-template').click(function() {
        var template = { 
            name: $('#template-name').val(),
            query: $('#query-string').val(),
            types: $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get() 
        };
        var current = $('#list-template-links > li > a').filter(function() {
            return $(this).text() === template.name;
        }).toArray();
        if (current.length != 0) {
            $('#overwrite-template-name').text(template.name);
            $('#modal-template-overwrite').modal();
        } else {
            storeTemplate(template, false);
        }
    });

    $('#btn-overwrite-template').click(function() {
        $('#modal-template-overwrite').modal('hide');
        var template = { 
            name: $('#template-name').val(),
            query: $('#query-string').val(),
            types: $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get()
        };
        storeTemplate(template, true);
    });
    
    $('#btn-remove-template').click(function() {
        $('#modal-template-remove').modal('hide');
        var templateName = $('#remove-template-name').text();
        $.ajax({
            type: 'DELETE',
            contentType: 'application/json',
            url: '../rest/search/templates/' + encodeURIComponent(templateName),
            success: function() {
                $('#list-template-links > li > a').filter(function() {
                        return $(this).text() === templateName;
                    }).parent().remove();
            }
        });        
    });
    
    // Load the stores search templates.
    $.ajax({
        type: 'GET',
        contentType: 'application/json',
        url: '../rest/search/templates',
        success: function(data) {
            if (!data || !data.searchtemplates) {
                return;
            }
            $.each(data.searchtemplates, function(index, template){
                $('#list-template-links').append(
                    $('<li>').append(
                        $('<a href="#">').click(function() {
                           setValuesFromTemplate(template)
                        }).text(template.name)
                    ,
                        $('<a href="#" class="fa fa-times pull-right" style="color: #a94442;">').click(function() {
                           askRemoveTemplate(template)
                        })
                    )
                );
            });
        }
    });
    
    // Load the query keywords
    $.ajax({
        type: 'GET',
        contentType: 'application/json',
        url: '../rest/search/keywords',
        success: function(data) {
            if (!data || !data.keywords) {
                return;
            }
            queryKeywords = data.keywords;
        }
    });
    
    function getCurrentKeywords() {
        if (!queryKeywords || $('[id^=check-type-]:checked').size() == 0) {
            return null;
        }
        var selectedTypes = $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get();
        var keywordGroups = $(queryKeywords).filter(function (index, keywordGroup) {
            return selectedTypes.indexOf(keywordGroup.type) != -1;
        })
        var values = [];
        $.each(keywordGroups, function(index, keywordGroup) {
            $.merge(values, keywordGroup.names);    
        })
        return $.uniqueSort($(values));
    }
    
    function enableOrDisableSearchButton() {
        if (!$('#query-string').val() || $('[id^=check-type-]:checked').size() == 0) {
            $('#btn-search, #template-name, #btn-save-template').attr('disabled', 'disabled');
        } else {
            $('#btn-search, #template-name').removeAttr("disabled");
            if ($('#template-name').val()) {
                $('#btn-save-template').removeAttr("disabled");
            }
        }
    }
    
    function createQuery() {
        if (!$('#query-string').val() || $('[id^=check-type-]:checked').size() == 0) {
            return null;
        }
        var query = { 
            query: $('#query-string').val(),
            types: $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get()
        };
        return query;
    }
    
    function executeQuery(queryParameters) {
        if (!queryParameters) {
            return;
        }
        $.ajax({
            type: 'POST',
            contentType: 'application/json',
            url: '../rest/search/query',
            data: JSON.stringify(queryParameters),
            success: function() {
            }
        });    
    }
    
    function setValuesFromTemplate(template) {
        $('[id^=check-type-]').prop('checked', false);
        $.each(template.types, function(index, type){
            $('#check-type-' + type).prop('checked', true);    
        });
        $('#query-string').val(template.query);
        $('#query-string').trigger('input');
    }
    
    function storeTemplate(template, isOverwrite) {
        $.ajax({
            type: 'PUT',
            contentType: 'application/json',
            url: '../rest/search/templates/' + encodeURIComponent($('#template-name').val()),
            data: JSON.stringify(template),
            success: function() {
                $('#template-name').val('');
                if (isOverwrite) {
                    $('#list-template-links > li > a').filter(function() {
                        return $(this).text() === template.name;
                    }).unbind('click').click(function() {
                        setValuesFromTemplate(template)
                    });
                } else {
                    $('#list-template-links').append(
                        $('<li>').append(
                            $('<a href="#">').click(function() {
                               setValuesFromTemplate(template)
                            }).text(template.name)
                        ,
                            $('<a href="#" class="fa fa-times pull-right" style="color: #a94442;">').click(function() {
                               askRemoveTemplate(template)
                            })
                        )
                    );
                }
            }
        });
    }
    
    function askRemoveTemplate(template) {
        $('#remove-template-name').text(template.name);
        $('#modal-template-remove').modal();
    }
    
    function escapeToHtml(stringToEscape) {
        return $("<div></div>").text(stringToEscape).html();
    }
    
    function extractAutocompleteTerm(query) {
        if (!query) {
            return { "queryTerm": '', "queryType": "field"};
        } 
        var terms = query.match(/AND\sNOT|AND|OR|[^\s"]+|"([^"]*)"/g);
        if (!terms) {
            return { "queryTerm": query, "queryType": "field"};
        }
        if (terms.length == 1) {
            if (isQueryForFieldTerm(terms[0]) && query.endsWith(' ')) {
                return { "queryTerm": '', "queryType": "fieldTermValue"};
            }
            return { "queryTerm": query, "queryType": "field"};
        } else {
            var lastTerm = terms[terms.length - 1];
            var secondLastTerm = terms[terms.length - 2].trim();
            if (isQueryForFieldTerm(secondLastTerm) && !query.endsWith(' ')) {
                return { "queryTerm": lastTerm, "queryType": "fieldTermValue"};
            }
            if (isQueryForFieldTerm(lastTerm) && query.endsWith(' ')) {
                return { "queryTerm": '', "queryType": "fieldTermValue"};
            }
            if (secondLastTerm.endsWith(':')) {
                return { "queryTerm": null};
            }
            if (queryOperators.indexOf(secondLastTerm) != -1) {
                return { "queryTerm": lastTerm, "queryType": "field"};
            }
            if (queryOperators.indexOf(lastTerm) != -1 && query.endsWith(' ')) {
                return { "queryTerm": '', "queryType": "field"};
            }
        }
        return { "queryTerm": null};
    }
    
    function isQueryForFieldTerm(term) {
        if (!term) {
            return false;
        }  
        var termToQuery = term.trim();
        if (termToQuery.endsWith(':')) {
            termToQuery = termToQuery.substring(0, termToQuery.length - 1);
        }
        return queryForFields.indexOf(termToQuery) != -1;
    }
  </script>
  
</body>
</html>
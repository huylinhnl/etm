<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<title>Jecstar - Enterprise Telemetry Monitor</title>

<link rel="stylesheet" href="../styles/bootstrap.min.css">
<link rel="stylesheet" href="../styles/font-awesome.min.css">
<link rel="stylesheet" href="../styles/jquery-ui.min.css">
<link rel="stylesheet" href="../styles/autocomplete.css">
<link rel="stylesheet" href="../styles/spinner.css">
<style type="text/css">
.headerSortAsc, .headerSortDesc {
    border-bottom-color: #777 !important;
    font-weight: 700 !important;
    white-space: nowrap;
}
.headerSortAsc::after, .headerSortDesc::after {
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    content: "";
    display: inline-block;
    height: 0;
    margin-bottom: 2px;
    margin-left: 5px;
    margin-right: -10px;
    width: 0;
}
.headerSortDesc::after {
    border-top: 4px solid;
}
.headerSortAsc::after {
    border-bottom: 4px solid;
}
.rowContentMargins {
    margin: 0.9375rem 0.9375rem 0rem 0.9375rem;
}
</style>
</head>
<body>
   <nav class="navbar navbar-full navbar-dark" style="background-color: #777;">
     <div class="navbar-header">
        <button class="navbar-toggler hidden-sm-up" type="button" data-toggle="collapse" data-target="#exCollapsingNavbar2">
          &#9776;
        </button>
        <div class="pull-left">
         <!-- This needs to be on 1 line because otherwise the menu will be screwed in konqueror and android browsers -->
         <img src="../images/jecstar.svg" style="max-height: 2.4em; max-width: 2.4em;" />&nbsp;<a class="navbar-brand pull-right" href="http://www.jecstar.com">Jecstar</a>
      </div>
      <div class="collapse navbar-toggleable-xs" id="exCollapsingNavbar2">
        <ul class="nav navbar-nav">
          <li class="nav-item active">
            <a class="nav-link" href="../search/"><span class="fa fa-search fa-lg hidden-sm-down">&nbsp;</span>Search</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../dashboard/"><span class="fa fa-dashboard fa-lg hidden-sm-down">&nbsp;</span>Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../preferences/"><span class="fa fa-user fa-lg hidden-sm-down">&nbsp;</span>Preferences</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#"><span class="fa fa-wrench fa-lg hidden-sm-down">&nbsp;</span>Settings</a>
          </li>
        </ul>
      </div>
      <div id="spinner" class="pull-right" style="display: none;">
        <div class="spinner_line"></div>
        <div class="spinner_line spinner_line_2"></div>
        <div class="spinner_line spinner_line_3"></div>
        <div class="spinner_line spinner_line_4"></div>
      </div>
    </div>
  </nav>
  
  <div id="search-container" class="container-fluid">
     <div class="row">
       <div class="col-md-3 col-md-push-9">
         <div class="row">   
           <div class="card card-block rowContentMargins">
             <h5 class="card-title">Search templates</h5>
             <div class="card-text">
              <ul id="list-template-links" style="padding-left: 1em; word-wrap: break-word;"></ul>
             </div>
             <div class="input-group input-group-sm">
               <input id="template-name" type="text" class="form-control" placeholder="Template name..." disabled="disabled">
               <span class="input-group-btn">
                 <button id="btn-save-template"class="btn btn-primary" type="button" disabled="disabled">Save</button>
               </span>
             </div>
           </div>
         </div>

         <div class="row">   
           <div class="card card-block rowContentMargins">
             <h5 class="card-title">Query history</h5>
             <div class="card-text">
               <ol id="list-query-history-links" style="padding-left: 1em; word-wrap: break-word;"></ol>
             </div>
           </div>
         </div>           
       </div>
       
       <div class="col-md-9 col-md-pull-3">
         <div class="row">
           <div id="search-card" class="card card-block rowContentMargins">
             <h5 class="card-title">Search</h5>
             <div class="card-text">
               <p>
                   Please enter your search string in the field below and press the
                   'Search' button. Specific fields can be searched in the format
                   <mark>fieldname:&lt;value&gt;</mark>
                   . For example, if you want to search for all event generated from
                   application "My Application" the search string will be
                   <mark>endpoints.writing_endpoint_handler.application.name:"My application"</mark>
                   . Multiple field can be combined by using the
                   <mark>AND</mark>
                   or
                   <mark>OR</mark>
                   operator. Range values can be used by applying the format
                   <mark>[&lt;start&gt; TO &lt;end&gt;]</mark>
                   to the field value.
               </p>
               <div class="alert alert-danger errorBox" style="display: none;" role="alert"></div>
               <label class="checkbox-inline">
                 <input type="checkbox" id="check-type-business" value="business" checked="checked"> Business
               </label>
               <label class="checkbox-inline">
                 <input type="checkbox" id="check-type-http" value="http" checked="checked"> Http
               </label>
               <label class="checkbox-inline">
                 <input type="checkbox" id="check-type-log" value="log" checked="checked"> Log
               </label>                 
               <label class="checkbox-inline">
                 <input type="checkbox" id="check-type-messaging" value="messaging" checked="checked"> Messaging
               </label>                 
               <label class="checkbox-inline">
                 <input type="checkbox" id="check-type-sql" value="sql" checked="checked"> SQL
               </label>                 
               <div class="input-group">
                 <input id="query-string" type="text" class="form-control" placeholder="Search for..." autofocus autocomplete="off">
                 <span class="input-group-btn">
                   <button id="btn-search" class="btn btn-primary" type="button" disabled="disabled">Search</button>
                 </span>
               </div>
             </div>
           </div>
         </div>
         <div class="row" id="result_block" style="display: none;">
           <div id="search-result-card" class="card card-block rowContentMargins">
             <h5 class="card-title">Search results<small id="search-stats"></small><small style="font-size: 100%;"><a id="link-edit-table" href="#" class="fa fa-pencil-square-o pull-right"></a></small></h5>
             <div id="result_card" class="card-text">
             </div>
           </div>
         </div>
       </div>
     </div>
  </div>
  
  <div id="event-container" class="container-fluid" style="display: none;">
    <div class="row">
      <div class="card card-block rowContentMargins">
        <h5 class="card-title"><span id="event-card-title">Event</span><small><a id="link-back-to-results" href="#" class="pull-right">Back</a></small></h5>
        <div class="card-text">
          <div class="alert alert-danger errorBox" style="display: none;" role="alert"></div>
    
          <div role="tabpanel" class="bd-example bd-example-tabs">
            <ul role="tablist" id="event-tabs" class="nav nav-tabs">
              <li class="nav-item">
                <a id="event-tab-header" aria-expanded="true" role="tab" href="#event-tab" data-toggle="tab" class="nav-link active">Event</a>
              </li>
            </ul>
            <div id="tabcontents" class="tab-content">
              <div id="event-tab" aria-labelledby="event-tab-header" role="tabpanel" aria-expanded="true" class="tab-pane fade active in">
              </div>
            </div>
          </div>
        </div>
        <hr />
        <div class="text-xs-center">
          <a id="btn-back-to-results" href="#" class="btn btn-primary">Back</a>
        </div>
      </div>
    </div> 
  </div>
  
  <div class="modal fade" id="modal-template-overwrite" tabindex="-1" role="dialog" aria-labelledby="template-overwrite-modal-label" aria-hidden="true">
     <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
           <h4 class="modal-title" id="template-overwrite-modal-label">Name already exists</h4>
         </div>
         <div class="modal-body">
          A template with the name '<i id="overwrite-template-name"></i>' already exists. Do you want to overwrite that template?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button id="btn-overwrite-template" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modal-template-remove" tabindex="-1" role="dialog" aria-labelledby="template-remove-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="template-remove-modal-label">Confirm removal</h4>
        </div>
        <div class="modal-body">
          Are you sure you want to remove the template '<i id="remove-template-name"></i>' ?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button id="btn-remove-template" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modal-table-settings" tabindex="-1" role="dialog" aria-labelledby="table-settings-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="table-settings-modal-label">Table settings</h4>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="table-settings-sort-field">Sort field</label>
                <input id="table-settings-sort-field" type="text" class="form-control" />
            </div>
            <div class="form-group">
                <label for="table-settings-sort-order">Sort order</label>
                <select id="table-settings-sort-order" class="form-control" >
                  <option value="asc">Ascending</option>
                  <option value="desc">Descending</option>
                </select>
            </div>
            <div class="form-group">
                <label for="table-settings-results-per-page">Results per page</label>
                <input id="table-settings-results-per-page" type="number" min="1" step="1" max="500" class="form-control" />
            </div>
            <div class="card card-block">
                <div class="card-title"><h5>Columns</h5></div>
                <div id="table-settings-columns">
                </div>
            </div>    
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button id="btn-apply-table-settings" type="button" class="btn btn-primary">Apply</button>
        </div>
      </div>
    </div>
  </div>
  
  
  
  <!-- jQuery first, then Bootstrap JS. -->
  <script src="../scripts/jquery.min.js"></script>
  <script src="../scripts/jquery-ui.min.js"></script>
  <script src="../scripts/tether.min.js"></script>
  <script src="../scripts/bootstrap.min.js"></script>
  <script src="../scripts/moment.min.js"></script>
  <script src="../scripts/moment-timezone-with-data-2010-2020.min.js"></script>
  <script src="../scripts/cytoscape.min.js"></script>
  <script>
    $(document).ajaxStart(function () {
        $('.errorBox').hide('fast');
        $('#spinner').fadeIn(100);
    }).ajaxStop(function () {
        $('#spinner').fadeOut(200);
    }).ajaxError(function(event, jqXHR, settings, thrownError) {
        if ("undefined" != typeof jqXHR.responseJSON) {
            $('.errorBox').text('Error executing query: ' +  jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')').show('fast');
        } else {
            $('.errorBox').text('Error executing query: ' +  thrownError).show('fast');
        }
    }).ajaxComplete(function(event, jqXHR, settings) {
        var contentType = jqXHR.getResponseHeader("Content-Type");
        if (jqXHR.status === 200 && contentType.toLowerCase().indexOf("text/html") >= 0) {
            // assume that our login has expired - reload our current page
            window.location.reload();
            return;
        }          
    });
    var queryKeywords = null;
    $.ajax({
        type: 'GET',
        async: false,
        contentType: 'application/json',
        url: '../rest/search/keywords/etm_event_all',
        success: function(data) {
            if (!data || !data.keywords) {
                return;
            }
            queryKeywords = data.keywords;
        }
    });
    
    function escapeToHtml(stringToEscape) {
        return $("<div></div>").text(stringToEscape).html();
    }
  </script>
  <script src="../scripts/autocomplete_fields.js"></script>
  <script src="../scripts/searchresults-layout.js"></script>
  <script src="../scripts/event-details.js"></script>
  <script src="../scripts/search-templates.js"></script>
  
  <script>
    $('[id^=check-type-]').on('change', function() {
        enableOrDisableSearchButton();
        if ($('[id^=check-type-]:checked').size() == 0) {
            $('#query-string').attr('disabled', 'disabled');
        } else {
            $('#query-string').removeAttr('disabled');
        }
    });
    
    // Disable or enable the search button, template name inputfield and save button if the query field contains data.
    $('#query-string').on('input', enableOrDisableSearchButton)
    .bind('keydown', function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete('instance').menu.active ) {
            event.preventDefault();
        } else if ( event.keyCode === $.ui.keyCode.DOWN && !$(this).autocomplete('instance').menu.active) {
            if ($(this).val() === '') {
                $(this).autocomplete( "search", "" );
            }
        } else if ( event.keyCode === $.ui.keyCode.ENTER && !$(this).autocomplete('instance').menu.active && $(this).val()) {
            executeQuery(createQuery());
        }
    }).autocompleteFieldQuery({queryKeywords: queryKeywords});
    
    $('#btn-search').click(function() {
        executeQuery(createQuery());
    });
    
    function isSearchInView(elem) {
        var $elem = elem;
        var $window = $(window);
        var docViewTop = $window.scrollTop();
        var docViewBottom = docViewTop + $window.height();
        var elemTop = $elem.offset().top;
        var elemBottom = elemTop + $elem.height();
        return docViewBottom > elemTop;
    }
    
    function enableOrDisableSearchButton() {
        if (!$('#query-string').val() || $('[id^=check-type-]:checked').size() == 0) {
            $('#btn-search, #template-name, #btn-save-template').attr('disabled', 'disabled');
        } else {
            $('#btn-search, #template-name').removeAttr("disabled");
            if ($('#template-name').val()) {
                $('#btn-save-template').removeAttr("disabled");
            }
        }
    }
    
    function createQuery() {
        if (!$('#query-string').val() || $('[id^=check-type-]:checked').size() == 0) {
            return null;
        }
        var query = { 
            query: $('#query-string').val(),
            types: $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get(),
            fields: tableLayout.getInternalFieldNames(),
            start_ix: tableLayout.current_ix,
            max_results: tableLayout.results_per_page,
            sort_field: tableLayout.sort_field,
            sort_order: tableLayout.sort_order,
            fieldsLayout: tableLayout.fields
        };
        return query;
    }
    
    function executeQuery(queryParameters, appendToCurrent) {
        if (!queryParameters) {
            return;
        }
        $('#result_block').show();
        $.ajax({
            type: 'POST',
            contentType: 'application/json',
            url: '../rest/search/query',
            data: JSON.stringify(queryParameters),
            success: function(data) {
                if (!data) {
                    return;
                }
                tableLayout.current_ix = data.start_ix;
                if (appendToCurrent) {
                    var endIx = $('#search-stats').text().lastIndexOf(' ');
                    $('#search-stats').text($('#search-stats').text().substring(0, endIx + 1) + (data.end_ix + 1) + '.');
                    var $body = $('#search_result_table > tbody')
                    $(data.results).each(function (index, searchResult) {
                        $body.append(function () {
                            return createResultTableRow(searchResult, data.time_zone);
                        })
                    });
                    if (!data.has_more_results) {
                        var $body = $('#search_result_table > tfoot').remove();    
                    }
                } else {
                    $('#search-stats').text(':  Found ' + data.hits_as_string + ' results in ' + data.query_time_as_string + 'ms. Showing results ' + (data.start_ix + 1) + ' to ' + (data.end_ix + 1) + '.');
                    $('#result_card').empty();
                    if (data.hits === 0) {
                       $('#result_card').append($('<p>').text('No results found'));
                    } else {
                        var resultTable = $('<table id="search_result_table">');
                        $(resultTable)
                            .addClass('table table-hover table-sm')
                            .append($('<thead>')
                                .append(function () {
                                    var $tr = $('<tr>');
                                    $(tableLayout.fields).each(function (index, tableColumn) {
                                        var $th = $('<th style="padding: 0.1rem; cursor: pointer;">').text(tableColumn.name)
                                        if (tableColumn.field === tableLayout.sort_field) {
                                            if ('asc' === tableLayout.sort_order) {
                                                $th.addClass('headerSortAsc')
                                            } else {
                                                $th.addClass('headerSortDesc')
                                            }
                                        }
                                        $th.click(function (event) {
                                            event.preventDefault();
                                            sortResultTable(tableColumn.field);
                                        });
                                        $tr.append($th)
                                    });    
                                    return $tr;
                                })
                            )
                            .append(function () {
                                if (data.has_more_results) {
                                    return $('<tfoot>')
                                        .append($('<tr>')
                                            .append($('<td>').addClass('text-xs-center').attr('colspan', $(tableLayout.fields).length)
                                                .append($('<a href="#">').text('Show more').click(function (event) {
                                                    event.preventDefault();
                                                    var query = createQuery();
                                                    query.start_ix = tableLayout.current_ix + tableLayout.results_per_page; 
                                                    executeQuery(query, true);
                                                }))
                                            )
                                        )
                                }
                            })
                            .append(function() {
                                var $body = $('<tbody>')
                                $(data.results).each(function (index, searchResult) {
                                    $body.append(function () {
                                        return createResultTableRow(searchResult, data.time_zone);
                                    })
                                });
                                return $body;
                            });
                        $('#result_card').append($('<div>').addClass('table-responsive').append($(resultTable)));
                        if (!isSearchInView($('#result_card'))) {
                            $('html,body').animate({scrollTop: $('#query-string').offset().top},'slow');
                        }
                    }
                    // Update recent queries
                    var query = {
                        types: queryParameters.types,
                        query: queryParameters.query,
                        fields: queryParameters.fieldsLayout,
                        results_per_page: queryParameters.max_results,
                        sort_field: queryParameters.sort_field,
                        sort_order: queryParameters.sort_order                                     
                    }
                    updateHistory(query, data.history_size);
                }
            }
        });    
    }
    
    function createResultTableRow(searchResult, timeZone) {
        var $tr = $('<tr>');
        $(tableLayout.fields).each(function (index, field) {
            var $td = $('<td style="padding: 0.1rem">');
            if (field.link) {
                $td.append(
                    $('<a>')
                        .attr('href', '#')
                        .attr('id', searchResult.id)
                        .text(tableLayout.getValueFromSource(searchResult.source, field, timeZone))
                        .click(function (event) {
                            showEvent(searchResult.type, searchResult.id);
                        })
                )    
            } else {
                $td.text(tableLayout.getValueFromSource(searchResult.source, field, timeZone))
            }
            $tr.append($td);
        });    
        return $tr;
    }
    
    function sortResultTable(fieldName) {
        if (tableLayout.sort_field === fieldName) {
            if (tableLayout.sort_order === 'asc') {
                tableLayout.sort_order = 'desc';
            } else {
                tableLayout.sort_order = 'asc'
            }
        } else {
            tableLayout.sort_field = fieldName;
        }
        tableLayout.current_ix = 0;
        executeQuery(createQuery());
    }
  </script>
  
</body>
</html>
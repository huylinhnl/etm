<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Jecstar - Enterprise Telemetry Monitor</title>

    <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon/favicon-16x16.png">
    <link rel="mask-icon" href="../images/favicon/safari-pinned-tab.svg" color="#5bbad5">

    <link rel="stylesheet" href="../styles/theme.min.css">
    <link rel="stylesheet" href="../styles/font-awesome.min.css">
    <link rel="stylesheet" href="../styles/jquery-ui.min.css">
    <link rel="stylesheet" href="../styles/autocomplete.css">
    <link rel="stylesheet" href="../styles/etm-commons.css">
    <link rel="stylesheet" href="../styles/highlightjs-googlecode.css">
    <link rel="stylesheet" href="../styles/flatpickr.min.css">
    <style type="text/css">
        .headerSortAsc, .headerSortDesc {
            border-bottom-color: #777 !important;
            font-weight: 700 !important;
            white-space: nowrap;
        }

        .headerSortAsc::after, .headerSortDesc::after {
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            content: "";
            display: inline-block;
            height: 0;
            margin-bottom: 2px;
            margin-left: 5px;
            margin-right: -10px;
            width: 0;
        }

        .headerSortDesc::after {
            border-top: 4px solid;
        }

        .headerSortAsc::after {
            border-bottom: 4px solid;
        }

        .event-selected {
            font-weight: bold;
        }
    </style>
    <!-- jQuery first, then Bootstrap JS. -->
    <script src="../scripts/tether.min.js"></script>
    <script src="../scripts/jquery.min.js"></script>
    <script src="../scripts/jquery-ui.min.js"></script>
    <script src="../scripts/popper.min.js"></script>
    <script src="../scripts/bootstrap.min.js"></script>
    <script src="../scripts/flatpickr.min.js"></script>
    <script src="../scripts/d3-format.v1.min.js"></script>
    <script src="../scripts/highcharts/highcharts.js"></script>
    <script src="../scripts/highcharts/xrange.js"></script>
    <script src="../scripts/highcharts/sankey.js"></script>
    <script src="../scripts/highcharts/exporting.js"></script>
    <script src="../scripts/highcharts/offline-exporting.js"></script>
    <script src="../scripts/highcharts/export-data.js"></script>

</head>
<body>
<header class="u-header">
    <div class="u-header-left">
        <a class="u-header-logo" href="https://www.jecstar.com" target="_blank">
            <img class="u-logo-desktop" src="../images/jecstar.svg" style="max-height: 2.1rem; max-width: 2.1rem;"
                 alt="Jecstar website"/>
            <img class="img-fluid u-logo-mobile" src="../images/jecstar.svg"
                 style="max-height: 2.1rem; max-width: 2.1rem;" alt="Jecstar website"/>
        </a>
        <div class="ml-2 mt-1 d-none d-lg-block u-header-brand">
            <h2 class="text-white">Jecstar</h2>
        </div>
    </div>

    <div class="u-header-middle">
        <a class="js-sidebar-invoker u-sidebar-invoker" href="#"
           data-is-close-all-except-this="true"
           data-target="#sidebar">
            <i class="fa fa-bars u-sidebar-invoker__icon--open"></i>
        </a>

        <div class="u-header-search" data-search-mobile-invoker="#headerSearchMobileInvoker"
             data-search-target="#headerSearch">
            <a id="headerSearchMobileInvoker" class="btn btn-link input-group-prepend u-header-search__mobile-invoker"
               href="#">
                <i class="fa fa-search"></i>
            </a>

            <div id="placeholder-for-headerSearch"></div>
        </div>

    </div>

    <div class="u-header-right">
        <div class="ml-2">
            Logged in as: <span class="text-dark d-none d-sm-inline-block">placeholder-for-contextUser</span>
        </div>
    </div>
</header>

<main class="u-main" role="main">
    <aside id="sidebar" class="u-sidebar">
        <div class="u-sidebar-inner">
            <header class="u-sidebar-header">
                <a class="u-sidebar-logo" href="https://www.jecstar.com">
                    <img class="img-fluid" src="../images/jecstar.svg" style="max-height: 2.1rem; max-width: 2.1rem;"
                         alt="Jecstar website">
                </a>
            </header>

            <nav class="u-sidebar-nav">
                <ul class="u-sidebar-nav-menu u-sidebar-nav-menu--top-level">
                    <li id="placeholder-for-MenuAwareURLResource"></li>
                </ul>
            </nav>
        </div>
    </aside>
    <div class="u-content">
        <div id="search-container" class="container-fluid">
            <div class="row">
                <div class="col-md-3 order-md-2 pt-3">
                    <div class="row">
                        <div class="col-md">
                            <div class="card col-md">
                                <div class="card-body">
                                    <h3 class="card-title">Search templates</h3>
                                    <div class="card-text">
                                        <ul id="list-template-links" class="pl-1" style="word-wrap: break-word;"></ul>
                                    </div>
                                    <p id="no-more-tenplates-allowed" style="display: none;">Maximum number of templates
                                        reached!</p>
                                    <div id="template-save-group" class="input-group input-group-sm">
                                        <input id="template-name" type="text" class="form-control form-control-sm"
                                               placeholder="Template name..."
                                               disabled="disabled"/>
                                        <span class="input-group-btn btn-group-sm">
                                        <button id="btn-save-template" class="btn btn-primary btn-sm" type="button"
                                                disabled="disabled">Save</button>
                                    </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row pt-3">
                        <div class="col-md">
                            <div class="card card-block">
                                <div class="card-body">
                                    <h3 class="card-title">Search history</h3>
                                    <div class="card-text">
                                        <ol id="list-search-history-links"
                                            style="padding-left: 1em; word-wrap: break-word;"></ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-9 order-md-1">
                    <div class="row pt-3">
                        <div class="col-md">
                            <div id="search-card" class="card card-block">
                                <div class="card-body">
                                    <h3 class="card-title">Search</h3>
                                    <div class="card-text">
                                        <p>
                                            Please enter your search string in the field below and press the
                                            'Search' button. Specific fields can be searched in the format
                                            <mark>fieldname:&lt;value&gt;</mark>
                                            . For example, if you want to search for all event generated from
                                            application "My Application" the search string will be
                                            <mark>endpoints.writing_endpoint_handler.application.name:"My application"
                                            </mark>
                                            . Multiple field can be combined by using the
                                            <mark>AND</mark>
                                            or
                                            <mark>OR</mark>
                                            operator. Range values can be used by applying the format
                                            <mark>[&lt;start&gt; TO &lt;end&gt;]</mark>
                                            to the field value.
                                        </p>
                                        <div class="alert alert-danger errorBox" style="display: none;"
                                             role="alert"></div>
                                        <div class="custom-control custom-checkbox custom-control-inline">
                                            <input type="checkbox" id="check-type-business" value="business"
                                                   checked="checked"
                                                   class="custom-control-input">
                                            <label class="custom-control-label"
                                                   for="check-type-business">Business</label>
                                        </div>
                                        <div class="custom-control custom-checkbox custom-control-inline">
                                            <input type="checkbox" id="check-type-http" value="http" checked="checked"
                                                   class="custom-control-input">
                                            <label class="custom-control-label" for="check-type-http">Http</label>
                                        </div>
                                        <div class="custom-control custom-checkbox custom-control-inline">
                                            <input type="checkbox" id="check-type-log" value="log" checked="checked"
                                                   class="custom-control-input">
                                            <label class="custom-control-label" for="check-type-log">Log</label>
                                        </div>
                                        <div class="custom-control custom-checkbox custom-control-inline">
                                            <input type="checkbox" id="check-type-messaging" value="messaging"
                                                   checked="checked"
                                                   class="custom-control-input">
                                            <label class="custom-control-label"
                                                   for="check-type-messaging">Messaging</label>
                                        </div>
                                        <div class="custom-control custom-checkbox custom-control-inline">
                                            <input type="checkbox" id="check-type-sql" value="sql" checked="checked"
                                                   class="custom-control-input">
                                            <label class="custom-control-label" for="check-type-sql">SQL</label>
                                        </div>
                                        <div class="row" style="margin-top: 5px;">
                                            <label for="query-string-from" class="col-sm-3 col-form-label-sm">Start
                                                date</label>
                                            <div class="col-sm-3">
                                                <div class="input-group flatpickr">
                                                    <input id="query-string-from" type="text"
                                                           class="form-control form-control-sm" data-input/>
                                                    <div class="input-group-append">
                                                        <a class="btn btn-outline-secondary btn-sm form-control-sm"
                                                           title="Toggle calendar"
                                                           data-toggle>
                                                            <i class="fa fa-calendar"></i>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <label for="query-string-till" class="col-sm-3 col-form-label-sm">End
                                                date</label>
                                            <div class="col-sm-3">
                                                <div class="input-group flatpickr">
                                                    <input id="query-string-till" type="text"
                                                           class="form-control form-control-sm" data-input/>
                                                    <div class="input-group-append">
                                                        <a class="btn btn-outline-secondary btn-sm form-control-sm"
                                                           title="Toggle calendar"
                                                           data-toggle>
                                                            <i class="fa fa-calendar"></i>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row form-group">
                                            <label for="query-string-time-filter-field"
                                                   class="col-sm-3 col-form-label-sm">Time
                                                field</label>
                                            <div class="col-sm-3">
                                                <div class="input-group">
                                                    <input id="query-string-time-filter-field" type="text"
                                                           class="form-control form-control-sm" value="timestamp"/>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row form-group">
                                            <div class="col-sm">
                                                <input id="query-string" type="text" class="form-control"
                                                       placeholder="Search for..."
                                                       autocomplete="off" autofocus="autofocus">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button id="btn-search" class="btn btn-primary" type="button"
                                                    disabled="disabled">
                                                Search
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row pt-3" id="result_block" style="display: none;">
                        <div class="col-md">
                            <div id="search-result-card" class="card card-block">
                                <div class="card-body">
                                    <h3 class="card-title">Search results
                                        <small id="search-stats"></small>
                                        <small style="font-size: 100%;"><a id="link-edit-table" href="#"
                                                                           class="fa fa-edit float-right"
                                                                           title="Edit result table"></a>&nbsp;<a
                                                id="link-request-download" href="#"
                                                class="mr-1 fa fa-download float-right"
                                                title="Download results"></a></small>
                                    </h3>
                                    <div id="result_card" class="card-text">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="event-container" class="container-fluid" style="display: none;">
            <div class="row pt-3">
                <div class="col-md">
                    <div class="card card-block">
                        <div class="card-body">
                            <h3 class="card-title">
                                <a id="link-back-to-results" href="#" class="fa fa-chevron-circle-left"
                                   title="Back to search results"></a>
                                <span id="event-card-title">Event</span>
                            </h3>
                            <div class="card-text">
                                <div class="alert alert-danger errorBox" style="display: none;" role="alert"></div>

                                <div role="tabpanel">
                                    <ul role="tablist" id="event-tabs" class="nav nav-tabs">
                                        <li class="nav-item">
                                            <a id="event-tab-header" data-toggle="tab" href="#event-tab" role="tab"
                                               aria-controls="event-tab" aria-selected="true" class="nav-link active">Event</a>
                                        </li>
                                    </ul>
                                    <div id="tabcontents" class="tab-content">
                                        <div id="event-tab" role="tabpanel" aria-labelledby="event-tab-header"
                                             class="tab-pane fade show active in pt-3">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr/>
                            <div class="text-center">
                                <a id="btn-back-to-results" href="#" class="btn btn-primary">Back</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" id="modal-template-overwrite">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="template-overwrite-modal-label">Template already exists</h2>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                A template with the name '<i id="overwrite-template-name"></i>' already exists. Do you want to overwrite
                that template?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                <button id="btn-overwrite-template" type="button" class="btn btn-primary">Yes</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal-template-remove">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="template-remove-modal-label">Confirm removal</h2>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to remove the template '<i id="remove-template-name"></i>'?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                <button id="btn-remove-template" type="button" class="btn btn-primary">Yes</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal-table-settings">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 60%;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="table-settings-modal-label">Table settings</h2>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group row">
                    <label for="table-settings-sort-field" class="col-sm-3 col-form-label">Sort field</label>
                    <div class="col-sm-9">
                        <input id="table-settings-sort-field" type="text" class="form-control"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="table-settings-sort-order" class="col-sm-3 col-form-label">Sort order</label>
                    <div class="col-sm-9">
                        <select id="table-settings-sort-order" class="form-control custom-select">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="table-settings-results-per-page" class="col-sm-3 col-form-label">Results per
                        page</label>
                    <div class="col-sm-9">
                        <input id="table-settings-results-per-page" type="number" min="1" step="1" max="500"
                               class="form-control"/>
                    </div>
                </div>
                <div class="card card-block">
                    <div class="card-body">
                        <div class="card-title"><h3>Columns</h3></div>
                        <div id="table-settings-columns">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button id="btn-apply-table-settings" type="button" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal-download-results">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="download-results-modal-label">Download results</h2>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Select the options you desire, and click on the link below to download the results.</p>
                <div class="form-group row">
                    <label for="sel-download-include-payload" class="col-sm-3 col-form-label">Include payload</label>
                    <div class="col-sm-9">
                        <select id="sel-download-include-payload" class="form-control custom-select">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="input-download-start-row" class="col-sm-3 col-form-label">Start row</label>
                    <div class="col-sm-9">
                        <!-- disable the field, as scrolling in elasticsearch always starts at ix=0 -->
                        <input id="input-download-start-row" type="number" min="1" class="form-control" value="1"
                               disabled="disabled"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="input-download-number-of-rows" class="col-sm-3 col-form-label">Number of rows</label>
                    <div class="col-sm-9">
                        <input id="input-download-number-of-rows" type="number" min="1" class="form-control"
                               value="10"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="sel-download-type" class="col-sm-3 col-form-label">File type</label>
                    <div class="col-sm-9">
                        <select id="sel-download-type" class="form-control custom-select">
                            <option value="csv">Comma separated file (csv)</option>
                            <option value="xlsx">Microsoft Excel (xlsx)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btn-download-results" type="button" class="btn btn-primary">Download</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal-download-transaction">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="download-transaction-modal-label">Download transaction</h2>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Select the options you desire, and click on the link below to download the results.</p>
                <div class="form-group row">
                    <label for="input-download-transaction-id" class="col-sm-3 col-form-label">Transaction id</label>
                    <div class="col-sm-9">
                        <input id="input-download-transaction-id" type="text" class="form-control" disabled="disabled"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="sel-download-transaction-type" class="col-sm-3 col-form-label">File type</label>
                    <div class="col-sm-9">
                        <select id="sel-download-transaction-type" class="form-control custom-select">
                            <option value="csv">Comma separated file (csv)</option>
                            <option value="xlsx">Microsoft Excel (xlsx)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btn-download-transaction" type="button" class="btn btn-primary">Download</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="../scripts/moment.min.js"></script>
<script src="../scripts/moment-timezone-with-data.min.js"></script>
<script src="../scripts/vkbeautify.js"></script>
<script src="../scripts/clipboard.min.js"></script>
<script src="../scripts/etm-commons.js"></script>

<script>
    commons.addAjaxHandlers(
        null,
        null,
        function (event, jqXHR, settings, thrownError) {
            if ("undefined" != typeof jqXHR.responseJSON) {
                $('.errorBox').text('Error executing query: ' + jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')').show('fast');
            } else {
                $('.errorBox').text('Error executing query: ' + thrownError).show('fast');
            }
            $('html,body').animate({scrollTop: 0}, 'fast');
        },
        null
    );
    let queryKeywords = null;
    $.when(
        $.ajax({
            type: 'GET',
            contentType: 'application/json',
            url: '../rest/search/keywords/etm_event_all',
            cache: false,
            success: function (data) {
                if (!data || !data.keywords) {
                    return;
                }
                queryKeywords = data.keywords;
            }
        })
    ).done(function () {
        // Disable or enable the search button, template name inputfield and save button if the query field contains data.
        $('#query-string').on('input', enableOrDisableSearchButton)
            .bind('keydown', function (event) {
                if (event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete('instance').menu.active) {
                    event.preventDefault();
                } else if (event.keyCode === $.ui.keyCode.DOWN && !$(this).autocomplete('instance').menu.active) {
                    if ($(this).val() === '') {
                        $(this).autocomplete("search", "");
                    }
                } else if (event.keyCode === $.ui.keyCode.ENTER && !$(this).autocomplete('instance').menu.active && $(this).val()) {
                    startNewQuery();
                }
            }).autocompleteFieldQuery(
            {
                queryKeywords: queryKeywords
            }
        );
        $('#query-string-time-filter-field')
            .bind('keydown', function (event) {
                if (event.keyCode === $.ui.keyCode.ESCAPE && $(this).autocomplete('instance').menu.active) {
                    event.stopPropagation();
                }
            }).autocompleteFieldQuery(
            {
                queryKeywords: queryKeywords,
                mode: 'field',
                keywordFilter: function (index, group, keyword) {
                    return !keyword.date;
                }
            }
        );
        $('#table-settings-sort-field').bind('keydown', function (event) {
            if (event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete('instance').menu.active) {
                event.preventDefault();
            } else if (event.keyCode === $.ui.keyCode.DOWN && !$(this).autocomplete('instance').menu.active) {
                if ($(this).val() === '') {
                    $(this).autocomplete("search", "");
                }
            } else if (event.keyCode === $.ui.keyCode.ESCAPE && $(this).autocomplete('instance').menu.active) {
                event.stopPropagation();
            }
        }).autocompleteFieldQuery(
            {
                queryKeywords: queryKeywords,
                mode: 'field'
            });
    });
    const flatPickrStartDate = $('#query-string-from').parent()
        .flatpickr({
            dateFormat: "Y-m-dTH:i:S",
            enableTime: true,
            enableSeconds: true,
            time_24hr: true,
            allowInput: true,
            defaultHour: 0,
            defaultMinute: 0,
            clickOpens: false,
            wrap: true
        });
    const flatPickrEndDate = $('#query-string-till').parent()
        .flatpickr({
            dateFormat: "Y-m-dTH:i:S",
            enableTime: true,
            enableSeconds: true,
            time_24hr: true,
            allowInput: true,
            defaultHour: 23,
            defaultMinute: 59,
            clickOpens: false,
            wrap: true
        });

</script>
<script src="../scripts/autocomplete_fields.js"></script>
<script src="../scripts/searchresults-layout.js"></script>
<script src="../scripts/event-details.js"></script>
<script src="../scripts/search-templates.js"></script>
<script src="../scripts/sidebar-nav.js"></script>
<script>
    let maxDownloads;
    $('[id^=check-type-]').on('change', function () {
        enableOrDisableSearchButton();
        if ($('[id^=check-type-]:checked').length == 0) {
            $('#query-string').attr('disabled', 'disabled');
        } else {
            $('#query-string').removeAttr('disabled');
        }
    });

    $('#btn-search').click(function () {
        startNewQuery();
    });

    $('#link-request-download').on('click', function (event) {
        event.preventDefault();
        $('#modal-download-results').modal();
    });

    $('#btn-download-results').on('click', function (event) {
        event.preventDefault();
        $('#modal-download-results').modal('hide');
        const q = createQuery(true);
        q.start_ix = Number($('#input-download-start-row').val()) - 1;
        q.max_results = Number($('#input-download-number-of-rows').val());
        q.fileType = $('#sel-download-type').val();
        q.includePayload = $('#sel-download-include-payload').val() == 'true' ? true : false;
        window.location.href = '../rest/search/download?q=' + encodeURIComponent(JSON.stringify(q));
    });

    $('#result_card').on('click', '#search_result_table tbody a', function (event) {
        event.preventDefault();
        if ('show-event' === $(this).attr('data-link-type')) {
            showEvent($(window).scrollTop(), $(this).attr('id'));
            $('#search_result_table > tbody > tr.event-selected').removeClass('event-selected');
            $(event.target).parent().parent().addClass('event-selected');
        } else if ('set-as-start-for-query' === $(this).attr('data-link-type')) {
            const value = $(this).parent().children(":first").text();
            $('#query-string-from').val(value);
        } else if ('set-as-end-for-query' === $(this).attr('data-link-type')) {
            const value = $(this).parent().children(":first").text();
            $('#query-string-till').val(value);
        }
    });

    $('#result_card').on('mouseenter mouseleave', '#search_result_table tbody tr td', function () {
        $(this).children("[data-link-type='set-as-start-for-query'], [data-link-type='set-as-end-for-query']").toggleClass('invisible');
    });

    $('#result_card').on('click', '#search_result_table thead th', function (event) {
        event.preventDefault();
        sortResultTable($(this).attr('data-event-field'));
    });

    $('#result_card').on('click', '#search_result_table tfoot a', function (event) {
        event.preventDefault();
        var query = createQuery(true);
        query.start_ix = tableLayout.current_ix + tableLayout.results_per_page;
        executeQuery(query, true);
    });

    $('#event-container').on('click', '#btn-back-to-results, #link-back-to-results', function (event) {
        event.preventDefault();
        $('#event-container').hide();
        $('#search-container').show();
        $('html,body').animate({scrollTop: Number($(this).attr('data-scroll-to'))}, 'fast');
    });

    $('#event-container').on('click', "a[data-link-type='show-event']", function (event) {
        event.preventDefault();
        showEvent(Number($(this).attr('data-scroll-to')), $(this).attr('data-event-id'))
    });

    $('#event-container').on('click', "a[data-link-type='toggle-detail-map']", function (event) {
        event.preventDefault();
        $('#' + $(this).attr('data-panel-id')).collapse('toggle');
    });

    function startNewQuery() {
        tableLayout.timestamp = new Date().getTime();
        const queryParams = createQuery(false);
        queryParams.start_ix = 0;
        executeQuery(queryParams);
    }

    function enableOrDisableSearchButton() {
        if (!$('#query-string').val() || $('[id^=check-type-]:checked').length === 0) {
            $('#btn-search, #template-name, #btn-save-template').attr('disabled', 'disabled');
            $('#link-edit-table, #link-request-download').hide();
        } else {
            $('#btn-search, #template-name').removeAttr("disabled");
            $('#link-edit-table').show();
            if (maxDownloads && maxDownloads > 0) {
                $('#link-request-download').show();
            }
            if ($('#template-name').val()) {
                $('#btn-save-template').removeAttr("disabled");
            }
        }
    }

    function createQuery(reusePreviousQueryString) {
        if (!reusePreviousQueryString) {
            if (!$('#query-string').val() || $('[id^=check-type-]:checked').length === 0) {
                return null;
            }
            tableLayout.current_query = $('#query-string').val();
        } else if (!tableLayout.current_query) {
            return null;
        }
        let dateValue = $('#query-string-from').val();
        if (dateValue) {
            tableLayout.start_time = dateValue;
        } else {
            tableLayout.start_time = null;
        }
        dateValue = $('#query-string-till').val();
        if (dateValue) {
            tableLayout.end_time = dateValue;
        } else {
            tableLayout.end_time = null;
        }
        tableLayout.time_filter_field = $('#query-string-time-filter-field').val() ? $('#query-string-time-filter-field').val() : 'timestamp';
        return {
            query: tableLayout.current_query,
            types: $('[id^=check-type-]:checked').map(function () {
                return $(this).val();
            }).get(),
            fields: tableLayout.getInternalFieldNames(),
            start_ix: tableLayout.current_ix,
            max_results: tableLayout.results_per_page,
            sort_field: tableLayout.sort_field,
            sort_order: tableLayout.sort_order,
            fieldsLayout: tableLayout.fields,
            timestamp: tableLayout.timestamp,
            start_time: tableLayout.start_time,
            end_time: tableLayout.end_time,
            time_filter_field: tableLayout.time_filter_field
        };
    }

    let queryInProgress = false;

    function executeQuery(queryParameters, appendToCurrent) {
        if (!queryParameters || queryInProgress) {
            return;
        }
        queryInProgress = true;
        $('#result_block').show();
        $.ajax({
            type: 'POST',
            contentType: 'application/json',
            url: '../rest/search/query',
            cache: false,
            data: JSON.stringify(queryParameters),
            success: function (data) {
                if (!data) {
                    return;
                }
                maxDownloads = data.max_downloads;
                if (maxDownloads > 0) {
                    $('#link-request-download').show();
                    $('#input-download-number-of-rows').attr('max', maxDownloads);
                }
                if (data.may_see_payload) {
                    $('#sel-download-include-payload').removeAttr('disabled').val('true');
                } else {
                    $('#sel-download-include-payload').attr('disabled', 'disabled').val('false');
                }
                tableLayout.current_ix = data.start_ix;
                if (appendToCurrent) {
                    var endIx = $('#search-stats').text().lastIndexOf(' ');
                    $('#search-stats').text($('#search-stats').text().substring(0, endIx + 1) + (data.end_ix + 1) + '.');
                    var $body = $('#search_result_table > tbody')
                    $(data.results).each(function (index, searchResult) {
                        $body.append(function () {
                            return createResultTableRow(searchResult, data.time_zone);
                        })
                    });
                    if (!data.has_more_results) {
                        $('#search_result_table > tfoot').remove();
                    }
                } else {
                    $('#result_card').empty();
                    if (data.hits === 0) {
                        $('#search-stats').text(':  No results found in ' + data.query_time_as_string + 'ms.');
                        $('#result_card').append($('<p>').text('No results found'));
                    } else {
                        $('#search-stats').text(':  Found ' + data.hits_as_string + ' results in ' + data.query_time_as_string + 'ms. Showing results ' + (data.start_ix + 1) + ' to ' + (data.end_ix + 1) + '.');
                        const resultTable = $('<table id="search_result_table">');
                        $(resultTable)
                            .addClass('table table-hover table-sm')
                            .append($('<thead>')
                                .append(function () {
                                    var $tr = $('<tr>');
                                    $(tableLayout.fields).each(function (index, tableColumn) {
                                        var $th = $('<th style="padding: 0.1rem; cursor: pointer;">').text(tableColumn.name).attr('data-event-field', tableColumn.field)
                                        if (tableColumn.field === tableLayout.sort_field) {
                                            if ('asc' === tableLayout.sort_order) {
                                                $th.addClass('headerSortAsc')
                                            } else {
                                                $th.addClass('headerSortDesc')
                                            }
                                        }
                                        $tr.append($th)
                                    });
                                    return $tr;
                                })
                            )
                            .append(function () {
                                if (data.has_more_results) {
                                    return $('<tfoot>')
                                        .append($('<tr>')
                                            .append($('<td>').addClass('text-center').attr('colspan', $(tableLayout.fields).length)
                                                .append($('<a href="#">').attr('id', 'lnk_show_more').text('Show more'))
                                            )
                                        )
                                }
                            })
                            .append(function () {
                                const $body = $('<tbody>')
                                $(data.results).each(function (index, searchResult) {
                                    $body.append(function () {
                                        return createResultTableRow(searchResult, data.time_zone);
                                    })
                                });
                                return $body;
                            });
                        $('#result_card').append($('<div>').addClass('table-responsive').append($(resultTable)));
                        if (!commons.isInViewport($('#result_card'))) {
                            $('html,body').animate({scrollTop: $('#query-string').offset().top}, 'slow');
                        }
                    }
                    // Update recent queries
                    const query = {
                        types: queryParameters.types,
                        query: queryParameters.query,
                        fields: queryParameters.fieldsLayout,
                        results_per_page: queryParameters.max_results,
                        sort_field: queryParameters.sort_field,
                        sort_order: queryParameters.sort_order,
                        start_time: queryParameters.start_time,
                        end_time: queryParameters.end_time,
                        time_filter_field: queryParameters.time_filter_field
                    };
                    updateHistory(query, data.history_size);
                }
            },
            complete: function () {
                queryInProgress = false;
            }
        });
    }

    function createResultTableRow(searchResult, timeZone) {
        const $tr = $('<tr>');
        $(tableLayout.fields).each(function (index, field) {
            const $td = $('<td style="padding: 0.1rem">');
            if (field.link) {
                $td.append(
                    $('<a>')
                        .attr('href', '?id=' + encodeURIComponent(searchResult.id))
                        .attr('id', searchResult.id)
                        .attr('data-link-type', 'show-event')
                        .text(tableLayout.getValueFromSearchResult(searchResult, field, timeZone))
                );
            } else {
                $td.append($('<span>').text(tableLayout.getValueFromSearchResult(searchResult, field, timeZone)));
            }
            if ('isotimestamp' === field.format || 'isoutctimestamp' === field.format) {
                $td.append(
                    $('<a style="padding-top: 0.2rem">')
                        .addClass('fa fa-hourglass-end float-right invisible')
                        .attr('data-link-type', 'set-as-end-for-query')
                        .attr('title', "Set as 'End date' for query")
                        .attr('href', '#'),
                    $('<a style="padding-top: 0.2rem">')
                        .addClass('fa fa-hourglass-start float-right pr-1 invisible')
                        .attr('data-link-type', 'set-as-start-for-query')
                        .attr('title', "Set as 'Start date' for query")
                        .attr('href', '#')
                );
            }
            $tr.append($td);
        });
        return $tr;
    }

    function sortResultTable(fieldName) {
        if (queryInProgress) {
            return false;
        }
        if (tableLayout.sort_field === fieldName) {
            if (tableLayout.sort_order === 'asc') {
                tableLayout.sort_order = 'desc';
            } else {
                tableLayout.sort_order = 'asc';
            }
        } else {
            tableLayout.sort_field = fieldName;
        }
        tableLayout.current_ix = 0;
        executeQuery(createQuery(true));
        <!-- End User Profile -->
    }

    $(window).scroll(function (event) {
        const $showMoreLink = $('#lnk_show_more');
        if (commons.isInViewport($showMoreLink)) {
            $showMoreLink.click();
        }
    });

    if (commons.queryString['id']) {
        showEvent(null, commons.queryString['id']);
    } else if (commons.queryString['q']) {
        $('#query-string').val(commons.queryString['q']);
        executeQuery(createQuery(false));
    }

</script>

</body>
</html>
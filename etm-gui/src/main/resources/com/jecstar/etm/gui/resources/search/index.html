<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<title>Jecstar - Enterprise Telemetry Monitor</title>

<link rel="stylesheet" href="../styles/bootstrap.min.css">
<link rel="stylesheet" href="../styles/font-awesome.min.css">
<link rel="stylesheet" href="../styles/jquery-ui.min.css">
<link rel="stylesheet" href="../styles/autocomplete.css">
<link rel="stylesheet" href="../styles/spinner.css">
<link rel="stylesheet" href="../styles/highlightjs-googlecode.css">
<style type="text/css">
.headerSortAsc, .headerSortDesc {
    border-bottom-color: #777 !important;
    font-weight: 700 !important;
    white-space: nowrap;
}
.headerSortAsc::after, .headerSortDesc::after {
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    content: "";
    display: inline-block;
    height: 0;
    margin-bottom: 2px;
    margin-left: 5px;
    margin-right: -10px;
    width: 0;
}
.headerSortDesc::after {
    border-top: 4px solid;
}
.headerSortAsc::after {
    border-bottom: 4px solid;
}
.rowContentMargins {
    margin: 0.9375rem 0.9375rem 0rem 0.9375rem;
}
.event-selected {
	font-weight: bold;
}
body { padding-top: 60px; }
</style>
</head>
<body>
  <nav class="navbar fixed-top navbar-toggleable-sm navbar-inverse" style="background-color: #777;">
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#collapsing_navbar" aria-controls="collapsing_navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="https://www.jecstar.com" target="_blank">
      <img src="../images/jecstar.svg" style="max-height: 2.1rem; max-width: 2.1rem;" class="d-inline-block align-top" alt="">
      Jecstar
    </a>
    <div class="collapse navbar-collapse" id="collapsing_navbar">
      <ul id="etm_mainmenu" class="navbar-nav mr-auto">
        <li id="placeholder-for-MenuAwareURLResource"></li>
      </ul>
    </div>
    <div class="spinner" id="spinner" style="display: none;">
      <div class="spinner_line"></div>
      <div class="spinner_line spinner_line_2"></div>
      <div class="spinner_line spinner_line_3"></div>
      <div class="spinner_line spinner_line_4"></div>
    </div>
  </nav>
  
  <div id="search-container" class="container-fluid">
     <div class="row">
       <div class="col-md-3 push-md-9">
         <div class="row">   
           <div class="card card-block rowContentMargins col-md-12">
             <h5 class="card-title">Search templates</h5>
             <div class="card-text">
              <ul id="list-template-links" style="padding-left: 1em; word-wrap: break-word;"></ul>
             </div>
             <p id="no-more-tenplates-allowed" style="display: none;">Maximum number of templates reached!</p>
             <div id="template-save-group" class="input-group input-group-sm">
               <input id="template-name" type="text" class="form-control" placeholder="Template name..." disabled="disabled">
               <span class="input-group-btn">
                 <button id="btn-save-template" class="btn btn-primary" type="button" disabled="disabled">Save</button>
               </span>
             </div>
           </div>
         </div>

         <div class="row">   
           <div class="card card-block rowContentMargins col-md-12">
             <h5 class="card-title">Search history</h5>
             <div class="card-text">
               <ol id="list-search-history-links" style="padding-left: 1em; word-wrap: break-word;"></ol>
             </div>
           </div>
         </div>           
       </div>
       
       <div class="col-md-9 pull-md-3">
         <div class="row">
           <div id="search-card" class="card card-block rowContentMargins col-md-12">
             <h5 class="card-title">Search</h5>
             <div class="card-text">
               <p>
                   Please enter your search string in the field below and press the
                   'Search' button. Specific fields can be searched in the format
                   <mark>fieldname:&lt;value&gt;</mark>
                   . For example, if you want to search for all event generated from
                   application "My Application" the search string will be
                   <mark>endpoints.writing_endpoint_handler.application.name:"My application"</mark>
                   . Multiple field can be combined by using the
                   <mark>AND</mark>
                   or
                   <mark>OR</mark>
                   operator. Range values can be used by applying the format
                   <mark>[&lt;start&gt; TO &lt;end&gt;]</mark>
                   to the field value.
               </p>
               <div class="alert alert-danger errorBox" style="display: none;" role="alert"></div>
               <label class="custom-control custom-checkbox">
                 <input type="checkbox" id="check-type-business" value="business" checked="checked" class="custom-control-input">
                 <span class="custom-control-indicator"></span>
                 <span class="custom-control-description">Business</span>
               </label>
               <label class="custom-control custom-checkbox">
                 <input type="checkbox" id="check-type-http" value="http" checked="checked" class="custom-control-input">
                 <span class="custom-control-indicator"></span>
                 <span class="custom-control-description">Http</span>
               </label>
               <label class="custom-control custom-checkbox">
                 <input type="checkbox" id="check-type-log" value="log" checked="checked" class="custom-control-input">
                 <span class="custom-control-indicator"></span>
                 <span class="custom-control-description">Log</span>
               </label>                 
               <label class="custom-control custom-checkbox">
                 <input type="checkbox" id="check-type-messaging" value="messaging" checked="checked" class="custom-control-input">
                 <span class="custom-control-indicator"></span>
                 <span class="custom-control-description">Messaging</span>
               </label>                 
               <label class="custom-control custom-checkbox">
                 <input type="checkbox" id="check-type-sql" value="sql" checked="checked" class="custom-control-input">
                 <span class="custom-control-indicator"></span>
                 <span class="custom-control-description">SQL</span>
               </label>                 
               <div class="input-group">
                 <input id="query-string" type="text" class="form-control" placeholder="Search for..." autocomplete="off" autofocus="autofocus">
                 <span class="input-group-btn">
                   <button id="btn-search" class="btn btn-primary" type="button" disabled="disabled">Search</button>
                 </span>
               </div>
             </div>
           </div>
         </div>
         <div class="row" id="result_block" style="display: none;">
           <div id="search-result-card" class="card card-block rowContentMargins col-md-12">
             <h5 class="card-title">Search results<small id="search-stats"></small><small style="font-size: 100%;"><a id="link-edit-table" href="#" class="fa fa-pencil-square-o pull-right" title="Edit result table"></a><a id="link-request-download" href="#" class="fa fa-download pull-right" title="Download results"></a></small></h5>
             <div id="result_card" class="card-text">
             </div>
           </div>
         </div>
       </div>
     </div>
  </div>
  
  <div id="event-container" class="container-fluid" style="display: none;">
    <div class="row">
      <div class="card card-block rowContentMargins">
        <h5 class="card-title"><span id="event-card-title">Event</span><small><a id="link-back-to-results" href="#" class="pull-right">Back</a></small></h5>
        <div class="card-text">
          <div class="alert alert-danger errorBox" style="display: none;" role="alert"></div>
    
          <div role="tabpanel">
            <ul role="tablist" id="event-tabs" class="nav nav-tabs">
              <li class="nav-item">
                <a id="event-tab-header" aria-expanded="true" role="tab" href="#event-tab" data-toggle="tab" class="nav-link active">Event</a>
              </li>
            </ul>
            <div id="tabcontents" class="tab-content">
              <div id="event-tab" aria-labelledby="event-tab-header" role="tabpanel" aria-expanded="true" class="tab-pane fade active in show">
              </div>
            </div>
          </div>
        </div>
        <hr />
        <div class="text-center">
          <a id="btn-back-to-results" href="#" class="btn btn-primary">Back</a>
        </div>
      </div>
    </div> 
  </div>
  
  <div class="modal fade" id="modal-template-overwrite" tabindex="-1" role="dialog" aria-labelledby="template-overwrite-modal-label" aria-hidden="true">
     <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
           <h4 class="modal-title" id="template-overwrite-modal-label">Template already exists</h4>
         </div>
         <div class="modal-body">
          A template with the name '<i id="overwrite-template-name"></i>' already exists. Do you want to overwrite that template?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button id="btn-overwrite-template" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modal-template-remove" tabindex="-1" role="dialog" aria-labelledby="template-remove-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="template-remove-modal-label">Confirm removal</h4>
        </div>
        <div class="modal-body">
          Are you sure you want to remove the template '<i id="remove-template-name"></i>'?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button id="btn-remove-template" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modal-table-settings" tabindex="-1" role="dialog" aria-labelledby="table-settings-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="table-settings-modal-label">Table settings</h4>
        </div>
        <div class="modal-body">
            <div class="form-group row">
              <label for="table-settings-sort-field" class="col-sm-3 col-form-label">Sort field</label>
              <div class="col-sm-9">
                <input id="table-settings-sort-field" type="text" class="form-control" />
              </div>
            </div>
            <div class="form-group row">
              <label for="table-settings-sort-order" class="col-sm-3 col-form-label">Sort order</label>
              <div class="col-sm-9">
                <select id="table-settings-sort-order" class="form-control custom-select" >
                  <option value="asc">Ascending</option>
                  <option value="desc">Descending</option>
                </select>
              </div>  
            </div>
            <div class="form-group row">
              <label for="table-settings-results-per-page" class="col-sm-3 col-form-label">Results per page</label>
              <div class="col-sm-9">
                <input id="table-settings-results-per-page" type="number" min="1" step="1" max="500" class="form-control" />
              </div>
            </div>
            <div class="card card-block">
                <div class="card-title"><h5>Columns</h5></div>
                <div id="table-settings-columns">
                </div>
            </div>    
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button id="btn-apply-table-settings" type="button" class="btn btn-primary">Apply</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modal-download-results" tabindex="-1" role="dialog" aria-labelledby="download-results-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="download-results-modal-label">Download results</h4>
        </div>
        <div class="modal-body">
          <p>Select the options you desire, and click on the link below to download the results.</p> 
          <div class="form-group row">
            <label for="sel-download-include-payload" class="col-sm-3 col-form-label">Include payload</label>
            <div class="col-sm-9">
              <select id="sel-download-include-payload" class="form-control custom-select">
	            <option value="true">Yes</option>
	            <option value="false">No</option>
              </select>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-download-start-row" class="col-sm-3 col-form-label">Start row</label>
            <div class="col-sm-9">
              <!-- disable the field, as scrolling in elasticsearch always starts at ix=0 -->
              <input id="input-download-start-row" type="number" min="1" class="form-control" value="1" disabled="disabled"/>
            </div>
          </div>
          <div class="form-group row">
            <label for="input-download-number-of-rows" class="col-sm-3 col-form-label">Number of rows</label>
            <div class="col-sm-9">
              <input id="input-download-number-of-rows" type="number" min="1" class="form-control" value="10" />
            </div>
          </div>
          <div class="form-group row">
            <label for="sel-download-type" class="col-sm-3 col-form-label">File type</label>
            <div class="col-sm-9">
              <select id="sel-download-type" class="form-control custom-select">
            	<option value="csv">Comma separated file (csv)</option>
            	<option value="xlsx">Microsoft Excel (xlsx)</option>
              </select>
            </div>  
          </div>
          <div class="modal-footer">
            <button id="btn-download-results" type="button" class="btn btn-primary">Download</button>
          </div>          
        </div>
      </div>
    </div>
  </div>
  
  <!-- jQuery first, then Bootstrap JS. -->
  <script src="../scripts/tether.min.js"></script>
  <script src="../scripts/jquery.min.js"></script>
  <script src="../scripts/jquery-ui.min.js"></script>
  <script src="../scripts/bootstrap.min.js"></script>
  <script src="../scripts/moment.min.js"></script>
  <script src="../scripts/moment-timezone-with-data.min.js"></script>
  <script src="../scripts/cytoscape.min.js"></script>
  <script src="../scripts/dagre.min.js"></script>
  <script src="../scripts/cytoscape-dagre.js"></script>  
  <script src="../scripts/vkbeautify.js"></script>
  <script src="../scripts/clipboard.min.js"></script>
  
  <script>
    $(document).ajaxStart(function () {
        $('.errorBox').hide('fast');
        $('#spinner').show('fast');
    }).ajaxStop(function () {
        $('#spinner').hide('fast');
    }).ajaxError(function(event, jqXHR, settings, thrownError) {
        if ("undefined" != typeof jqXHR.responseJSON) {
            $('.errorBox').text('Error executing query: ' +  jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')').show('fast');
        } else {
            $('.errorBox').text('Error executing query: ' +  thrownError).show('fast');
        }
        $('html,body').animate({scrollTop: 0},'fast');
    }).ajaxComplete(function(event, jqXHR, settings) {
        var contentType = jqXHR.getResponseHeader("Content-Type");
        if (jqXHR.status === 200 && contentType.toLowerCase().indexOf("text/html") >= 0) {
            // assume that our login has expired - reload our current page
            window.location.reload();
            return;
        }          
    });
    var queryKeywords = null;
    $.ajax({
        type: 'GET',
        async: false,
        contentType: 'application/json',
        url: '../rest/search/keywords/etm_event_all',
        success: function(data) {
            if (!data || !data.keywords) {
                return;
            }
            queryKeywords = data.keywords;
        }
    });
    
  </script>
  <script src="../scripts/autocomplete_fields.js"></script>
  <script src="../scripts/searchresults-layout.js"></script>
  <script src="../scripts/event-details.js"></script>
  <script src="../scripts/search-templates.js"></script>
  <script>
    var maxDownloads;
    $('[id^=check-type-]').on('change', function() {
        enableOrDisableSearchButton();
        if ($('[id^=check-type-]:checked').length == 0) {
            $('#query-string').attr('disabled', 'disabled');
        } else {
            $('#query-string').removeAttr('disabled');
        }
    });
    // Disable or enable the search button, template name inputfield and save button if the query field contains data.
    $('#query-string').on('input', enableOrDisableSearchButton)
    .bind('keydown', function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete('instance').menu.active ) {
            event.preventDefault();
        } else if ( event.keyCode === $.ui.keyCode.DOWN && !$(this).autocomplete('instance').menu.active) {
            if ($(this).val() === '') {
                $(this).autocomplete( "search", "" );
            }
        } else if ( event.keyCode === $.ui.keyCode.ENTER && !$(this).autocomplete('instance').menu.active && $(this).val()) {
			startNewQuery();
        }
    }).autocompleteFieldQuery(
    		{
    			queryKeywords: queryKeywords, 
    			keywordGroupFilter: function(index, group) {
    				return $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get().indexOf(group) == -1;
    		    }
    		}
    );
    
    $('#btn-search').click(function() {
    	startNewQuery();
    });
    
    $('#link-request-download').click(function(event) {
    	event.preventDefault();
    	$('#modal-download-results').modal();
    });
    
    $('#btn-download-results').click(function(event) {
    	event.preventDefault();
    	$('#modal-download-results').modal('hide');
    	var q = createQuery(true);
    	q.start_ix = Number($('#input-download-start-row').val()) - 1;
    	q.max_results = Number($('#input-download-number-of-rows').val());
    	q.fileType = $('#sel-download-type').val();
    	q.includePayload = $('#sel-download-include-payload').val() == 'true' ? true : false;
	    window.location.href = '../rest/search/download?q=' + encodeURIComponent(JSON.stringify(q));
	});

    $('#result_card').on('click', '#search_result_table tbody a', function(event) {
    	event.preventDefault();
        showEvent($(window).scrollTop(), $(this).attr('data-event-type'), $(this).attr('id'));
        $('#search_result_table > tbody > tr.event-selected').removeClass('event-selected');
   	    $(event.target).parent().parent().addClass('event-selected');
    });
    
    $('#result_card').on('click', '#search_result_table thead th', function(event) {
    	event.preventDefault();
        sortResultTable($(this).attr('data-event-field'));
    });
    
    $('#result_card').on('click', '#search_result_table tfoot a', function(event) {
        event.preventDefault();
        var query = createQuery(true);
        query.start_ix = tableLayout.current_ix + tableLayout.results_per_page; 
        executeQuery(query, true);
    });

    $('#event-container').on('click', '#btn-back-to-results, #link-back-to-results', function(event) {
		event.preventDefault();
		$('#event-container').hide();
		$('#search-container').show();
		$('html,body').animate({scrollTop: Number($(this).attr('data-scroll-to'))},'fast');
    });
    
    $('#event-container').on('click', "a[data-link-type='show-event']", function(event) {
    	showEvent(Number($(this).attr('data-scroll-to')), $(this).attr('data-event-type'), $(this).attr('data-event-id'))
    });
    
    $('#event-container').on('click', "a[data-link-type='toggle-detail-map']", function(event) {
    	event.preventDefault();
    	$('#' + $(this).attr('data-panel-id')).collapse('toggle');
    });
    
    function startNewQuery() {
    	tableLayout.timestamp = new Date().getTime();
    	var queryParams = createQuery(false);
    	queryParams.start_ix = 0;
        executeQuery(queryParams);
    }
    
    function isInViewport(elem) {
    	if (!$(elem).is(':visible')) {
    		return false;
    	}
        var docViewTop = $(window).scrollTop();
        var docViewBottom = docViewTop + $(window).height();
        var elemTop = $(elem).offset().top;
        var elemBottom = elemTop + $(elem).height();
        return docViewBottom > elemTop;
    }
    
    function enableOrDisableSearchButton() {
        if (!$('#query-string').val() || $('[id^=check-type-]:checked').length == 0) {
            $('#btn-search, #template-name, #btn-save-template').attr('disabled', 'disabled');
            $('#link-edit-table, #link-request-download').hide();
        } else {
            $('#btn-search, #template-name').removeAttr("disabled");
            $('#link-edit-table').show();
            if (maxDownloads && maxDownloads > 0) {
            	$('#link-request-download').show();
            }
            if ($('#template-name').val()) {
                $('#btn-save-template').removeAttr("disabled");
            }
        }
    }
    
    function createQuery(reusePreviousQueryString) {
    	if (!reusePreviousQueryString) {
    		if (!$('#query-string').val() || $('[id^=check-type-]:checked').length == 0) {
            	return null;
            }
        	tableLayout.current_query = $('#query-string').val();
        } else if (!tableLayout.current_query) {
        	return null;
        }
        var query = { 
            query: tableLayout.current_query,
            types: $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get(),
            fields: tableLayout.getInternalFieldNames(),
            start_ix: tableLayout.current_ix,
            max_results: tableLayout.results_per_page,
            sort_field: tableLayout.sort_field,
            sort_order: tableLayout.sort_order,
            fieldsLayout: tableLayout.fields,
            timestamp: tableLayout.timestamp
        };
        return query;
    }
    
    var queryInProgress = false;
    function executeQuery(queryParameters, appendToCurrent) {
        if (!queryParameters || queryInProgress) {
            return;
        }
        queryInProgress = true;
        $('#result_block').show();
        $.ajax({
            type: 'POST',
            contentType: 'application/json',
            url: '../rest/search/query',
            data: JSON.stringify(queryParameters),
            success: function(data) {
                if (!data) {
                    return;
                }
                maxDownloads = data.max_downloads;
                if (maxDownloads > 0) {
                	$('#link-request-download').show();
                	$('#input-download-number-of-rows').attr('max', maxDownloads);
                }
                tableLayout.current_ix = data.start_ix;
                if (appendToCurrent) {
                    var endIx = $('#search-stats').text().lastIndexOf(' ');
                    $('#search-stats').text($('#search-stats').text().substring(0, endIx + 1) + (data.end_ix + 1) + '.');
                    var $body = $('#search_result_table > tbody')
                    $(data.results).each(function (index, searchResult) {
                        $body.append(function () {
                            return createResultTableRow(searchResult, data.time_zone);
                        })
                    });
                    if (!data.has_more_results) {
                        var $body = $('#search_result_table > tfoot').remove();    
                    }
                } else {
                    $('#result_card').empty();
                    if (data.hits === 0) {
                        $('#search-stats').text(':  No results found in ' + data.query_time_as_string + 'ms.');
                        $('#result_card').append($('<p>').text('No results found'));
                    } else {
                        $('#search-stats').text(':  Found ' + data.hits_as_string + ' results in ' + data.query_time_as_string + 'ms. Showing results ' + (data.start_ix + 1) + ' to ' + (data.end_ix + 1) + '.');
                        var resultTable = $('<table id="search_result_table">');
                        $(resultTable)
                            .addClass('table table-hover table-sm')
                            .append($('<thead>')
                                .append(function () {
                                    var $tr = $('<tr>');
                                    $(tableLayout.fields).each(function (index, tableColumn) {
                                        var $th = $('<th style="padding: 0.1rem; cursor: pointer;">').text(tableColumn.name).attr('data-event-field', tableColumn.field)
                                        if (tableColumn.field === tableLayout.sort_field) {
                                            if ('asc' === tableLayout.sort_order) {
                                                $th.addClass('headerSortAsc')
                                            } else {
                                                $th.addClass('headerSortDesc')
                                            }
                                        }
                                        $tr.append($th)
                                    });    
                                    return $tr;
                                })
                            )
                            .append(function () {
                                if (data.has_more_results) {
                                    return $('<tfoot>')
                                        .append($('<tr>')
                                            .append($('<td>').addClass('text-center').attr('colspan', $(tableLayout.fields).length)
                                                .append($('<a href="#">').attr('id', 'lnk_show_more').text('Show more'))
                                            )
                                        )
                                }
                            })
                            .append(function() {
                                var $body = $('<tbody>')
                                $(data.results).each(function (index, searchResult) {
                                    $body.append(function () {
                                        return createResultTableRow(searchResult, data.time_zone);
                                    })
                                });
                                return $body;
                            });
                        $('#result_card').append($('<div>').addClass('table-responsive').append($(resultTable)));
                        if (!isInViewport($('#result_card'))) {
                            $('html,body').animate({scrollTop: $('#query-string').offset().top},'slow');
                        }
                    }
                    // Update recent queries
                    var query = {
                        types: queryParameters.types,
                        query: queryParameters.query,
                        fields: queryParameters.fieldsLayout,
                        results_per_page: queryParameters.max_results,
                        sort_field: queryParameters.sort_field,
                        sort_order: queryParameters.sort_order                                     
                    }
                    updateHistory(query, data.history_size);
                }
            },
            complete: function () {
            	queryInProgress = false;
            }
        });    
    }
    
    function createResultTableRow(searchResult, timeZone) {
        var $tr = $('<tr>');
        $(tableLayout.fields).each(function (index, field) {
            var $td = $('<td style="padding: 0.1rem">');
            if (field.link) {
                $td.append(
                    $('<a>')
                        .attr('href', '?id=' + encodeURIComponent(searchResult.id) + '&type=' + encodeURIComponent(searchResult.type))
                        .attr('id', searchResult.id)
                        .attr('data-event-type', searchResult.type)
                        .text(tableLayout.getValueFromSearchResult(searchResult, field, timeZone))
                )    
            } else {
                $td.text(tableLayout.getValueFromSearchResult(searchResult, field, timeZone))
            }
            $tr.append($td);
        });    
        return $tr;
    }
    
    function sortResultTable(fieldName) {
    	if (queryInProgress) {
    		return false;
    	}
        if (tableLayout.sort_field === fieldName) {
            if (tableLayout.sort_order === 'asc') {
                tableLayout.sort_order = 'desc';
            } else {
                tableLayout.sort_order = 'asc';
            }
        } else {
            tableLayout.sort_field = fieldName;
        }
        tableLayout.current_ix = 0;
        executeQuery(createQuery(true));
    }

	$(window).scroll(function(event) {
		var $showMoreLink = $('#lnk_show_more');
		if (isInViewport($showMoreLink)) {
			$showMoreLink.click();
		}
	});

    var queryString = (function(a) {
        if (a == "") return {};
        var b = {};
        for (var i = 0; i < a.length; ++i) {
            var p=a[i].split('=', 2);
            if (p.length == 1) {
                b[p[0]] = "";
            } else {
                b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
            }
        }
        return b;
    })(window.location.search.substr(1).split('&'));
    if (queryString['id'] && queryString['type']) {
        showEvent(null, queryString['type'], queryString['id']);
    }

  </script>
  
</body>
</html>
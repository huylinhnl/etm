<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<link rel="stylesheet" href="../styles/bootstrap-4.0.0_alpha2.min.css">
<link rel="stylesheet" href="../styles/font-awesome-4.5.0.min.css">
<link rel="stylesheet" href="../styles/jquery-ui-1.11.4.min.css">
<link rel="stylesheet" href="../styles/autocomplete.css">
<link rel="stylesheet" href="../styles/spinner.css">
<style type="text/css">
.headerSortAsc, .headerSortDesc {
    border-bottom-color: #777 !important;
    font-weight: 700 !important;
    white-space: nowrap;
}
.headerSortAsc::after, .headerSortDesc::after {
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    content: "";
    display: inline-block;
    height: 0;
    margin-bottom: 2px;
    margin-left: 5px;
    margin-right: -10px;
    width: 0;
}
.headerSortDesc::after {
    border-top: 4px solid;
}
.headerSortAsc::after {
    border-bottom: 4px solid;
}
</style>
</head>
<body>
   <nav class="navbar navbar-full navbar-dark" style="background-color: #777;">
     <div class="navbar-header">
        <button class="navbar-toggler hidden-sm-up" type="button" data-toggle="collapse" data-target="#exCollapsingNavbar2">
          &#9776;
        </button>
        <div class="pull-left">
         <!-- This needs to be on 1 line because otherwise the menu will be screwed in konqueror and android browsers -->
         <img src="../images/jecstar.svg" style="max-height: 2em; max-width: 2em;" />&nbsp;<a class="navbar-brand pull-right" href="http://www.jecstar.com">Jecstar</a>
      </div>
      <div class="collapse navbar-toggleable-xs" id="exCollapsingNavbar2">
        <ul class="nav navbar-nav">
          <li class="nav-item active">
            <a class="nav-link" href="../search/"><span class="fa fa-search fa-lg hidden-sm-down">&nbsp;</span>Search</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../dashboard"><span class="fa fa-dashboard fa-lg hidden-sm-down">&nbsp;</span>Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#"><span class="fa fa-user fa-lg hidden-sm-down">&nbsp;</span>Preferences</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#"><span class="fa fa-wrench fa-lg hidden-sm-down">&nbsp;</span>Settings</a>
          </li>
        </ul>
      </div>
      <div id="spinner" class="pull-right" style="display: none;">
        <div class="spinner_line"></div>
        <div class="spinner_line spinner_line_2"></div>
        <div class="spinner_line spinner_line_3"></div>
        <div class="spinner_line spinner_line_4"></div>
      </div>
    </div>
  </nav>
  
  <div class="container-fluid" style="margin-left: 1em; margin-top: 1em;">
     <div class="row">
       <div class="col-md-3 col-md-push-9">
         <div class="card card-block">
           <h5 class="card-title">Templates</h5>
           <div id="search_templates" class="card-text">
            <ul id="list-template-links" style="padding-left: 1em;"></ul>
           </div>
           <div class="input-group input-group-sm">
             <input id="template-name" type="text" class="form-control" placeholder="Template name..." disabled="disabled">
             <span class="input-group-btn">
               <button id="btn-save-template"class="btn btn-primary" type="button" disabled="disabled">Save</button>
             </span>
           </div>
         </div>
       </div>
       
       <div class="col-md-9 col-md-pull-3">
         <div class="row">
           <div id="search-card" class="card card-block">
             <h5 class="card-title">Search</h5>
             <div class="card-text">
               <p>
                   Please enter your search string in the field below and press the
                   'Search' button. Specific fields can be searched in the format
                   <mark>fieldname:&lt;value&gt;</mark>
                   . For example, if you want to search for all event generated from
                   application "My Application" the search string will be
                   <mark>endpoints.writing_endpoint_handler.application.name:"My application"</mark>
                   . Multiple field can be combined by using the
                   <mark>AND</mark>
                   or
                   <mark>OR</mark>
                   operator. Range values can be used by applying the format
                   <mark>[&lt;start&gt; TO &lt;end&gt;]</mark>
                   to the field value.
               </p>
               <div id="errorBox" class="alert alert-danger" style="display: none;" role="alert"></div>
               <label class="checkbox-inline">
                 <input type="checkbox" id="check-type-business" value="business" checked="checked"> Business
               </label>
               <label class="checkbox-inline">
                 <input type="checkbox" id="check-type-http" value="http" checked="checked"> Http
               </label>
               <label class="checkbox-inline">
                 <input type="checkbox" id="check-type-log" value="log" checked="checked"> Log
               </label>                 
               <label class="checkbox-inline">
                 <input type="checkbox" id="check-type-messaging" value="messaging" checked="checked"> Messaging
               </label>                 
               <label class="checkbox-inline">
                 <input type="checkbox" id="check-type-sql" value="sql" checked="checked"> SQL
               </label>                 
               <div class="input-group">
                 <input id="query-string" type="text" class="form-control" placeholder="Search for..." autofocus autocomplete="off">
                 <span class="input-group-btn">
                   <button id="btn-search" class="btn btn-primary" type="button" disabled="disabled">Search</button>
                 </span>
               </div>
             </div>
           </div>
         </div>
         <div class="row" id="result_block" style="display: none">
           <div id="search-result-card" class="card card-block">
             <h5 class="card-title">Search results<small id="search-stats"></small><small style="font-size: 100%;"><a id="link-edit-table" href="#" class="fa fa-pencil-square-o pull-right"></a></small></h5>
             <div id="result_card" class="card-text">
             </div>
           </div>
         </div>
       </div>
     </div>
  </div>
  
  <div class="modal fade" id="modal-template-overwrite" tabindex="-1" role="dialog" aria-labelledby="template-overwrite-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="template-overwrite-modal-label">Name already exists</h4>
        </div>
        <div class="modal-body">
          A template with the name '<i id="overwrite-template-name"></i>' already exists. Do you want to overwrite that template?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button id="btn-overwrite-template" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modal-template-remove" tabindex="-1" role="dialog" aria-labelledby="template-remove-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="template-remove-modal-label">Confirm removal</h4>
        </div>
        <div class="modal-body">
          Are you sure you want to remove the template '<i id="remove-template-name"></i>' ?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button id="btn-remove-template" type="button" class="btn btn-primary">Yes</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="modal-table-settings" tabindex="-1" role="dialog" aria-labelledby="table-settings-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="table-settings-modal-label">Table settings</h4>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="table-settings-sort-field">Sort field</label>
                <input id="table-settings-sort-field" type="text" class="form-control" />
            </div>
            <div class="form-group">
                <label for="table-settings-sort-order">Sort order</label>
                <select id="table-settings-sort-order" class="form-control" >
                  <option value="asc">Ascending</option>
                  <option value="desc">Descending</option>
                </select>
            </div>
            <div class="card card-block">
                <div class="card-title"><h5>Columns</h5></div>
                <div id="table-settings-columns">
                </div>
            </div>    
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button id="btn-apply-table-settings" type="button" class="btn btn-primary">Apply</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- jQuery first, then Bootstrap JS. -->
  <script src="../scripts/jquery-2.2.2.min.js"></script>
  <script src="../scripts/jquery-ui-1.11.4.min.js"></script>
  <script src="../scripts/bootstrap-4.0.0_alpha2.min.js"></script>
  <script src="../scripts/moment-2.12.0.min.js"></script>
  <script src="../scripts/moment-timezone-with-data-2010-2020.min.js"></script>
  <script src="../scripts/autocomplete_fields.js"></script>
  
  <script>
    var queryKeywords = null;
    $.ajax({
        type: 'GET',
        async: false,
        contentType: 'application/json',
        url: '../rest/search/keywords/etm_event_all',
        success: function(data) {
            if (!data || !data.keywords) {
                return;
            }
            queryKeywords = data.keywords;
        }
    });
    
    var tableLayout = {
        fields: [
            {name: 'Timestamp', field: 'endpoints.writing_endpoint_handler.handling_time', format: 'isodate', array: 'lowest', link: true }, 
            {name: 'Name', field: 'name', format: 'plain', array: 'first', link: false}
        ],
        sort_field: 'endpoints.writing_endpoint_handler.handling_time',
        sort_order: 'desc',
        getFieldNames: function () {
            return this.fields.map(function(item, index) {
                return item.name;
            })
        },
        getInternalFieldNames: function () {
            return this.fields.map(function(item, index) {
                return item.field;
            })
        },
        getValueFromSource: function(source, tableColumn, timeZone) {
            var fieldParts = tableColumn.field.split("\.");
            var values = [];
            var result = '';
            tableLayout.retrieveValuesFromSource(source, fieldParts, values);
            if (values.length == 0) {
                result = ''
            } else if (values.length == 1) {
                result = tableLayout.formatValue(values[0], tableColumn, timeZone);
            }
            if ('first' === (tableColumn.array)) {
                result = tableLayout.formatValue(values[0], tableColumn, timeZone);
            } else if ('last' === (tableColumn.array)) {
                result = tableLayout.formatValue(values[values.length -1], tableColumn, timeZone);
            } else if ('lowest' === (tableColumn.array)) {
                result = tableLayout.formatValue(values.sort()[0], tableColumn, timeZone);
            } else if ('highest' === (tableColumn.array)) {
                result = tableLayout.formatValue(values.sort()[values.length -1], tableColumn, timeZone);
            } else {
                result = tableLayout.formatValue(values[0], tableColumn, timeZone);
            }
            if (result.trim().length == 0 && tableColumn.link) {
                result = '?';
            }
            return result;
        },
        retrieveValuesFromSource: function(source, fields, values) {
            var currentObject = source;
            $(fields).each(function (index, fieldName) {
                var container = currentObject[fieldName];
                if (container) {
                    if (tableLayout.isArray(container)) {
                        $(container).each(function (i,v){
                            tableLayout.retrieveValuesFromSource(v, fields.slice(index + 1), values);
                        });
                    } else {
                        currentObject = container;
                        if (index + 1 == fields.length) {
                            values.push(container);
                        }
                    }
                } else {
                    return true;
                }
            });
        },
        formatValue: function(value, tableColumn, timeZone) {
            if ('plain' === (tableColumn.format)) {
                return value;
            } else if ('isoutcdate' === tableColumn.format) {
                if (value) {
                    return new Date(value).toISOString();
                } else {
                    return ''; 
                }
            } else if ('isodate' === tableColumn.format) {
                if (value) {
                    return moment.tz(value, timeZone).format();
                } else {
                    return ''; 
                }
            }
            return value;
        },
        isArray: function(fieldToTest) {
            return Object.prototype.toString.call(fieldToTest) === '[object Array]';
        },
        
    }
    
    $(document).ajaxStart(function () {
        $("#errorBox").hide('fast');
        $('#spinner').fadeIn(250);
    }).ajaxStop(function () {
        $('#spinner').fadeOut(500);
    }).ajaxError(function(event, jqXHR, settings, thrownError) {
        $("#errorBox").text('Error executing query: ' +  jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')');
        $("#errorBox").show('fast');
    });
  
    $('[id^=check-type-]').on('change', function() {
        enableOrDisableSearchButton();
        if ($('[id^=check-type-]:checked').size() == 0) {
            $('#query-string').attr('disabled', 'disabled');
        } else {
            $('#query-string').removeAttr('disabled');
        }
    });
    
    // Disable or enable the search button, template name inputfield and save button if the query field contains data.
    $('#query-string').on('input', enableOrDisableSearchButton)
    .bind('keydown', function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete('instance').menu.active ) {
            event.preventDefault();
        } else if ( event.keyCode === $.ui.keyCode.DOWN && !$(this).autocomplete('instance').menu.active) {
            if ($(this).val() === '') {
                $(this).autocomplete( "search", "" );
            }
        } else if ( event.keyCode === $.ui.keyCode.ENTER && !$(this).autocomplete('instance').menu.active && $(this).val()) {
            executeQuery(createQuery());
        }
    }).autocompleteFieldQuery({queryKeywords: queryKeywords});
    
    $('#table-settings-sort-field').bind('keydown', function( event ) {
        if (event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete('instance').menu.active) {
            event.preventDefault();
        } else if ( event.keyCode === $.ui.keyCode.DOWN && !$(this).autocomplete('instance').menu.active) {
            if ($(this).val() === '') {
                $(this).autocomplete( "search", "" );
            }
        } else if (event.keyCode === $.ui.keyCode.ESCAPE && $(this).autocomplete('instance').menu.active) {
            event.stopPropagation();
        }
    }).autocompleteFieldQuery({queryKeywords: queryKeywords, mode: 'field'});
    
    
    $('#btn-search').click(function() {
        executeQuery(createQuery());
    });
    
    $('#template-name').on('input', function() {
        if (!$(this).val()) {
            $('#btn-save-template').attr('disabled', 'disabled');
        } else {
            $('#btn-save-template').removeAttr('disabled');
        }
    });

    $('#btn-save-template').click(function() {
        var template = createTemplate();
        var current = $('#list-template-links > li > a').filter(function() {
            return $(this).text() === template.name;
        }).toArray();
        if (current.length != 0) {
            $('#overwrite-template-name').text(template.name);
            $('#modal-template-overwrite').modal();
        } else {
            storeTemplate(template, false);
        }
    });

    $('#btn-overwrite-template').click(function() {
        $('#modal-template-overwrite').modal('hide');
        storeTemplate(createTemplate(), true);
    });
    
    $('#btn-remove-template').click(function(event) {
        event.preventDefault();
        var templateName = $('#remove-template-name').text();
        $.ajax({
            type: 'DELETE',
            contentType: 'application/json',
            url: '../rest/search/templates/' + encodeURIComponent(templateName),
            success: function() {
                $('#list-template-links > li > a').filter(function() {
                        return $(this).text() === templateName;
                    }).parent().remove();
            }
        });        
        $('#modal-template-remove').modal('hide');
    });
    
    $('#link-edit-table').click(function (event) {
        event.preventDefault();
        $('#table-settings-sort-field').val(tableLayout.sort_field);
        $('#table-settings-sort-order').val(tableLayout.sort_order);
        $('#table-settings-columns').empty();
        $('#table-settings-columns').append(
            $('<div>').addClass('row').append(
                $('<div>').addClass('col-sm-2 font-weight-bold').text('Name'),    
                $('<div>').addClass('col-sm-3 font-weight-bold').text('Field'),    
                $('<div>').addClass('col-sm-2 font-weight-bold').text('Format'),    
                $('<div>').addClass('col-sm-2 font-weight-bold').text('Multiselect'),
                $('<div>').addClass('col-sm-1 font-weight-bold').text('Link'),
                $('<div>').addClass('col-sm-2 font-weight-bold')
                    .append($('<a href="#">').text('Add row')
                        .click(function (event) {
                            event.preventDefault(); 
                            $('#table-settings-columns').append(createRow());
                            updateRowActions();
                        })
                    )        
            )
        );
        $(tableLayout.fields).each(function(index, column) {
            $('#table-settings-columns').append(function () {
                    return createRow(column);
                }
            )
        });
        updateRowActions(); 
        $('#modal-table-settings').modal();
        
        function removeRow(row) {
            $(row).remove();
            updateRowActions();
        }
        
        function moveRowUp(row) {
            $(row).after($(row).prev());
            updateRowActions();
        }

        function moveRowDown(row) {
            $(row).before($(row).next());
            updateRowActions();
        }
        
        function createRow(columnData) {
            var row = $('<div>').addClass('row fieldConfigurationRow').attr('style', 'margin-top: 5px;');
            $(row).append(
                $('<div>').addClass('col-sm-2').attr('style', 'padding-right: 0px; padding-left: 0.5em;').append($('<input>').attr('type', 'text').addClass('form-control form-control-sm').attr('placeholder', 'Name')),
                $('<div>').addClass('col-sm-3').attr('style', 'padding-right: 0px; padding-left: 0.5em;').append($('<input>').attr('type', 'text').addClass('form-control form-control-sm').attr('placeholder', 'Field')
                    .bind('keydown', function( event ) {
                         if (event.keyCode === $.ui.keyCode.ESCAPE && $(this).autocomplete('instance').menu.active) {
                             event.stopPropagation();
                         }
                     })
                    .autocompleteFieldQuery({queryKeywords: queryKeywords, mode: 'field'})),
                $('<div>').addClass('col-sm-2').attr('style', 'padding-right: 0px; padding-left: 0.5em;').append($('<select>').addClass('form-control form-control-sm')
                    .append($('<option>').attr('value', 'plain').text('Plain'))
                    .append($('<option>').attr('value', 'isodate').text('ISO Date'))
                    .append($('<option>').attr('value', 'isoutcdate').text('ISO UTC Date'))),
                $('<div>').addClass('col-sm-2').attr('style', 'padding-right: 0px; padding-left: 0.5em;').append($('<select>').addClass('form-control form-control-sm')
                    .append($('<option>').attr('value', 'lowest').text('Lowest'))
                    .append($('<option>').attr('value', 'highest').text('Highest'))
                    .append($('<option>').attr('value', 'first').text('First'))
                    .append($('<option>').attr('value', 'last').text('Last'))),
                $('<div>').addClass('col-sm-1').attr('style', 'padding-right: 0px; padding-left: 0.5em;').append($('<input>').attr('type', 'checkbox').addClass('form-control form-control-sm'))
            );
            var actionDiv = $('<div>').addClass('col-sm-2').append(
                $('<div>').addClass('row actionRow').append(
                    $('<div>').addClass('col-sm-1').append($('<a href="#">').addClass('fa fa-arrow-up').click(function (event) {event.preventDefault(); moveRowUp(row)})),
                    $('<div>').addClass('col-sm-1').append($('<a href="#">').addClass('fa fa-arrow-down').click(function (event) {event.preventDefault(); moveRowDown(row)})),
                    $('<div>').addClass('col-sm-1').append($('<a href="#">').addClass('fa fa-times text-danger').click(function (event) {event.preventDefault(); removeRow(row)}))
                )
            );
            $(row).append($(actionDiv));
            if (columnData) {
                $(row).children().each(function (index, column) {
                    if (0 === index) {
                        $(column).find('input').val(columnData.name);
                    } else if (1 === index) {
                        $(column).find('input').val(columnData.field);
                    } else if (2 === index) {
                        $(column).find('select').val(columnData.format);
                    } else if (3 === index) {
                        $(column).find('select').val(columnData.array);
                    } else if (4 === index) {
                        $(column).find('input').prop('checked', columnData.link);
                    }
                });    
            }
            return row;        
        }
        
        function updateRowActions() {
            $('#table-settings-columns .actionRow').each(function (index, row) {
                if ($('#table-settings-columns').children().size() > 2) {
                    if (index == 0) {
                        $(row).find('.fa-arrow-up').hide();
                    } else {
                        $(row).find('.fa-arrow-up').show();
                    }
                    if (index >= $('#table-settings-columns').children().size() -2) {
                        $(row).find('.fa-arrow-down').hide();
                    } else {
                        $(row).find('.fa-arrow-down').show();
                    }
                } else {
                    $(row).find('.fa-arrow-up').hide();
                    $(row).find('.fa-arrow-down').hide();
                }
            });
        }
    });
    
    $('#btn-apply-table-settings').click(function () {
        var changed = false;
        if (tableLayout.sort_field !== $('#table-settings-sort-field').val()) {
            changed = true;
            tableLayout.sort_field = $('#table-settings-sort-field').val();
        }
        if (tableLayout.sort_order !== $('#table-settings-sort-order').val()) {
            changed = true;
            tableLayout.sort_order = $('#table-settings-sort-order').val();
        }
        var fields = [];
        $('#table-settings-columns .fieldConfigurationRow').each(function (rowIndex, row) {
            var rowData = {name: '', field: '', format: 'plain', array: 'first', link: false};
            $(row).children().each(function (columnIndex, column) {
                if (0 === columnIndex) {
                    rowData.name = $(column).find('input').val();
                } else if (1 === columnIndex) {
                    rowData.field = $(column).find('input').val();
                } else if (2 === columnIndex) {
                    rowData.format = $(column).find('select').val();
                } else if (3 === columnIndex) {
                    rowData.array = $(column).find('select').val();
                } else if (4 === columnIndex) {
                    rowData.link = $(column).find('input').prop('checked');
                }
            });
            if (rowData.name.trim().length > 0 && rowData.field.trim().length > 0) {
                fields.push(rowData);
            }            
        });
        
        if (JSON.stringify(fields) != JSON.stringify(tableLayout.fields)) {
            changed = true;
        }
        tableLayout.fields = fields;
        if (changed) {
            executeQuery(createQuery());    
        }
        $('#modal-table-settings').modal('hide');
    });
    
    // Load the stores search templates.
    $.ajax({
        type: 'GET',
        contentType: 'application/json',
        url: '../rest/search/templates',
        success: function(data) {
            if (!data || !data.searchtemplates) {
                return;
            }
            $.each(data.searchtemplates, function(index, template){
                $('#list-template-links').append(
                    $('<li>').append(
                        $('<a href="#">').click(function(event) {
                           event.preventDefault();
                           setValuesFromTemplate(template)
                        }).text(template.name),
                        $('<a href="#" class="fa fa-times pull-right text-danger">').click(function(event) {
                           event.preventDefault();
                           askRemoveTemplate(template)
                        })
                    )
                );
            });
        }
    });
    
    function isSearchInView(elem) {
        var $elem = elem;
        var $window = $(window);
        var docViewTop = $window.scrollTop();
        var docViewBottom = docViewTop + $window.height();
        var elemTop = $elem.offset().top;
        var elemBottom = elemTop + $elem.height();
        return docViewBottom > elemTop;
    }
    
    function enableOrDisableSearchButton() {
        if (!$('#query-string').val() || $('[id^=check-type-]:checked').size() == 0) {
            $('#btn-search, #template-name, #btn-save-template').attr('disabled', 'disabled');
        } else {
            $('#btn-search, #template-name').removeAttr("disabled");
            if ($('#template-name').val()) {
                $('#btn-save-template').removeAttr("disabled");
            }
        }
    }
    
    function createQuery() {
        if (!$('#query-string').val() || $('[id^=check-type-]:checked').size() == 0) {
            return null;
        }
        var query = { 
            query: $('#query-string').val(),
            types: $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get(),
            fields: tableLayout.getInternalFieldNames(),
            sort_field: tableLayout.sort_field,
            sort_order: tableLayout.sort_order
        };
        return query;
    }
    
    function executeQuery(queryParameters) {
        if (!queryParameters) {
            return;
        }
        $('#result_block').show();
        $.ajax({
            type: 'POST',
            contentType: 'application/json',
            url: '../rest/search/query',
            data: JSON.stringify(queryParameters),
            success: function(data) {
                $('#search-stats').text(':  Found ' + data.hits_as_string + ' results in ' + data.query_time_as_string + 'ms.');
                $('#result_card').empty();
                if (data.hits === 0) {
                    $('#result_card').append($('<p>').text('No results found'));
                } else {
                    var resultTable = $('<table>')
                    $(resultTable)
                        .addClass('table table-hover table-sm')
                        .append($('<thead>')
                            .append(function () {
                                var tr = $('<tr>');
                                $(tableLayout.fields).each(function (index, tableColumn) {
                                    var th = $('<th style="padding: 0.1rem; cursor: pointer;">').text(tableColumn.name)
                                    if (tableColumn.field === tableLayout.sort_field) {
                                        if ('asc' === tableLayout.sort_order) {
                                            $(th).addClass('headerSortAsc')
                                        } else {
                                            $(th).addClass('headerSortDesc')
                                        }
                                    }
                                    $(th).click(function (event) {
                                        event.preventDefault();
                                        sortResultTable(tableColumn.field);
                                    });
                                    $(tr).append($(th))
                                });    
                                return $(tr);
                            })
                        )
                        .append(function() {
                            var body = $('<tbody>')
                            $(data.results).each(function (index, searchResult) {
                                $(body).append(function () {
                                    var tr = $('<tr>');
                                    $(tableLayout.fields).each(function (index, field) {
                                        var td = $('<td style="padding: 0.1rem">');
                                        if (field.link) {
                                            $(td).append(
                                                $('<a>').attr('href', '#').text(tableLayout.getValueFromSource(searchResult.source, field, data.timeZone))
                                            )    
                                        } else {
                                            $(td).text(tableLayout.getValueFromSource(searchResult.source, field, data.timeZone))
                                        }
                                        $(tr).append($(td));
                                    });    
                                    return $(tr);
                                })
                            });
                            return $(body);
                        })
                    $('#result_card').append($('<div>').addClass('table-responsive').append($(resultTable)));
                    if (!isSearchInView($('#result_card'))) {
                        $('html,body').animate({scrollTop: $('#query-string').offset().top},'slow');
                    }
                }
            }
        });    
    }
    
    function sortResultTable(fieldName) {
        if (tableLayout.sort_field === fieldName) {
            if (tableLayout.sort_order === 'asc') {
                tableLayout.sort_order = 'desc';
            } else {
                tableLayout.sort_order = 'asc'
            }
        } else {
            tableLayout.sort_field = fieldName;
        }
        executeQuery(createQuery());
    }
    
    function setValuesFromTemplate(template) {
        $('[id^=check-type-]').prop('checked', false);
        $.each(template.types, function(index, type){
            $('#check-type-' + type).prop('checked', true);    
        });
        $('#query-string').val(template.query);
        $('#template-name').val(template.name);
        tableLayout.fields = template.fields;
        tableLayout.sort_field = template.sort_field;
        tableLayout.sort_order = template.sort_order;
        $('#query-string').removeAttr('disabled').trigger('input');
    }
    
    function createTemplate() {
        var template = { 
            name: $('#template-name').val(),
            query: $('#query-string').val(),
            types: $('[id^=check-type-]:checked').map(function(){ return $(this).val(); }).get(),
            fields: tableLayout.fields,
            sort_field: tableLayout.sort_field,
            sort_order: tableLayout.sort_order            
        };
        return template;
    }
    
    function storeTemplate(template, isOverwrite) {
        $.ajax({
            type: 'PUT',
            contentType: 'application/json',
            url: '../rest/search/templates/' + encodeURIComponent($('#template-name').val()),
            data: JSON.stringify(template),
            success: function() {
                $('#template-name').val('');
                if (isOverwrite) {
                    $('#list-template-links > li > a').filter(function() {
                        return $(this).text() === template.name;
                    }).unbind('click').click(function(event) {
                        event.preventDefault();
                        setValuesFromTemplate(template)
                    });
                } else {
                    $('#list-template-links').append(
                        $('<li>').append(
                            $('<a href="#">').click(function(event) {
                               event.preventDefault();
                               setValuesFromTemplate(template)
                            }).text(template.name),
                            $('<a href="#" class="fa fa-times pull-right text-danger">').click(function(event) {
                               event.preventDefault();
                               askRemoveTemplate(template)
                            })
                        )
                    );
                }
            }
        });
    }
    
    function askRemoveTemplate(template) {
        $('#remove-template-name').text(template.name);
        $('#modal-template-remove').modal();
    }
    
    function escapeToHtml(stringToEscape) {
        return $("<div></div>").text(stringToEscape).html();
    }
    

    
  </script>
  
</body>
</html>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=9">
<title>Enterprise Telemetry Monitor - Search</title>
<link rel="stylesheet" href="../resources/styles/bootstrap-3.3.1.min.css" />
<link rel="stylesheet" href="../resources/prettify/prettify.css" />
<script src="../resources/scripts/jquery-2.1.3.min.js"></script>
<script src="../resources/scripts/bootstrap-3.3.1.min.js"></script>
<script src="../resources/scripts/highcharts-4.0.4.min.js"></script>
<script src="../resources/prettify/prettify.js"></script>
</head>
<body>
	<div class="container" style="margin-top: 0.5em;">
		<div class="row">
			<div class="panel panel-default">
				<div class="panel-heading clearfix">
					<div id="panel_title" class="panel-title pull-left"></div>
					<div class="pull-right">
						<a id="back_lnk" href="#">New query</a>
					</div>
				</div>
				<div class="panel-body">
					<div id="tabs" role="tabpanel">
					  <!-- Nav tabs -->
					  <ul class="nav nav-tabs" role="tablist">
					    <li id="event_tab_header" role="presentation" class="active"><a href="#event_tab" aria-controls="home" role="tab" data-toggle="tab">Event</a></li>
					    <li id="event_correlation_tab_header" role="presentation" class="hidden"><a href="#event_correlation_tab" aria-controls="home" role="tab" data-toggle="tab">Event correlation</a></li>
					    <li id="event_overview_tab_header" role="presentation"><a href="#event_overview_tab" aria-controls="home" role="tab" data-toggle="tab">Overview</a></li>
					  </ul>
					  <!-- Tab panes -->
					  <div class="tab-content">
					    <div role="tabpanel" class="tab-pane active" id="event_tab">
							<form class="form-horizontal">
							  <div class="form-group">
							    <label class="col-sm-2 control-label">Event name</label>
							    <div class="col-sm-4">
							      <p id="event_name" class="form-control-static"></p>
							    </div>
                                <label class="col-sm-2 control-label">Creation time</label>
                                <div class="col-sm-4">
                                  <p id="event_creationTime" class="form-control-static"></p>
                                </div>
							  </div>
							  <div class="form-group">
                                <label class="col-sm-2 control-label">Application</label>
                                <div class="col-sm-4">
                                  <p id="event_application" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Expiry time</label>
                                <div class="col-sm-4">
                                  <p id="event_expiryTime" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">  
                                <label class="col-sm-2 control-label">Endpoint</label>
                                <div class="col-sm-4">
                                  <p id="event_endpoint" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Source id</label>
                                <div class="col-sm-4">
                                  <p id="event_sourceId" class="form-control-static"></p>
                                </div>
							  </div>
                              <div class="form-group">  
                                <label class="col-sm-2 control-label">Transaction name</label>
                                <div class="col-sm-4">
                                  <p id="event_transactionName" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Source correlation id</label>
                                <div class="col-sm-4">
                                  <p id="event_sourceCorrelationId" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">  
                                <div class="col-sm-12">
                                  <pre id="event_content"></pre>
                                </div>
                              </div>
							</form>					    
					    </div>
					    
                        <div role="tabpanel" class="tab-pane hidden" id="event_correlation_tab">
                            <form class="form-horizontal">
                              <div class="form-group">
                                <label class="col-sm-2 control-label">Event name</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_name" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Creation time</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_creationTime" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">
                                <label class="col-sm-2 control-label">Application</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_application" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Expiry time</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_expiryTime" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">  
                                <label class="col-sm-2 control-label">Endpoint</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_endpoint" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Source id</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_sourceId" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">  
                                <label class="col-sm-2 control-label">Transaction name</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_transactionName" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Source correlation id</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_sourceCorrelationId" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">  
                                <div class="col-sm-12">
                                  <pre id="event_correlation_content"></pre>
                                </div>
                              </div>
                            </form>                     
                        </div>
                        <div role="tabpanel" class="tab-pane" id="event_overview_tab">
                            <div id="overview_container" style="overflow:auto;">
                                <div class="text-center"><img id="ajax_loader" src="../resources/images/ajax-loader.gif" alt="Loading..." /></div>
                            </div>
                        </div>					    
					  </div>
					</div>				
				</div>
			</div>
		</div>
	</div>
	<script>
//<![CDATA[        
$(function () {
	var getUrlParameter = function(paramName, defaultValue) {
	    var pageURL = window.location.search.substring(1);
	    var urlVariables = pageURL.split('&');
	    for (var i = 0; i < urlVariables.length; i++) {
	        var parameterName = urlVariables[i].split('=');
	        if (parameterName[0] == paramName) {
	            return decodeURIComponent(parameterName[1]);
	        }
	    }
	    return defaultValue;
	};

	var padNumber = function(str, max) {
        str = str.toString();
	    return str.length < max ? padNumber("0" + str, max) : str;
	};
	    
    var formatDate = function(date) {
        return padNumber(date.getFullYear() + '-' + padNumber((date.getMonth() + 1), 2) + '-' + date.getDate(), 2) + ' ' + padNumber(date.getHours(), 2) + ':' + padNumber(date.getMinutes(), 2) + ":" + padNumber(date.getSeconds(), 2) + '.' + padNumber(date.getMilliseconds(), 3);
    };

    var setEventTabData = function(prefix, data) {
        if (data.type == 'MESSAGE_REQUEST') {
            $('#' + prefix + '_tab_header > a').text('Request');
        } else if (data.type == 'MESSAGE_RESPONSE') {
            $('#' + prefix + '_tab_header > a').text('Response');
        } else if (data.type == 'MESSAGE_DATAGRAM') {
            $('#' + prefix + '_tab_header > a').text('Datagram');
        }
        
        $('#' + prefix + '_tab #' + prefix + '_name').text(data.name);
        $('#' + prefix + '_tab #' + prefix + '_application').text(data.application);
        $('#' + prefix + '_tab #' + prefix + '_endpoint').text(data.endpoint);
        $('#' + prefix + '_tab #' + prefix + '_creationTime').text(formatDate(new Date(data.creationTime)));
        if (data.expiryTime) {
            $('#' + prefix + '_tab #' + prefix + '_expiryTime').text(formatDate(new Date(data.expiryTime)));
        }
        $('#' + prefix + '_tab #' + prefix + '_transactionName').text(data.transactionName);
        $('#' + prefix + '_tab #' + prefix + '_sourceId').text(data.sourceId);
        $('#' + prefix + '_tab #' + prefix + '_sourceCorrelationId').text(data.sourceCorrelationId);
        $('#' + prefix + '_tab #' + prefix + '_content').text(data.content);
        if (data.content != undefined && data.content.indexOf('<') === 0) {
            var formattedHtml = prettyPrintOne($('#' + prefix + '_tab #' + prefix + '_content').html());
            $('#' + prefix + '_tab #' + prefix + '_content').html(formattedHtml);
        }
    };

	$('#tabs a').click(function (e) {
		  e.preventDefault();
		  $(this).tab('show');
	});

	$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
		var target = $(e.target).attr("href") // activated tab
		if (target == '#event_overview_tab') {
			if (!$('#overview_container > div > svg').length) {
			    renderOverview();
			}
		}
	});
	
	var eventId = getUrlParameter('id');
	
	$('#panel_title').text('Event ' + eventId);
	$('#back_lnk').attr('href', 'index.html?queryString=' + encodeURIComponent(getUrlParameter('queryString', '')) + '&start=' + encodeURIComponent(getUrlParameter('start', '')) + '&max=' + encodeURIComponent(getUrlParameter('max', '')));
	$.ajax('../rest/query/event/' + eventId, { dataType: "json", cache: false, success: function (data) {
		if (!data) {
			return;
		}
		setEventTabData('event', data);
	    if (data.type == 'MESSAGE_RESPONSE' && data.correlationId) {
	    	$.ajax('../rest/query/event/' + data.correlationId, { dataType: "json", cache: false, success: function (data) {
	    		 setEventTabData('event_correlation', data);
	    		 $('#event_correlation_tab_header').removeClass('hidden');
	    		 $('#event_correlation_tab').removeClass('hidden');
	    		 
	    	}});
		} else if (data.type == 'MESSAGE_REQUEST' && data.childCorrelationIds) {
			var requestId = data.id;
			$.each(data.childCorrelationIds, function(index, correlationId) {
				$.getJSON('../rest/query/event/' + correlationId, function (data) {
					if (data.correlationId == requestId && data.type == 'MESSAGE_RESPONSE') {
		                $('#event_correlation_tab_header').removeClass('hidden');
		                $('#event_correlation_tab').removeClass('hidden');
						setEventTabData('event_correlation', data);
						// Dunno how to break out of the $.each at this point.
					}
				});
			});
		}
	}});


	var renderOverview = function() {
	    $('#overview_container').highcharts({
	        chart: {
	            events: {
	                load: function () {
	                    var ren = this.renderer,
	                        colors = Highcharts.getOptions().colors,
	                        rightArrow = ['M', 0, 0, 'L', 30, 0, 'L', 25, 5, 'M', 30, 0, 'L', 25, -5],
	                        leftArrow = ['M', 30, 0, 'L', 0, 0, 'L', 5, 5, 'M', 0, 0, 'L', 5, -5];
	                    var chart = this;
	                    $.ajax('../rest/query/event/' + eventId + '/overview/', { dataType: "json", cache: false, success: function (data) {
	                        if (!data) {
	                            return;
	                        }
	                        var applicationCount = data.applicationCount;
	                        var timeframeCount = data.timeframeCount;
	                        var applicationOffset = 300;
	                        var applicationStart = 20;
	                        var timeframeHeight = 50;

	                        // Write the application headers.
	                        $.each(data.applications, function(application_ix, application) {
	                            var appHeaderXPos = applicationStart + (application_ix * applicationOffset);
	                            ren.label(application, appHeaderXPos, 40)
	                            .css({
	                                fontWeight: 'bold'
	                            }).add();
	                            if (application_ix < applicationCount -1) {
	                                // Add an application separator.
	                                var xpos = appHeaderXPos + (applicationOffset * 0.9);
	                                ren.path(['M', xpos, 40, 'L', xpos, 40 + (timeframeHeight * timeframeCount) + 20])
	                                .attr({
	                                    'stroke-width': 2,
	                                    stroke: 'silver',
	                                    dashstyle: 'dash'
	                                }).add()
	                            }
	                        });

	                        // Write the timeframes
	                        $.each(data.timeframes, function(timeframe_ix, timeframe) {
	                            $.each(timeframe, function(event_ix, event) {
	                                if($.isEmptyObject(event.eventName)) {
	                                    return true;
	                                }
	                                var tooltip = '';
	                                if(event.responseTime) {
	                                    tooltip += 'responsetime: ' + event.responseTime + ', ';
	                                }
	                                if(event.absoluteResponseTime) {
	                                    tooltip += 'absolute responsetime: ' + event.absoluteResponseTime + ', ';
	                                }
	                                tooltip += 'creationTime: '+ formatDate(new Date(event.creationTime))+ ', endpoint: ' + event.endpoint + ", direction: " + event.direction + ", type: " + event.type;
	                                var xOffset = 0;
	                                var arrow = null;
	                                if ('OUTGOING' == event.direction && 'MESSAGE_REQUEST' == event.type) {
	                                    xOffset = 15;
	                                    arrow = rightArrow;
	                                } else if ('INCOMING' == event.direction && 'MESSAGE_RESPONSE' == event.type) {
	                                    xOffset = 15;
	                                    arrow = leftArrow;
	                                } else if ('OUTGOING' == event.direction && 'MESSAGE_DATAGRAM' == event.type) {
	                                    xOffset = 15;
	                                    arrow = rightArrow;
	                                }
	                                var label = ren.label(event.eventName, applicationStart + (event_ix * applicationOffset) + xOffset, 80 + (timeframe_ix * timeframeHeight))
                                    .on('click', function () {
                                        window.open('event.html?id=' + event.id + '&queryString=' + encodeURIComponent(getUrlParameter('queryString', '')) + '&start=' + encodeURIComponent(getUrlParameter('start', '')) + '&max=' + encodeURIComponent(getUrlParameter('max', '')), '_self');
                                    })
                                    .on('mouseover', function () {
                                        label.css({ cursor: 'pointer'});
                                    })
	                                .attr({
                                        'stroke-width': 1,
                                        fill: event.color,
                                        'stroke-opacity' : 1.0,
                                        stroke: event.color,
	                                    zIndex: -1,
	                                    title: tooltip,
	                                    r: 2
	                                });
	                                if (event.id == eventId) {
	                                    label = label.css({
	                                        fontWeight: 'bold'
	                                    })
		                            }
	                                label.add().shadow(true);                                
	                                                                
	                                if(!$.isEmptyObject(arrow)) {   
	                                    ren.path(arrow)
	                                    .attr({
	                                        'stroke-width': 2,
	                                        stroke: '#000000'
	                                    })
	                                    .translate(applicationStart + (event_ix * applicationOffset) + (applicationOffset * 0.84), 91.5 + (timeframe_ix * timeframeHeight))
	                                    .add();
	                                }
	                            });                            
	                        });

	                        $('#overview_container > div > svg > g > rect').attr('fill-opacity', 0.6);
	                        chart.setSize((applicationCount * applicationOffset) + applicationStart, (timeframeCount * timeframeHeight) + 80);
	                    }});                    
	                }
	            }
	        },
	        credits: {
	            enabled: false
	        },
	        title: {
	            text: ''
	        }

	    });
	};
});
//]]>
</script>
</body>
</html>

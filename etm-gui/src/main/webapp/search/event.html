<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enterprise Telemetry Monitor - Search</title>
<link rel="stylesheet"
	href="../resources/styles/bootstrap-3.3.1.min.css" />
<script src="../resources/scripts/jquery-2.1.3.min.js"></script>
<script src="../resources/scripts/bootstrap-3.3.1.min.js"></script>
</head>
<body>
	<div class="container" style="margin-top: 0.5em;">
		<div class="row">
			<div class="panel panel-default">
				<div class="panel-heading clearfix">
					<div id="panel_title" class="panel-title pull-left"></div>
					<div class="pull-right">
						<a id="back_lnk" href="#">Back</a>
					</div>
				</div>
				<div class="panel-body">
					<div id="tabs" role="tabpanel">
					  <!-- Nav tabs -->
					  <ul class="nav nav-tabs" role="tablist">
					    <li id="event_tab_header" role="presentation" class="active"><a href="#event_tab" aria-controls="home" role="tab" data-toggle="tab">Event</a></li>
					    <li id="event_correlation_tab_header" role="presentation" class="hidden"><a href="#event_correlation_tab" aria-controls="home" role="tab" data-toggle="tab">Event correlation</a></li>
					    <li id="event_overview_tab_header" role="presentation" class="hidden"><a href="#event_overview_tab" aria-controls="home" role="tab" data-toggle="tab">Overview</a></li>
					  </ul>
					  <!-- Tab panes -->
					  <div class="tab-content">
					    <div role="tabpanel" class="tab-pane active" id="event_tab">
							<form class="form-horizontal">
							  <div class="form-group">
							    <label class="col-sm-2 control-label">Event name</label>
							    <div class="col-sm-4">
							      <p id="event_name" class="form-control-static"></p>
							    </div>
                                <label class="col-sm-2 control-label">Creation time</label>
                                <div class="col-sm-4">
                                  <p id="event_creationTime" class="form-control-static"></p>
                                </div>
							  </div>
							  <div class="form-group">
                                <label class="col-sm-2 control-label">Application</label>
                                <div class="col-sm-4">
                                  <p id="event_application" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Expiry time</label>
                                <div class="col-sm-4">
                                  <p id="event_expiryTime" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">  
                                <label class="col-sm-2 control-label">Endpoint</label>
                                <div class="col-sm-4">
                                  <p id="event_endpoint" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Source id</label>
                                <div class="col-sm-4">
                                  <p id="event_sourceId" class="form-control-static"></p>
                                </div>
							  </div>
                              <div class="form-group">  
                                <label class="col-sm-2 control-label">Transaction name</label>
                                <div class="col-sm-4">
                                  <p id="event_transactionName" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Source correlation id</label>
                                <div class="col-sm-4">
                                  <p id="event_sourceCorrelationId" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">  
                                <div class="col-sm-12">
                                  <p id="event_content" class="form-control-static"></p>
                                </div>
                              </div>
							</form>					    
					    </div>
					    
                        <div role="tabpanel" class="tab-pane hidden" id="event_correlation_tab">
                            <form class="form-horizontal">
                              <div class="form-group">
                                <label class="col-sm-2 control-label">Event name</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_name" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Creation time</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_creationTime" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">
                                <label class="col-sm-2 control-label">Application</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_application" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Expiry time</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_expiryTime" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">  
                                <label class="col-sm-2 control-label">Endpoint</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_endpoint" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Source id</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_sourceId" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">  
                                <label class="col-sm-2 control-label">Transaction name</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_transactionName" class="form-control-static"></p>
                                </div>
                                <label class="col-sm-2 control-label">Source correlation id</label>
                                <div class="col-sm-4">
                                  <p id="event_correlation_sourceCorrelationId" class="form-control-static"></p>
                                </div>
                              </div>
                              <div class="form-group">  
                                <div class="col-sm-12">
                                  <p id="event_correlation_content" class="form-control-static"></p>
                                </div>
                              </div>
                            </form>                     
                        </div>
                        <div role="tabpanel" class="tab-pane hidden" id="event_overview_tab">
                        </div>					    
					  </div>
					</div>				
				</div>
			</div>
		</div>
	</div>
	<script>
//<![CDATA[        
$(function () {
	var getUrlParameter = function(paramName, defaultValue) {
	    var pageURL = window.location.search.substring(1);
	    var urlVariables = pageURL.split('&');
	    for (var i = 0; i < urlVariables.length; i++) {
	        var parameterName = urlVariables[i].split('=');
	        if (parameterName[0] == paramName) {
	            return decodeURIComponent(parameterName[1]);
	        }
	    }
	    return defaultValue;
	};

	var padNumber = function(str, max) {
        str = str.toString();
	    return str.length < max ? padNumber("0" + str, max) : str;
	};
	    
    var formatDate = function(date) {
        return padNumber(date.getDate(), 2) + '-' + padNumber((date.getMonth() + 1), 2) + '-' + date.getFullYear() + ' ' + padNumber(date.getHours(), 2) + ':' + padNumber(date.getMinutes(), 2) + ":" + padNumber(date.getSeconds(), 2) + '.' + padNumber(date.getMilliseconds(), 3);
    };

    var setEventTabData = function(prefix, data) {
        if (data.type == 'MESSAGE_REQUEST') {
            $('#' + prefix + '_tab_header > a').text('Request');
        } else if (data.type == 'MESSAGE_RESPONSE') {
            $('#' + prefix + '_tab_header > a').text('Response');
        } else if (data.type == 'MESSAGE_DATAGRAM') {
            $('#' + prefix + '_tab_header > a').text('Datagram');
        }
        
        $('#' + prefix + '_tab #' + prefix + '_name').text(data.name);
        $('#' + prefix + '_tab #' + prefix + '_application').text(data.application);
        $('#' + prefix + '_tab #' + prefix + '_endpoint').text(data.endpoint);
        $('#' + prefix + '_tab #' + prefix + '_creationTime').text(formatDate(new Date(data.creationTime)));
        if (data.expiryTime) {
            $('#' + prefix + '_tab #' + prefix + '_expiryTime').text(formatDate(new Date(data.expiryTime)));
        }
        $('#' + prefix + '_tab #' + prefix + '_transactionName').text(data.transactionName);
        $('#' + prefix + '_tab #' + prefix + '_sourceId').text(data.sourceId);
        $('#' + prefix + '_tab #' + prefix + '_sourceCorrelationId').text(data.sourceCorrelationId);
        $('#' + prefix + '_tab #' + prefix + '_content').text(data.content);
    };

	$('#tabs a').click(function (e) {
		  e.preventDefault();
		  $(this).tab('show');
		})
	
	var eventId = getUrlParameter('id');
	
	$('#panel_title').text('Event ' + eventId);
	$('#back_lnk').attr('href', 'index.html?queryString=' + encodeURIComponent(getUrlParameter('queryString', '')) + '&start=' + encodeURIComponent(getUrlParameter('start', '')) + '&max=' + encodeURIComponent(getUrlParameter('max', '')));
	$.ajax('../rest/query/event/' + eventId, { dataType: "json", success: function (data) {
		setEventTabData('event', data);
	    if (data.type == 'MESSAGE_RESPONSE' && data.correlationId) {
	    	$.ajax('../rest/query/event/' + data.correlationId, { dataType: "json", success: function (data) {
	    		 $('#event_correlation_tab_header').removeClass('hidden');
	    		 $('#event_correlation_tab').removeClass('hidden');
	    		 setEventTabData('event_correlation', data);
	    	}});
		} else if (data.type == 'MESSAGE_REQUEST' && data.childCorrelationIds) {
			var requestId = data.id;
			$.each(data.childCorrelationIds, function(index, correlationId) {
				$.getJSON('../rest/query/event/' + correlationId, function (data) {
					if (data.correlationId == requestId && data.type == 'MESSAGE_RESPONSE') {
		                $('#event_correlation_tab_header').removeClass('hidden');
		                $('#event_correlation_tab').removeClass('hidden');
						setEventTabData('event_correlation', data);
						// Dunno how to break out of the $.each at this point.
					}
				});
			});
		}
		
	}});


});
//]]>
</script>
</body>
</html>

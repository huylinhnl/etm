<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enterprise Telemetry Monitor - Search</title>
<link rel="stylesheet"
	href="../resources/styles/bootstrap-3.3.1.min.css" />
<script src="../resources/scripts/jquery-2.1.3.min.js"></script>
</head>
<body>
	<div class="container-fluid" style="margin-top: 0.5em;">
		<div class="row">
			<div class="col-md-2">
				<div class="panel panel-default">
					<div class="panel-heading">Available fieldnames</div>
					<div class="panel-body">
					   <ul>
					       <li>application</li>
					       <li>content</li>
					       <li>correlationId</li>
					       <li>creationTime</li>
					       <li>direction</li>
					       <li>endpoint</li>
					       <li>expirtyTime</li>
					       <li>id</li>
					       <li>name</li>
					       <li>sourceCorrelationId</li>
					       <li>sourceId</li>
					       <li>transactionId</li>
					       <li>transactionName</li>
					       <li>type</li>
					       <li>responseTime</li>
					   </ul>
					</div>
				</div>
			</div>
			<div class="col-md-8">
				<div id="standard_search" class="panel panel-default">
					<div class="panel-heading clearfix">
						<div class="panel-title pull-left">Search telemetry events</div>
						<div class="pull-right">
							<a id="adv_search_lnk" href="#">Advanced search</a>
						</div>
					</div>
					<div class="panel-body">
						<p>
							Please enter your search string in the field below and press the
							'Search' button. Specific fields can be searched in the format
							<mark>fieldname:&lt;value&gt;</mark>
							. For example, if you want to search for all event generated from
							application "My Application" the search string will be
							<mark>application:"My application"</mark>
							. Multiple field can be combined by using the
							<mark>AND</mark>
							or
							<mark>OR</mark>
							operator. Range values can be used by applying the format
							<mark>[&lt;start&gt; TO &lt;end&gt;]</mark>
							to the field value. For example, to query the events of the last
							half hour the search string will be
							<mark>creationTime:[NOW-30MINUTES TO NOW]</mark>
							.
						</p>
						<div class="input-group">
							<input id="search_input" type="text" class="form-control"
								placeholder="Search for..." /> <span class="input-group-btn">
								<button id="standard_search_btn" type="button"
									class="btn btn-default">Search</button>
							</span>
						</div>
					</div>
				</div>
				<div id="advanced_search" class="panel panel-default"
					style="display: none;">
					<div class="panel-heading clearfix">
						<div class="panel-title pull-left">Search telemetry events</div>
						<div class="pull-right">
							<a id="std_search_lnk" href="#">Standard search</a>
						</div>
					</div>
					<div class="panel-body"></div>
				</div>
				<div class="panel panel-default">
					<div class="panel-body">
						<div id="result_overview" class="text-center"></div>
						<div class="table-responsive">
							<table id="result_table"
								class="table table-condensed table-striped table-hover">
								<thead>
									<tr>
										<th>Name</th>
										<th>Application</th>
										<th>Endpoint</th>
										<th>Creation time</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>

						</div>
					</div>
					<!-- 				
                <div class="panel-footer">Panel footer</div>
 -->
				</div>
			</div>
		</div>
	</div>
	<script>
//<![CDATA[        
$(function () {
    var currentStart = 0;
    var rowCount = 25;

	var padNumber = function(str, max) {
		  str = str.toString();
		  return str.length < max ? padNumber("0" + str, max) : str;
	};
	
	var formatDate = function(date) {
		return padNumber(date.getDate(), 2) + '-' + padNumber((date.getMonth() + 1), 2) + '-' + date.getFullYear() + ' ' + padNumber(date.getHours(), 2) + ':' + padNumber(date.getMinutes(), 2) + ":" + padNumber(date.getSeconds(), 2) + '.' + padNumber(date.getMilliseconds(), 3);
	};

    var getUrlParameter = function(paramName, defaultValue) {
        var pageURL = window.location.search.substring(1);
        var urlVariables = pageURL.split('&');
        for (var i = 0; i < urlVariables.length; i++) {
            var parameterName = urlVariables[i].split('=');
            if (parameterName[0] == paramName) {
                return decodeURIComponent(parameterName[1]);
            }
        }
        return defaultValue;
    };

	var executeQuery = function(start, max, animate) {
        $.ajax('../rest/query?queryString=' + encodeURIComponent($('#search_input').val()) + '&start=' + start + '&rows=' + max, { dataType: "json", success: function (data) {
            var overView = 'Found ' + data.numFound + ' events in ' + data.queryTime + 'ms.';
            if (data.start < data.end) {
                  overView = overView + ' Showing events ' + (data.start + 1) + ' to '+ (data.end + 1) +'.'; 
            }
            $('#result_overview').html('<p>' + overView + '</p>');
            $('#result_table > tbody').empty();
            $.each(data.events, function(index, event) {
                var application = $.isEmptyObject(event.application) ? '' : event.application;
                var endpoint = $.isEmptyObject(event.endpoint) ? '' : event.endpoint; 
                var rowContent = '<tr><td><div style="display: none;"><a href="event.html?id=' + encodeURIComponent(event.id) + '&queryString=' + encodeURIComponent($('#search_input').val()) + '&start='+ encodeURIComponent(start) + '&max='+ encodeURIComponent(max) + '">' + event.name + '</a></div></td><td><div style="display: none;">' + application + '</div></td><td><div style="display: none;">' + endpoint + '</div></td><td><div style="display: none;">' + formatDate(new Date(event.creationTime)) + '</div></td></tr>';  
                $(rowContent).appendTo($('#result_table > tbody'));
                if (animate) {
                    $('#result_table > tbody > :last-child > td > div').slideDown(500);
                } else {
                	$('#result_table > tbody > tr > td > div').show();
                }                
            });
        }});	
    };

    var executeSearch = function() {
        if( !$('#search_input').val()) {
            $('#search_input').parent().addClass('has-error');
            return;
        } else {
            $('#search_input').parent().removeClass('has-error');
            currentStart = 0;
            executeQuery(currentStart, rowCount, true);
        }
    };

    $('#search_input').on('keypress', function (event) {
         if(event.which == '13'){
            $(this).attr("disabled", "disabled");
            executeSearch();
            $(this).removeAttr("disabled");
         }
    });
    
	$('#standard_search_btn').click(function() {
		executeSearch();
	});

	$('#adv_search_lnk').click(function() {
		$('#standard_search').slideUp(500);
		$('#advanced_search').slideDown(500);
	});
	
    $('#std_search_lnk').click(function() {
    	$('#advanced_search').slideUp(500);
        $('#standard_search').slideDown(500);
    });

	var queryString = getUrlParameter('queryString');
	if (!$.isEmptyObject(queryString)) {
		$('#search_input').val(queryString);
		currentStart = getUrlParameter('start', 0);
		rowCount = getUrlParameter('max', 25); 
		executeQuery(currentStart, rowCount, false);
	}
	
});
//]]>
</script>
</body>
</html>

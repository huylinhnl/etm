<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=9">
<title>Enterprise Telemetry Monitor - Search</title>
<link rel="stylesheet"
	href="../resources/styles/bootstrap-3.3.1.min.css" />
	<script src="../resources/scripts/jquery-2.1.3.min.js"></script>
</head>
<body>
	<div class="container-fluid" style="margin-top: 0.5em;">
		<div class="row">
			<div class="col-md-2">
				<div class="panel panel-default">
					<div class="panel-heading">Available fieldnames</div>
					<div class="panel-body">
					   <ul>
					       <li><a href="#" onclick="$('#search_input').val('application: ');return false;">application</a></li>
					       <li><a href="#" onclick="$('#search_input').val('content: ');return false;">content</a></li>
					       <li><a href="#" onclick="$('#search_input').val('content_length: ');return false;">content_length</a></li>
					       <li><a href="#" onclick="$('#search_input').val('correlation_id: ');return false;">correlation_id</a></li>
					       <li><a href="#" onclick="$('#search_input').val('creation_time: ');return false;">creation_time</a></li>
					       <li><a href="#" onclick="$('#search_input').val('endpoint: ');return false;">endpoint</a></li>
					       <li><a href="#" onclick="$('#search_input').val('id: ');return false;">id</a></li>
					       <li><a href="#" onclick="$('#search_input').val('name: ');return false;">name</a></li>
					       <li><a href="#" onclick="$('#search_input').val('responsetime: ');return false;">responsetime</a></li>
					       <li><a href="#" onclick="$('#search_input').val('transaction_id: ');return false;">transaction_id</a></li>
					       <li><a href="#" onclick="$('#search_input').val('transaction_name: ');return false;">transaction_name</a></li>
					       <li><a href="#" onclick="$('#search_input').val('type: ');return false;">type</a></li>
					   </ul>
					</div>
				</div>
			</div>
			<div class="col-md-8">
				<div id="standard_search" class="panel panel-default">
					<div class="panel-heading clearfix">
						<div class="panel-title pull-left">Search telemetry events</div>
					</div>
					<div class="panel-body">
						<p>
							Please enter your search string in the field below and press the
							'Search' button. Specific fields can be searched in the format
							<mark>fieldname: &lt;value&gt;</mark>
							. For example, if you want to search for all event generated from
							application "My Application" the search string will be
							<mark>application: "My application"</mark>
							. Multiple field can be combined by using the
							<mark>AND</mark>
							or
							<mark>OR</mark>
							operator. Range values can be used by applying the format
							<mark>[&lt;start&gt; TO &lt;end&gt;]</mark>
							to the field value. For example, to query the events of the last
							half hour the search string will be
							<mark>creation_time: [now-30m TO now]</mark>
							.
						</p>
						<div id="errorBox" class="alert alert-danger" style="display: none;" role="alert"></div>
						<div class="input-group">
							<input id="search_input" type="text" class="form-control"
								placeholder="Search for..." /> <span class="input-group-btn">
								<button id="standard_search_btn" type="button"
									class="btn btn-default">Search</button>
							</span>
						</div>
					</div>
				</div>
				<div class="panel panel-default">
					<div class="panel-body">
					    <div class="pull-right"><a id="download_link" href="#" style="display: none;">Download</a></div>
						<div id="result_overview" class="text-center"></div>
						<div class="table-responsive">
							<table id="result_table"
								class="table table-condensed table-striped table-hover">
								<thead>
									<tr>
										<th><a href="#" id="sort_name">Name</a></th>
										<th><a href="#" id="sort_application">Application</a></th>
										<th><a href="#" id="sort_endpoint">Endpoint</a></th>
										<th><a href="#" id="sort_creation_time">Creation time</a></th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
							<div class="text-center"><img id="ajax_loader" src="../resources/images/ajax-loader.gif" alt="Loading..." style="display:none;"/></div>
						</div>
					</div>
					<div class="panel-footer">
					   <div class="text-center"><a id="show_more_lnk" href="#" style="display: none;">Show more</a></div>   
					</div>
				</div>
			</div>
            <div class="col-md-2">
                <div class="panel panel-default">
                    <div class="panel-heading">Search templates</div>
                    <div class="panel-body">
                       <ul>
                           <li><a href="#" onclick="$('#search_input').val('application: &quot;x&quot;');return false;">application &lt;x&gt;</a></li>
                           <li><a href="#" onclick="$('#search_input').val('endpoint: &quot;x&quot;');return false;">endpoint &lt;x&gt;</a></li>
                           <li><a href="#" onclick="$('#search_input').val('creation_time: [now-1h TO now]');return false;">last hour</a></li>
                           <li><a href="#" onclick="$('#search_input').val('creation_time: [now-1h TO now] AND application:&quot;x&quot;');return false;">last hour of application &lt;x&gt;</a></li>
                           <li><a href="#" onclick="$('#search_input').val('creation_time: [' + new Date(new Date().setHours(0,0,0,0)).toLocalISOString() + ' TO ' + new Date(new Date().setHours(23,59,59,999)).toLocalISOString() + ']');return false;">today</a></li>
                           <li><a href="#" onclick="$('#search_input').val('creation_time: [' + new Date(new Date().setHours(0,0,0,0) - 86400000).toLocalISOString() + ' TO ' + new Date(new Date().setHours(23,59,59,999) - 86400000).toLocalISOString() + ']');return false;">yesterday</a></li>
                       </ul>
                    </div>
                </div>
            </div>

		</div>
	</div>
	<script>
//<![CDATA[
if ( !Date.prototype.toLocalISOString ) {
  ( function() {

    function pad(number) {
      var r = String(number);
      if ( r.length === 1 ) {
        r = '0' + r;
      }
      return r;
    }

    Date.prototype.toLocalISOString = function() {
      return this.getFullYear()
        + '-' + pad( this.getMonth() + 1 )
        + '-' + pad( this.getDate() )
        + 'T' + pad( this.getHours() )
        + ':' + pad( this.getMinutes() )
        + ':' + pad( this.getSeconds() )
        + '.' + String( (this.getMilliseconds()/1000).toFixed(3) ).slice( 2, 5 );
    };

  }() );
}           
           
$(function () {
    var currentStart = 0;
    var initialStart = currentStart;
    var rowCount = 25;
    var sortOrder = 'asc';
    var sortField = '';

	var padNumber = function(str, max) {
		  str = str.toString();
		  return str.length < max ? padNumber("0" + str, max) : str;
	};
	
	var formatDate = function(date) {
		return padNumber(date.getFullYear() + '-' + padNumber((date.getMonth() + 1), 2) + '-' + date.getDate(), 2) + ' ' + padNumber(date.getHours(), 2) + ':' + padNumber(date.getMinutes(), 2) + ":" + padNumber(date.getSeconds(), 2) + '.' + padNumber(date.getMilliseconds(), 3);
	};

    var getUrlParameter = function(paramName, defaultValue) {
        var pageURL = window.location.search.substring(1);
        var urlVariables = pageURL.split('&');
        for (var i = 0; i < urlVariables.length; i++) {
            var parameterName = urlVariables[i].split('=');
            if (parameterName[0] == paramName) {
                return decodeURIComponent(parameterName[1]);
            }
        }
        return defaultValue;
    };

    var escapeToHtml = function(value) {
        return $('<div/>').text(value).html();
    };

    var addRow = function(event, start, max, animate) {
        var application = $.isEmptyObject(event.application) ? '' : event.application;
        var endpoint = $.isEmptyObject(event.endpoint) ? '' : event.endpoint;
        var eventName = $.isEmptyObject(event.name) ? '?' : event.name; 
        var rowContent = '<tr><td><div style="display: none;"><a href="event.html?id=' + encodeURIComponent(event.id) + '&index=' + encodeURIComponent(event.indexName) + '&type=' + encodeURIComponent(event.indexType) + '&queryString=' + encodeURIComponent($('#search_input').val()) + '&start='+ encodeURIComponent(start) + '&max='+ encodeURIComponent(max) + '&sortField=' + encodeURIComponent(sortField) + '&sortOrder=' + encodeURIComponent(sortOrder) + '">' + escapeToHtml(eventName) + '</a></div></td><td><div style="display: none;">' + escapeToHtml(application) + '</div></td><td><div style="display: none;">' + escapeToHtml(endpoint) + '</div></td><td><div style="display: none;">' + formatDate(new Date(event.creationTime)) + '</div></td></tr>';  
        $(rowContent).appendTo($('#result_table > tbody'));
        if (animate) {
            $('#result_table > tbody > :last-child > td > div').slideDown(500);
        } else {
            $('#result_table > tbody > :last-child > td > div').show();
        }                        
    };

	var executeQuery = function(start, max, sortField, sortOrder, animate) {
		$('#errorBox').hide('fast');
        $('#result_table > tbody').empty();
		$('#ajax_loader').show();
        $.ajax('../rest/query?queryString=' + encodeURIComponent($('#search_input').val()) + '&start=' + encodeURIComponent(start) + '&rows=' + encodeURIComponent(max) + '&sortField=' + encodeURIComponent(sortField) + '&sortOrder=' + encodeURIComponent(sortOrder), { dataType: "json", cache: false, success: function (data) {
        	$("#ajax_loader").hide();
            if (!data) {
                return;
            }
            var overView = 'Found <span id="result_count_found">' + data.numFound + '</span> events in ' + data.queryTime + 'ms.';
            if (data.start < data.end) {
                overView = overView + ' Showing events ' + (data.start + 1) + ' to <span id="end_range">'+ (data.end + 1) +'</span>.'; 
                $('#download_link').attr('href', './download?queryString=' + encodeURIComponent($('#search_input').val()) + '&start=' + encodeURIComponent(initialStart) + '&rows=500&sortField=' + encodeURIComponent(sortField) + '&sortOrder=' + encodeURIComponent(sortOrder));
                $('#download_link').show();
                $('#show_more_lnk').show();
            }
            $('#result_overview').html('<p>' + overView + '</p>');
            $.each(data.events, function(index, event) {
                addRow(event, start, max, animate);
            });
            currentStart = start + data.numReturned;
        },
        error : function(jqXHR) {
        	$("#ajax_loader").hide();
			var contentType = jqXHR.getResponseHeader("Content-Type");
		    if (jqXHR.status === 200 && contentType.toLowerCase().indexOf("text/html") >= 0) {
		        // assume that our login has expired - reload our current page
		        window.location.reload();
		        return;
		    }        	
        	$("#errorBox").text('Error executing query: ' +  jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')');
        	$("#errorBox").show('fast');
        }});	
    };

    var executeSearch = function() {
        if( !$('#search_input').val()) {
            $('#search_input').parent().addClass('has-error');
            return;
        } else {
            $('#search_input').parent().removeClass('has-error');
            currentStart = 0;
            initialStart = currentStart;
            executeQuery(currentStart, rowCount, sortField, sortOrder, true);
        }
    };

    $('#search_input').on('keypress', function (event) {
         if(event.which == '13'){
            $(this).attr("disabled", "disabled");
            executeSearch();
            $(this).removeAttr("disabled");
         }
    });

    var setSortListener = function(linkId, fieldName) {
        $('#' + linkId).click(function() {
            if (sortField === fieldName) {
                if ('asc' === sortOrder) {
                    sortOrder = 'desc';
                } else {
                    sortOrder = 'asc';
                }
            } else {
                sortField = fieldName;
                sortOrder = 'asc';
            }
            executeSearch();
        });
    }
    
	$('#standard_search_btn').click(function() {
		executeSearch();
	});
	
	$('#show_more_lnk').click(function(e) {
	   e.preventDefault();
	   showMore();
	});

	var queryString = getUrlParameter('queryString');
	if (!$.isEmptyObject(queryString)) {
		$('#search_input').val(queryString);
		currentStart = parseInt(getUrlParameter('start', 0));
		initialStart = currentStart;
		rowCount = parseInt(getUrlParameter('max', 25)); 
		sortField = getUrlParameter('sortField');
		sortOrder = getUrlParameter('sortOrder', 'asc');
		executeQuery(currentStart, rowCount, sortField, sortOrder, false);
		rowCount = 25;
	}

	var loading = false;
	$(window).scroll(function() {
		if (loading) {
			return;
		}
	    if($(window).scrollTop() == $(document).height() - $(window).height()) {
	       showMore();
		}
	});
	
	var showMore = function() {
            loading = true;
            $('#show_more_lnk').hide();
            $('#ajax_loader').show();
            $.ajax('../rest/query?queryString=' + encodeURIComponent($('#search_input').val()) + '&start=' + currentStart + '&rows=' + rowCount + '&sortField=' + encodeURIComponent(sortField) + '&sortOrder=' + encodeURIComponent(sortOrder), { dataType: "json", cache: false, success: function (data) {
               $("#ajax_loader").hide();
               if (!data) {
                   return;
               }
               $.each(data.events, function(index, event) {
                   addRow(event, currentStart, rowCount, false);
               });
               currentStart += data.numReturned;
               $('#end_range').text(currentStart);
               $('#download_link').attr('href', './download?queryString=' + encodeURIComponent($('#search_input').val()) + '&start=' + encodeURIComponent(initialStart) + '&rows=500&sortField=' + encodeURIComponent(sortField) + '&sortOrder=' + encodeURIComponent(sortOrder));
               $('#result_count_found').text(data.numFound);
               if (data.start < data.end) {
                   $('#show_more_lnk').show();
               }
               loading = false;
            }});
	};

    setSortListener('sort_name','name');
    setSortListener('sort_application','application');
    setSortListener('sort_endpoint','endpoint');
	setSortListener('sort_creation_time','creation_time');
	
});
//]]>
</script>
</body>
</html>

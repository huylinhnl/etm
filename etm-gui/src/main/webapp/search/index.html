<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=9">
<title>Enterprise Telemetry Monitor - Search</title>
<link rel="stylesheet"
	href="../resources/styles/bootstrap-3.3.1.min.css" />
	<script src="../resources/scripts/jquery-2.1.3.min.js"></script>
</head>
<body>
	<div class="container-fluid" style="margin-top: 0.5em;">
		<div class="row">
			<div class="col-md-2">
				<div class="panel panel-default">
					<div class="panel-heading">Available fieldnames</div>
					<div class="panel-body">
					   <ul>
					       <li>application</li>
					       <li>content</li>
					       <li>correlationId</li>
					       <li>creationTime</li>
					       <li>endpoint</li>
					       <li>id</li>
					       <li>name</li>
					       <li>sourceCorrelationId</li>
					       <li>sourceId</li>
					       <li>transactionId</li>
					       <li>transactionName</li>
					       <li>type</li>
					   </ul>
					</div>
				</div>
			</div>
			<div class="col-md-8">
				<div id="standard_search" class="panel panel-default">
					<div class="panel-heading clearfix">
						<div class="panel-title pull-left">Search telemetry events</div>
						<div class="pull-right">
							<a id="adv_search_lnk" href="#">Advanced search</a>
						</div>
					</div>
					<div class="panel-body">
						<p>
							Please enter your search string in the field below and press the
							'Search' button. Specific fields can be searched in the format
							<mark>fieldname:&lt;value&gt;</mark>
							. For example, if you want to search for all event generated from
							application "My Application" the search string will be
							<mark>application:"My application"</mark>
							. Multiple field can be combined by using the
							<mark>AND</mark>
							or
							<mark>OR</mark>
							operator. Range values can be used by applying the format
							<mark>[&lt;start&gt; TO &lt;end&gt;]</mark>
							to the field value. For example, to query the events of the last
							half hour the search string will be
							<mark>creationTime:[NOW-30MINUTES TO NOW]</mark>
							.
						</p>
						<div id="errorBox" class="alert alert-danger" style="display: none;" role="alert"></div>
						<div class="input-group">
							<input id="search_input" type="text" class="form-control"
								placeholder="Search for..." /> <span class="input-group-btn">
								<button id="standard_search_btn" type="button"
									class="btn btn-default">Search</button>
							</span>
						</div>
					</div>
				</div>
				<div id="advanced_search" class="panel panel-default"
					style="display: none;">
					<div class="panel-heading clearfix">
						<div class="panel-title pull-left">Search telemetry events</div>
						<div class="pull-right">
							<a id="std_search_lnk" href="#">Standard search</a>
						</div>
					</div>
					<div class="panel-body"></div>
				</div>
				<div class="panel panel-default">
					<div class="panel-body">
						<div id="result_overview" class="text-center"></div>
						<div class="table-responsive">
							<table id="result_table"
								class="table table-condensed table-striped table-hover">
								<thead>
									<tr>
										<th><a href="#" id="sort_name">Name</a></th>
										<th><a href="#" id="sort_application">Application</a></th>
										<th><a href="#" id="sort_endpoint">Endpoint</a></th>
										<th><a href="#" id="sort_source_id">Source id</a></th>
										<th><a href="#" id="sort_creation_time">Creation time</a></th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
							<div class="text-center"><img id="ajax_loader" src="../resources/images/ajax-loader.gif" alt="Loading..." style="display:none;"/></div>
						</div>
					</div>
				</div>
			</div>
            <div class="col-md-2">
                <div class="panel panel-default">
                    <div class="panel-heading">Search templates</div>
                    <div class="panel-body">
                       <ul>
                           <li><a href="#" onclick="$('#search_input').val('application:&quot;x&quot;');return false;">application &lt;x&gt;</a></li>
                           <li><a href="#" onclick="$('#search_input').val('endpoint:&quot;x&quot;');return false;">endpoint &lt;x&gt;</a></li>
                           <li><a href="#" onclick="$('#search_input').val('creationTime:[NOW-1HOUR TO NOW]');return false;">last hour</a></li>
                           <li><a href="#" onclick="$('#search_input').val('creationTime:[NOW-1HOUR TO NOW] AND application:&quot;x&quot;');return false;">last hour of application &lt;x&gt;</a></li>
                           <li><a href="#" onclick="$('#search_input').val('creationTime:[' + new Date(new Date().setHours(0,0,0,0) - 86400000).toISOString() + ' TO ' + new Date(new Date().setHours(23,59,59,999) - 86400000).toISOString() + ']');return false;">yesterday</a></li>
                       </ul>
                    </div>
                </div>
            </div>

		</div>
	</div>
	<script>
//<![CDATA[
if ( !Date.prototype.toISOString ) {
  ( function() {

    function pad(number) {
      var r = String(number);
      if ( r.length === 1 ) {
        r = '0' + r;
      }
      return r;
    }

    Date.prototype.toISOString = function() {
      return this.getUTCFullYear()
        + '-' + pad( this.getUTCMonth() + 1 )
        + '-' + pad( this.getUTCDate() )
        + 'T' + pad( this.getUTCHours() )
        + ':' + pad( this.getUTCMinutes() )
        + ':' + pad( this.getUTCSeconds() )
        + '.' + String( (this.getUTCMilliseconds()/1000).toFixed(3) ).slice( 2, 5 )
        + 'Z';
    };

  }() );
}           
           
$(function () {
    var currentStart = 0;
    var rowCount = 25;
    var sortOrder = 'asc';
    var sortField = '';

	var padNumber = function(str, max) {
		  str = str.toString();
		  return str.length < max ? padNumber("0" + str, max) : str;
	};
	
	var formatDate = function(date) {
		return padNumber(date.getFullYear() + '-' + padNumber((date.getMonth() + 1), 2) + '-' + date.getDate(), 2) + ' ' + padNumber(date.getHours(), 2) + ':' + padNumber(date.getMinutes(), 2) + ":" + padNumber(date.getSeconds(), 2) + '.' + padNumber(date.getMilliseconds(), 3);
	};

    var getUrlParameter = function(paramName, defaultValue) {
        var pageURL = window.location.search.substring(1);
        var urlVariables = pageURL.split('&');
        for (var i = 0; i < urlVariables.length; i++) {
            var parameterName = urlVariables[i].split('=');
            if (parameterName[0] == paramName) {
                return decodeURIComponent(parameterName[1]);
            }
        }
        return defaultValue;
    };

    var escapeToHtml = function(value) {
        return $('<div/>').text(value).html();
    };

    var addRow = function(event, start, max, animate) {
        var application = $.isEmptyObject(event.application) ? '' : event.application;
        var endpoint = $.isEmptyObject(event.endpoint) ? '' : event.endpoint;
        var eventName = $.isEmptyObject(event.name) ? '?' : event.name; 
        var rowContent = '<tr><td><div style="display: none;"><a href="event.html?id=' + encodeURIComponent(event.id) + '&queryString=' + encodeURIComponent($('#search_input').val()) + '&start='+ encodeURIComponent(start) + '&max='+ encodeURIComponent(max) + '&sortField=' + encodeURIComponent(sortField) + '&sortOrder=' + encodeURIComponent(sortOrder) + '">' + escapeToHtml(eventName) + '</a></div></td><td><div style="display: none;">' + escapeToHtml(application) + '</div></td><td><div style="display: none;">' + escapeToHtml(endpoint) + '</div></td><td><div style="display: none;">' + escapeToHtml(event.sourceId) + '</div></td><td><div style="display: none;">' + formatDate(new Date(event.creationTime)) + '</div></td></tr>';  
        $(rowContent).appendTo($('#result_table > tbody'));
        if (animate) {
            $('#result_table > tbody > :last-child > td > div').slideDown(500);
        } else {
            $('#result_table > tbody > :last-child > td > div').show();
        }                        
    };

	var executeQuery = function(start, max, sortField, sortOrder, animate) {
		$('#errorBox').hide('fast');
		$('#ajax_loader').show();
        $.ajax('../rest/query?queryString=' + encodeURIComponent($('#search_input').val()) + '&start=' + encodeURIComponent(start) + '&rows=' + encodeURIComponent(max) + '&sortField=' + encodeURIComponent(sortField) + '&sortOrder=' + encodeURIComponent(sortOrder), { dataType: "json", cache: false, success: function (data) {
        	$("#ajax_loader").hide();
            if (!data) {
                return false;
            }
            var overView = 'Found <span id="result_count_found">' + data.numFound + '</span> events in ' + data.queryTime + 'ms.';
            if (data.start < data.end) {
                overView = overView + ' Showing events ' + (data.start + 1) + ' to <span id="end_range">'+ (data.end + 1) +'</span>.'; 
            }
            $('#result_overview').html('<p>' + overView + '</p>');
            $('#result_table > tbody').empty();
            $.each(data.events, function(index, event) {
                addRow(event, start, max, animate);
            });
            currentStart = start + data.numReturned;
        },
        error : function(jqXHR) {
        	$("#ajax_loader").hide();
        	$("#errorBox").text('Error executing query: ' +  jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')');
        	$("#errorBox").show('fast');
        }});	
    };

    var executeSearch = function() {
        if( !$('#search_input').val()) {
            $('#search_input').parent().addClass('has-error');
            return;
        } else {
            $('#search_input').parent().removeClass('has-error');
            currentStart = 0;
            executeQuery(currentStart, rowCount, sortField, sortOrder, true);
        }
    };

    $('#search_input').on('keypress', function (event) {
         if(event.which == '13'){
            $(this).attr("disabled", "disabled");
            executeSearch();
            $(this).removeAttr("disabled");
         }
    });

    var setSortListener = function(linkId, fieldName) {
        $('#' + linkId).click(function() {
            if (sortField === fieldName) {
                if ('asc' === sortOrder) {
                    sortOrder = 'desc';
                } else {
                    sortOrder = 'asc';
                }
            } else {
                sortField = fieldName;
                sortOrder = 'asc';
            }
            executeSearch();
        });
    }
    
	$('#standard_search_btn').click(function() {
		executeSearch();
	});

	$('#adv_search_lnk').click(function() {
		$('#standard_search').slideUp(500);
		$('#advanced_search').slideDown(500);
	});
	
    $('#std_search_lnk').click(function() {
    	$('#advanced_search').slideUp(500);
        $('#standard_search').slideDown(500);
    });

	var queryString = getUrlParameter('queryString');
	if (!$.isEmptyObject(queryString)) {
		$('#search_input').val(queryString);
		currentStart = parseInt(getUrlParameter('start', 0));
		rowCount = parseInt(getUrlParameter('max', 25)); 
		sortField = getUrlParameter('sortField');
		sortOrder = getUrlParameter('sortOrder', 'asc');
		executeQuery(currentStart, rowCount, sortField, sortOrder, false);
		rowCount = 25;
	}

	var loading = false;
	$(window).scroll(function() {
		if (loading) {
			return;
		}
	    if($(window).scrollTop() == $(document).height() - $(window).height()) {
	    	loading = true;
	        $('#ajax_loader').show();
		   	$.ajax('../rest/query?queryString=' + encodeURIComponent($('#search_input').val()) + '&start=' + currentStart + '&rows=' + rowCount + '&sortField=' + encodeURIComponent(sortField) + '&sortOrder=' + encodeURIComponent(sortOrder), { dataType: "json", cache: false, success: function (data) {
		   	   $("#ajax_loader").hide();
		       if (!data) {
			       return;
			   }
	           $.each(data.events, function(index, event) {
	        	   addRow(event, currentStart, rowCount, false);
	           });
	           currentStart += data.numReturned;
	           $('#end_range').text(currentStart);
	           $('#result_count_found').text(data.numFound);
	           loading = false;
	        }});
		}
	});


    setSortListener('sort_name','name');
    setSortListener('sort_application','application');
    setSortListener('sort_endpoint','endpoint');
    setSortListener('sort_source_id','sourceId');
	setSortListener('sort_creation_time','creationTime');
	
});
//]]>
</script>
</body>
</html>

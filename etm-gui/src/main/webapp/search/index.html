<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enterprise Telemetry Monitor - Search</title>
<link rel="stylesheet"
	href="../resources/styles/bootstrap-3.3.1.min.css" />
<script src="../resources/scripts/jquery-1.8.2.min.js"></script>
</head>
<body>
	<div class="container" style="margin-top: 0.5em;">
		<div class="row">
			<div class="panel panel-default">
				<div class="panel-heading clearfix">
					<div class="panel-title pull-left">Search telemetry events</div>
					<div class="pull-right">
						<a id="adv_search_lnk" href="#">Advanced search</a>
					</div>
				</div>
				<div class="panel-body">
					<p>
						Please enter your search string in the field below and press the
						'Search' button. Specific fields can be searched in the format
						"fieldname:&lt;value&gt;". For example, if you want to search for
						all event generated from application "My Application" the search
						string will be
						<mark>application:"My application"</mark>
						. Multiple field can be combined by using the
						<mark>AND</mark>
						or
						<mark>OR</mark>
						operator. Range values can be used by applying the format
						<mark>[&lt;start&gt; TO &lt;end&gt;]</mark>
						to the field value. For example, to query the events of the last
						half hour the search string will be
						<mark>creationTime:[NOW-30MINUTES TO NOW]</mark>
					</p>
					<form role="search">
						<div class="input-group">
							<input id="search_input" type="text" class="form-control"
								placeholder="Search for..." /> <span class="input-group-btn">
								<button id="standard_search_btn" type="button"
									class="btn btn-default">Search</button>
							</span>
						</div>
					</form>
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-body">
				    <div id="result_overview" class="text-center"></div>
					<div class="table-responsive">
						<table id="result_table"
							class="table table-condensed table-striped table-hover">
							<thead>
								<tr>
									<th>Name</th>
									<th>Application</th>
									<th>Endpoint</th>
									<th>Creation time</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
						
					</div>
				</div>
<!-- 				
                <div class="panel-footer">Panel footer</div>
 -->                
			</div>
		</div>
	</div>
	<script>
//<![CDATA[        
$(function () {

	var padNumber = function(str, max) {
		  str = str.toString();
		  return str.length < max ? padNumber("0" + str, max) : str;
	};
	
	var formatDate = function(date) {
		return padNumber(date.getDate(), 2) + '-' + padNumber((date.getMonth() + 1), 2) + '-' + date.getFullYear() + ' ' + padNumber(date.getHours(), 2) + ':' + padNumber(date.getMinutes(), 2) + ":" + padNumber(date.getSeconds(), 2) + '.' + padNumber(date.getMilliseconds(), 3);
	};
	
	var currentStart = 0;
	var rowCount = 25;
	$('#standard_search_btn').click(function() {
		if( !$('#search_input').val()) {
			$('#search_input').parent().addClass('has-error');
			return;
		} else {
			$('#search_input').parent().removeClass('has-error');
			currentStart = 0;
			$.ajax('../rest/query?queryString=' + encodeURIComponent($('#search_input').val()) + '&start=' + currentStart + '&rows=' + rowCount, { dataType: "json", success: function (data) {
				$('#result_overview').html('<p>Found ' + data.numFound + ' events in ' + data.queryTime + 'ms. Showing events ' + (data.start + 1) + ' to '+ (data.end + 1) +'.</p>');
				$('#result_table > tbody').empty();
				$.each(data.events, function(index, event) {
	                var application = $.isEmptyObject(event.application) ? '' : event.application;
	                var endpoint = $.isEmptyObject(event.endpoint) ? '' : event.endpoint; 
	                var rowContent = '<tr><td><div style="display: none;">' + event.name + '</div></td><td><div style="display: none;">' + application + '</div></td><td><div style="display: none;">' + endpoint + '</div></td><td><div style="display: none;">' + formatDate(new Date(event.creationTime)) + '</div></td></tr>';  
	                $(rowContent).appendTo($('#result_table > tbody'));
	                $('#result_table > tbody > :last-child > td > div').slideDown(500);                
				});
			}});
		}
	});
	
});
//]]>
</script>
</body>
</html>

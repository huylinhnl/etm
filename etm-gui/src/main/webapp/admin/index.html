<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=9">
<title>Enterprise Telemetry Monitor - Administration</title>
<link rel="stylesheet"
	href="../resources/styles/bootstrap-3.3.1.min.css" />
<script src="../resources/scripts/jquery-2.1.3.min.js"></script>
<script src="../resources/scripts/bootstrap-3.3.1.min.js"></script>
</head>
<body>
	<div class="container" style="margin-top: 0.5em;">
		<div class="row">
			<div class="panel panel-default">
				<div class="panel-heading clearfix">
					<div class="panel-title pull-left" id="node_title">ETM Administration - cluster</div>
					<div class="pull-right">
						<select id="node_select" class="form-control">
							<option value="cluster">cluster</option>
							<option disabled="disabled">-----</option>
						</select>
					</div>
				</div>
				<div class="panel-body">
					<div id="tabs" role="tabpanel">
						<!-- Nav tabs -->
						<ul class="nav nav-tabs" role="tablist">
							<li id="etm_tab_header" role="presentation" class="active"><a href="#etm_tab" aria-controls="home" role="tab" data-toggle="tab">ETM</a></li>
							<li id="endpoint_tab_header" role="presentation"><a href="#endpoint_tab" aria-controls="home" role="tab" data-toggle="tab">Endpoint</a></li>
							<li id="status_tab_header" role="presentation"><a href="#status_tab" aria-controls="home" role="tab" data-toggle="tab">Status</a></li>
							<li id="license_tab_header" role="presentation"><a href="#license_tab" aria-controls="home" role="tab" data-toggle="tab">License</a></li>
						</ul>
						<br />
						<!-- Tab panes -->
						<div class="tab-content">
							<div role="tabpanel" class="tab-pane active" id="etm_tab">
							    <div id="etm_form_errorBox" class="alert alert-danger" style="display: none;" role="alert"></div>
							    <div id="etm_form_infoBox" class="alert alert-info" style="display: none;" role="alert"></div>
								<form id="etm_form" class="form-horizontal">
									<div class="form-group">
										<label for="etm_enhancing_handler_count"
											class="col-sm-3 control-label">Enhancing handler
											count</label>
										<div class="col-sm-3">
											<input id="etm_enhancing_handler_count"
												name="enhancing_handler_count" type="number"
												class="form-control" required="required" min="0" />
										</div>
                                        <label for="etm_data_retention_time"
                                            class="col-sm-3 control-label">Data retention time</label>
                                        <div class="col-sm-3">
                                            <input id="etm_data_retention_time"
                                                name="data_retention" type="number"
                                                class="form-control" required="required" min="-1" />
                                        </div>
									</div>

									<div class="form-group">
                                        <label for="etm_persisting_handler_count"
                                            class="col-sm-3 control-label">Persisting handler count</label>
                                        <div class="col-sm-3">
                                            <input id="etm_persisting_handler_count"
                                                name="persisting_handler_count" type="number"
                                                class="form-control" required="required" min="0" />
                                        </div>
                                        <label for="etm_shards_per_index"
                                            class="col-sm-3 control-label">Shards per index</label>
                                        <div class="col-sm-3"> 
                                            <input id="etm_shards_per_index"
                                                name="shards_per_index" type="number"
                                                class="form-control" required="required" min="1" />
                                        </div>
									</div>

									<div class="form-group">
                                        <label for="etm_ringbuffer_size"
                                            class="col-sm-3 control-label">Ringbuffer size</label>
                                        <div class="col-sm-3">
                                            <input id="etm_ringbuffer_size" name="event_buffer_size"
                                                type="number" class="form-control" required="required"
                                                min="255" />
                                        </div>
                                        <label for="etm_replicas_per_index"
                                            class="col-sm-3 control-label">Replicas per index</label>
                                        <div class="col-sm-3">
                                            <input id="etm_replicas_per_index"
                                                name="_replicas_per_index" type="number"
                                                class="form-control" required="required" min="0" />
                                        </div>
									</div>

									<div class="form-group">
                                        <label for="etm_persisting_bulk_size"
                                            class="col-sm-3 control-label">Persisting bulk size</label>
                                        <div class="col-sm-3">
                                            <input id="etm_persisting_bulk_size"
                                                name="persisting_bulk_size" type="number"
                                                class="form-control" required="required" min="1" />
                                        </div>
									</div>

									<input type="submit" class="btn btn-default" value="Save" />
								</form>
							</div>
							<div role="tabpanel" class="tab-pane" id="endpoint_tab">
							    <div id="endpoint_errorBox" class="alert alert-danger" style="display: none;" role="alert"></div>
							    <div id="endpoint_infoBox" class="alert alert-info" style="display: none;" role="alert"></div>
                                <form id="endpoint_selection_form" class="form-horizontal">
                                    <div class="form-group">
                                        <label for="endpoint_select" class="col-sm-3 control-label">Endpoint</label>
                                        <div class="col-sm-9">
					                        <select id="endpoint_select" class="form-control">
					                            <option value="*">*</option>
					                            <option disabled="disabled">-----</option>
					                        </select>                                        
                                        </div>
                                    </div>
                                </form>
                                <form id="endpoint_form" class="form-horizontal">
                                    <div class="form-group">
                                        <label for="endpoint_name" class="col-sm-3 control-label">Name</label>
                                        <div class="col-sm-3">
                                            <input id="endpoint_name" name="endpoint.name" type="text" class="form-control" required="required" />
                                        </div>
                                        <label for="endpoint_direction" class="col-sm-3 control-label">Direction</label>
                                        <div class="col-sm-3">
                                            <select id="endpoint_direction" name="endpoint.direction" class="form-control">
                                                <option value=""></option>
                                                <option value="INCOMING">Incoming</option>
                                                <option value="OUTGOING">Outgoing</option>
                                            </select>                                        
                                        </div>
                                    </div>
									<div id="eventname_parsers" class="panel panel-default">
									   <div class="panel-heading clearfix">
									       <div class="panel-title pull-left">Eventname parsers</div>
									       <div class="pull-right">
									           <button id="btn_add_eventname_parser" type="button" class="btn btn-default btn-sm">
									               <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
									           </button>
									       </div>    
									   </div>
									   <div class="panel-body">
									   </div>
									</div>                 
                                    <div id="application_parsers" class="panel panel-default">
                                       <div class="panel-heading clearfix">
                                           <div class="panel-title pull-left">Application parsers</div>
                                           <div class="pull-right">
                                               <button id="btn_add_application_parser" type="button" class="btn btn-default btn-sm">
                                                   <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                                               </button>
                                           </div>    
                                       </div>
                                       <div class="panel-body">
                                       </div>
                                    </div>                 
                                    <div id="transactionname_parsers" class="panel panel-default">
                                       <div class="panel-heading clearfix">
                                           <div class="panel-title pull-left">Transactionname parsers</div>
                                           <div class="pull-right">
                                               <button id="btn_add_transactionname_parser" type="button" class="btn btn-default btn-sm">
                                                   <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                                               </button>
                                           </div>    
                                       </div>
                                       <div class="panel-body">
                                       </div>
                                    </div>       
                                    <div id="correlation_parsers" class="panel panel-default">
                                       <div class="panel-heading clearfix">
                                           <div class="panel-title pull-left">Correlation parsers</div>
                                           <div class="pull-right">
                                               <button id="btn_add_correlation_parser" type="button" class="btn btn-default btn-sm">
                                                   <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                                               </button>
                                           </div>    
                                       </div>
                                       <div class="panel-body">
                                       </div>
                                    </div>       
                                    <input type="submit" id="btn_endpoint_save" class="btn btn-default" value="Save" />
                                    <input type="submit" id="btn_endpoint_delete" class="btn btn-danger" value="Remove" formnovalidate="formnovalidate" />          
                                </form>
							</div>
							<div role="tabpanel" class="tab-pane" id="status_tab"></div>
							<div role="tabpanel" class="tab-pane" id="license_tab">
							    <div id="license_errorBox" class="alert alert-danger" style="display: none;" role="alert"></div>
							    <div id="license_infoBox" class="alert alert-info" style="display: none;" role="alert"></div>
                                <form id="license_form" class="form-horizontal">
                                    <div class="form-group">
                                        <label for="license_company"
                                            class="col-sm-3 control-label">Licensed to</label>
                                        <div class="col-sm-3">
                                            <input id="license_company" type="text" class="form-control" readonly="readonly" />
                                        </div>
                                        <label for="license_expiry" class="col-sm-3 control-label">License expiry</label>
                                        <div class="col-sm-3">
                                            <input id="license_expiry" type="text" class="form-control" readonly="readonly"/>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="license_company"
                                            class="col-sm-3 control-label">New license key</label>
                                        <div class="col-sm-9">
                                            <input id="license_key" type="text" class="form-control" required="required"/>
                                        </div>
                                    </div>
                                    <input type="submit" class="btn btn-default" value="Save" />
                                </form>							
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
//<![CDATA[        
$(function () {

	var infoDelay = 5000;
	
	var loadData = function(nodeName) {
		$('#etm_form').attr('action', '../rest/admin/node/' + encodeURIComponent(nodeName));
		$('#license_form').attr('action', '../rest/system/license');
		$.getJSON('../rest/admin/node/' + encodeURIComponent(nodeName), function (data) {
			if (!data) {
			    return;
			}
			$('#etm_enhancing_handler_count').val(data['enhancing_handler_count']);
			$('#etm_persisting_handler_count').val(data['persisting_handler_count']);
			$('#etm_ringbuffer_size').val(data['event_buffer_size']);
			$('#etm_persisting_bulk_size').val(data['persisting_bulk_size']);
			$('#etm_data_retention_time').val(data['data_retention']);
			$('#etm_shards_per_index').val(data['shards_per_index']);
			$('#etm_replicas_per_index').val(data['replicas_per_index']);
            $('#status_tab').text(data.name + ' is ' + (data.active ? 'up' : 'down'));
		});
	};

	var addExpressionParsers = function(divId, elementName, expressionParsers, includeName) {
		$('#' + divId + ' > .panel-body').empty();
        if (expressionParsers) {
            $.each(expressionParsers, function(index, expressionParser) {
            	appendExpressionParser(divId, elementName, includeName, index);
                // Set the values.                
                if ('fixed_position' == expressionParser.type) {
                    if (expressionParser.line != undefined) {
                    	$('#' + elementName + '_fixed_pos_line_' + index).val(expressionParser.line);
                    }
                    $('#' + elementName + '_fixed_pos_start_' + index).val(expressionParser.start_pos);
                    $('#' + elementName + '_fixed_pos_end_' + index).val(expressionParser.end_pos);
                } else if ('fixed_value' == expressionParser.type) {
                    $('#' + elementName + '_fixed_value_' + index).val(expressionParser.value);
                } else if ('json' == expressionParser.type) {
                    $('#' + elementName + '_json_' + index).val(expressionParser.path);
                } else if ('xpath' == expressionParser.type) {
                	$('#' + elementName + '_xpath_' + index).val(expressionParser.expression);
                } else if ('xslt' == expressionParser.type) {
                	$('#' + elementName + '_xslt_' + index).val(expressionParser.template);
                }
                if (includeName) {
                	$('#' + elementName + '_name_' + index).val(expressionParser.name);
                }
                $('#' + elementName + '_select_' + index).val(expressionParser.type);
                $('#' + elementName + '_select_' + index).change();
            });
            styleExpressionParserButtons(divId);
        }
	};

	var appendExpressionParser = function(divId, elementName, includeName, index) {
		if (index == undefined) {
			index = 0;
			// Determine first unused index.
			var rows = $('#' + divId + ' > .panel-body > .form-group');
			var rowIds = [];
			$.each(rows, function(ix, row) {
			    rowId = row.id.substring(row.id.indexOf('_ix_') + 4);
			    rowIds.push(parseInt(rowId));
			});
			while (-1 != $.inArray(index, rowIds)) {
				index++;
			}
		}
        $('#' + divId + ' > .panel-body').append($('<div id="' + elementName + '_exp_prs_ix_' + index + '" class="form-group"></div>'));
        if (includeName) {
        	var nameDiv = $('<div></div>').attr('class', 'col-sm-2')
        	   .append($('<input />')
                    .attr('id', elementName + '_name_' + index)
                    .attr('name', elementName + '_name_' + index)
                    .attr('type', 'text').attr('class', 'form-control')
                    .attr('required', 'required')
                    .attr('placeholder', 'Name')
            );
        	$('#' + divId + ' > .panel-body > #' + elementName + '_exp_prs_ix_' + index).append(nameDiv);
        }
        var selectDiv = $('<div></div>').attr('class', 'col-sm-2')
          .append($('<select></select>').attr('id', elementName + '_select_' + index).attr('name', elementName + '_type_' + index).attr('class', 'form-control')
                  .append($('<option></option>').attr("value", 'fixed_position').text('Fixed position'))
                  .append($('<option></option>').attr("value", 'fixed_value').text('Fixed value'))
                  .append($('<option></option>').attr("value", 'json').text('JsonPath'))
                  .append($('<option></option>').attr("value", 'xpath').text('XPath'))
                  .append($('<option></option>').attr("value", 'xslt').text('XSLT'))
        );
        $('#' + divId + ' > .panel-body > #' + elementName + '_exp_prs_ix_' + index).append(selectDiv);
        var inputDiv = $('<div></div>').attr('class', 'col-sm-7')
            .append($('<div></div>').attr('class', 'col-sm-4').append($('<input />')
                    .attr('id', elementName + '_fixed_pos_line_' + index)
                    .attr('name', elementName + '_fixed_pos_line_' + index)
                    .attr('type', 'number').attr('class', 'form-control')
                    .attr('placeholder', 'Line number')
                    .attr('min', '1')))
            .append($('<div></div>').attr('class', 'col-sm-4').append($('<input />')
                    .attr('id', elementName + '_fixed_pos_start_' + index)
                    .attr('name', elementName + '_fixed_pos_start_' + index)
                    .attr('type', 'number').attr('class', 'form-control')
                    .attr('placeholder', 'Start index')
                    .attr('required', 'required')
                    .attr('min', '1')))
            .append($('<div></div>').attr('class', 'col-sm-4').append($('<input />')
                    .attr('id', elementName + '_fixed_pos_end_' + index)
                    .attr('name', elementName + '_fixed_pos_end_' + index)
                    .attr('type', 'number').attr('class', 'form-control')
                    .attr('placeholder', 'End index')
                    .attr('required', 'required')
                    .attr('min', '1')))
            .append($('<input />')
                    .attr('id', elementName + '_fixed_value_' + index)
                    .attr('name', elementName + '_fixed_value_' + index)
                    .attr('type', 'text').attr('class', 'form-control')
                    .attr('placeholder', 'Fixed name')
                    .attr('style', 'display: none;'))
            .append($('<input />')
                    .attr('id', elementName + '_json_' + index)
                    .attr('name', elementName + '_json_' + index)
                    .attr('type', 'text').attr('class', 'form-control')
                    .attr('placeholder', 'JsonPath expression')
                    .attr('style', 'display: none;'))
            .append($('<input />')
                    .attr('id', elementName + '_xpath_' + index)
                    .attr('name', elementName + '_xpath_' + index)
                    .attr('type', 'text').attr('class', 'form-control')
                    .attr('placeholder', 'Xpath expression')
                    .attr('style', 'display: none;'))
            .append($('<input />')
                    .attr('id', elementName + '_xslt_' + index)
                    .attr('name', elementName + '_xslt_' + index)
                    .attr('type', 'text').attr('class', 'form-control')
                    .attr('placeholder', 'Xslt template')
                    .attr('style', 'display: none;')
        );
        if (!includeName) {
            $(inputDiv).attr('class', 'col-sm-8');
        }
        $('#' + divId + ' > .panel-body > #' + elementName + '_exp_prs_ix_' + index).append(inputDiv);
        var actionDiv = $('<div></div>').attr('class', 'col-sm-1').append($('<div class="btn-toolbar" role="group"></div>'));
            if (!includeName) {
            	$(actionDiv).attr('class', 'col-sm-2');
            	$(actionDiv).append($('<button id="' + elementName + '_exp_prs_up_' + index + '" type="button" role="group" class="btn btn-default"><span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span></button>'));
                $(actionDiv).append($('<button id="' + elementName + '_exp_prs_down_' + index + '" type="button" role="group" class="btn btn-default"><span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span></button>'));
            }        
            $(actionDiv).append($('<button id="' + elementName + '_exp_prs_remove_' + index + '" type="button" role="group" class="btn btn-default btn-danger"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>'));
        $('#' + divId + ' > .panel-body > #' + elementName + '_exp_prs_ix_' + index).append(actionDiv);
        $('#' + elementName + '_exp_prs_remove_' + index).click(function() {
            $('#' + elementName + '_exp_prs_ix_' + index).remove();
            styleExpressionParserButtons(divId);
        });
        $('#' + elementName + '_exp_prs_up_' + index).click(function() {
            $('#' + elementName + '_exp_prs_ix_' + index).insertBefore($('#' + elementName + '_exp_prs_ix_' + index).prev());
            styleExpressionParserButtons(divId);
        });
        $('#' + elementName + '_exp_prs_down_' + index).click(function() {
            $('#' + elementName + '_exp_prs_ix_' + index).insertAfter($('#' + elementName + '_exp_prs_ix_' + index).next());
            styleExpressionParserButtons(divId);
        });
        $('#' + elementName + '_select_' + index).change(function() {
            var expressionType = $(this).val();
            if ('fixed_position' == expressionType) {
                $('#' + elementName + '_fixed_pos_line_' + index).show();
                $('#' + elementName + '_fixed_pos_start_' + index).show();
                $('#' + elementName + '_fixed_pos_start_' + index).attr('required', 'required');
                $('#' + elementName + '_fixed_pos_end_' + index).show();
                $('#' + elementName + '_fixed_pos_end_' + index).attr('required', 'required');
                $('#' + elementName + '_fixed_value_' + index).hide();
                $('#' + elementName + '_fixed_value_' + index).removeAttr('required');
                $('#' + elementName + '_json_' + index).hide();
                $('#' + elementName + '_json_' + index).removeAttr('required');
                $('#' + elementName + '_xpath_' + index).hide();
                $('#' + elementName + '_xpath_' + index).removeAttr('required');
                $('#' + elementName + '_xslt_' + index).hide();
                $('#' + elementName + '_xslt_' + index).removeAttr('required');                     
            } else if ('fixed_value' == expressionType) {
                $('#' + elementName + '_fixed_pos_line_' + index).hide();
                $('#' + elementName + '_fixed_pos_start_' + index).hide();
                $('#' + elementName + '_fixed_pos_start_' + index).removeAttr('required');
                $('#' + elementName + '_fixed_pos_end_' + index).hide();
                $('#' + elementName + '_fixed_pos_end_' + index).removeAttr('required');
                $('#' + elementName + '_fixed_value_' + index).show();
                $('#' + elementName + '_fixed_value_' + index).attr('required', 'required');
                $('#' + elementName + '_json_' + index).hide();
                $('#' + elementName + '_json_' + index).removeAttr('required');
                $('#' + elementName + '_xpath_' + index).hide();
                $('#' + elementName + '_xpath_' + index).removeAttr('required');
                $('#' + elementName + '_xslt_' + index).hide();
                $('#' + elementName + '_xslt_' + index).removeAttr('required');
            } else if ('json' == expressionType) {
                $('#' + elementName + '_fixed_pos_line_' + index).hide();
                $('#' + elementName + '_fixed_pos_start_' + index).hide();
                $('#' + elementName + '_fixed_pos_start_' + index).removeAttr('required');
                $('#' + elementName + '_fixed_pos_end_' + index).hide();
                $('#' + elementName + '_fixed_pos_end_' + index).removeAttr('required');
                $('#' + elementName + '_fixed_value_' + index).hide();
                $('#' + elementName + '_fixed_value_' + index).removeAttr('required');
                $('#' + elementName + '_json_' + index).show();
                $('#' + elementName + '_json_' + index).attr('required', 'required');
                $('#' + elementName + '_xpath_' + index).hide();
                $('#' + elementName + '_xpath_' + index).removeAttr('required');
                $('#' + elementName + '_xslt_' + index).hide();
                $('#' + elementName + '_xslt_' + index).removeAttr('required');
            } else if ('xpath' == expressionType) {
                $('#' + elementName + '_fixed_pos_line_' + index).hide();
                $('#' + elementName + '_fixed_pos_start_' + index).hide();
                $('#' + elementName + '_fixed_pos_start_' + index).removeAttr('required');
                $('#' + elementName + '_fixed_pos_end_' + index).hide();
                $('#' + elementName + '_fixed_pos_end_' + index).removeAttr('required');
                $('#' + elementName + '_fixed_value_' + index).hide();
                $('#' + elementName + '_fixed_value_' + index).removeAttr('required');
                $('#' + elementName + '_json_' + index).hide();
                $('#' + elementName + '_json_' + index).removeAttr('required');
                $('#' + elementName + '_xpath_' + index).show();
                $('#' + elementName + '_xpath_' + index).attr('required', 'required');
                $('#' + elementName + '_xslt_' + index).hide();
                $('#' + elementName + '_xslt_' + index).removeAttr('required');
            } else if ('xslt' == expressionType) {
                $('#' + elementName + '_fixed_pos_line_' + index).hide();
                $('#' + elementName + '_fixed_pos_start_' + index).hide();
                $('#' + elementName + '_fixed_pos_start_' + index).removeAttr('required');
                $('#' + elementName + '_fixed_pos_end_' + index).hide();
                $('#' + elementName + '_fixed_pos_end_' + index).removeAttr('required');
                $('#' + elementName + '_fixed_value_' + index).hide();
                $('#' + elementName + '_fixed_value_' + index).removeAttr('required');
                $('#' + elementName + '_json_' + index).hide();
                $('#' + elementName + '_json_' + index).removeAttr('required');
                $('#' + elementName + '_xpath_' + index).hide();
                $('#' + elementName + '_xpath_' + index).removeAttr('required');
                $('#' + elementName + '_xslt_' + index).show();
                $('#' + elementName + '_xslt_' + index).attr('required', 'required');
            }
        });
	};

	var styleExpressionParserButtons = function(divId) {
		var rows = $('#' + divId + ' > .panel-body > .form-group');
		$.each(rows, function(index, row) {
			var upId = row.id.replace('_ix_', '_up_');
			var downId = row.id.replace('_ix_', '_down_');
			$('#' + upId).prop('disabled', false);
			$('#' + downId).prop('disabled', false);
		    if (index == 0) {
		    	$('#' + upId).prop('disabled', true);
			}
			if (index == (rows.length - 1)) {
				$('#' + downId).prop('disabled', true);
			}
		});
	};
	
	var loadEndpointData = function(endpointName) {
		if ('*' === endpointName) {
		    $('#btn_endpoint_delete').attr('disabled', 'disabled');
		} else {
		    $('#btn_endpoint_delete').removeAttr('disabled');
		}		
		$.getJSON('../rest/admin/endpoint/' + encodeURIComponent(endpointName), function (data) {
		      if (!data) {
		          return;
		      }
		      $('#endpoint_name').val(data.name);
		      $('#endpoint_direction').val(data.direction);
		      addExpressionParsers('eventname_parsers', 'eventname_parser', data.eventname_parsers, false);
		      addExpressionParsers('application_parsers', 'application_parser', data.application_parsers, false);
		      addExpressionParsers('transactionname_parsers', 'transactionname_parser', data.transactionname_parsers, false);
		      addExpressionParsers('correlation_parsers', 'correlation_parser', data.correlation_parsers, true);
		});
	};

   var loadLicenseData = function(endpointName) {
          $.getJSON('../rest/system/info', function (data) {
                if (!data) {
                    return;
                }
                $('#license_company').val(data.companyName);
                $('#license_expiry').val(new Date(data.licenseExpiry).toUTCString());
                $('#license_key').val('');
          });
    };

	var handleSubmit = function(formId) {
		  $('#' + formId).submit(function( event ) {
		        event.preventDefault();
		        $('#' + formId + '_errorBox').hide('fast');
		        var json = '{';
		        $('#' + formId + ' :input').each(function(index){
		           if ($(this).attr('name')) {
		               if (index != 0) {
		                   json += ","
		               }
		               if ('number' == $(this).attr('type')) {
		                    json += '"' + $(this).attr('name') +'":' + $(this).val();
		               } else if ('text' == $(this).attr('type') || 'password' == $(this).attr('type') || $(this).is('select')) {
		                   json += '"' + $(this).attr('name') +'":"' + $(this).val() + '"';
		               } else if ('checkbox' == $(this).attr('type')) {
		                   json += '"' + $(this).attr('name') +'":' + $(this).is(':checked');
		               }
		           }
		        });
		        json += '}';
		        $.ajax({
		            type: 'POST',
		            url: $('#' + formId).attr('action'),
		            data: json,
		            contentType: 'application/json',
		            dataType: 'json',
                    error: function(jqXHR) {
                        $('#' + formId + '_errorBox').text('Error saving: ' +  jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')');
                        $('#' + formId + '_errorBox').show('fast');
                    },
                    success: function(jqXHR) {
                    	$('#' + formId + '_infoBox').text('Configuration saved');
                    	$('#' + formId + '_infoBox').show('fast');
                    	$('#' + formId + '_infoBox').delay(infoDelay).hide('fast');
                    }
		         });
		    });
	};

	var handleEndpointSubmit = function() {
        $('#endpoint_form').submit(function( event ) {
            event.preventDefault();
            var btnId = $('#endpoint_form :input[type=submit][clicked=true]').attr('id');
            $("#endpoint_errorBox").hide('fast');
            if ('btn_endpoint_delete' === btnId) {
                var endpointName = $('#endpoint_select').val();
				$.ajax({
				       type: 'DELETE',
				       url: '../rest/admin/endpoint/' + encodeURIComponent(endpointName),
				       contentType: 'application/json',
				       dataType: 'json',
				       success: function(data) {
					       loadEndpoints();
				    	   loadEndpointData('*');
                           $("#endpoint_infoBox").text('Endpoint \'' + endpointName + '\' removed');
                           $("#endpoint_infoBox").show('fast');
                           $("#endpoint_infoBox").delay(infoDelay).hide('fast');
					   },
				       error: function(jqXHR) {
				            $("#endpoint_errorBox").text('Error removing endpoint: ' + jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')');
				            $("#endpoint_errorBox").show('fast');
				       }
				    });
            } else if ('btn_endpoint_save' === btnId) {
            	var endpointName = $('#endpoint_name').val();
                var json = '{';
                json += '"name":"' + endpointName + '"';
                var direction = $('#endpoint_direction').val();
                if ("" !== direction) {
                	json += ',"direction":"' + direction + '"';
                }
                var expressionParsersFormGroup = $('#eventname_parsers .panel-body .form-group');
                if (expressionParsersFormGroup.length > 0) {
                	json += ',"eventname_parsers":' + expressionParserDivToJson(expressionParsersFormGroup);
                }
                expressionParsersFormGroup = $('#application_parsers .panel-body .form-group');
                if (expressionParsersFormGroup.length > 0) {
                    json += ',"application_parsers":' + expressionParserDivToJson(expressionParsersFormGroup);
                }
                expressionParsersFormGroup = $('#transactionname_parsers .panel-body .form-group');
                if (expressionParsersFormGroup.length > 0) {
                    json += ',"transactionname_parsers":' + expressionParserDivToJson(expressionParsersFormGroup);
                }
                expressionParsersFormGroup = $('#correlation_parsers .panel-body .form-group');
                if (expressionParsersFormGroup.length > 0) {
                    json += ',"correlation_parsers":' + expressionParserDivToJson(expressionParsersFormGroup);
                }                
                json += '}';
                $.ajax({
                    type: 'POST',
                    url: '../rest/admin/endpoint/' + encodeURIComponent(endpointName),
                    data: json,
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function(data) {
                        loadEndpoints(endpointName);
                        if ('*' === endpointName) {
                            $('#btn_endpoint_delete').attr('disabled', 'disabled');
                        } else {
                            $('#btn_endpoint_delete').removeAttr('disabled');
                        }
                        $("#endpoint_infoBox").text('Endpoint \'' + endpointName + '\' saved');
                        $("#endpoint_infoBox").show('fast');
                        $("#endpoint_infoBox").delay(infoDelay).hide('fast');
                        
                    },
                    error: function(jqXHR) {
                         $("#endpoint_errorBox").text('Error saving endpoint: ' +  jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')');
                         $("#endpoint_errorBox").show('fast');
                    }
                 });                
            }
        });
	};

	var expressionParserDivToJson = function(formGroups) {
		var json = '[';
		$.each(formGroups, function(index, formGroup) {
			if (index != 0) {
				json += ',';
			}
			json += '{';
			var name = $(formGroup).find('[id*="_parser_name_"]').val();
			if (name != undefined) {
				json += '"name":"' + name + '",';
			}
			var expressionType = $(formGroup).find('[id*="_parser_select_"]').val();
			json += '"type":"' + expressionType + '"';
            if ('fixed_position' == expressionType) {
            	var line = $(formGroup).find('[id*="_fixed_pos_line_"]').val();
            	if (line != undefined) {
            	    json += ',"line":' + parseInt(line);
            	}
            	json += ',"start_pos":' + parseInt($(formGroup).find('[id*="_fixed_pos_start_"]').val());
            	json += ',"end_pos":' + parseInt($(formGroup).find('[id*="_fixed_pos_end_"]').val());
            } else if ('fixed_value' == expressionType) {
            	json += ',"value":"' + $(formGroup).find('[id*="_fixed_value_"]').val() + '"';
            } else if ('json' == expressionType) {
                json += ',"expression":"' + $(formGroup).find('[id*="_json_"]').val() + '"';
            } else if ('xpath' == expressionType) {
            	json += ',"expression":"' + $(formGroup).find('[id*="_xpath_"]').val() + '"';
            } else if ('xslt' == expressionType) {
            	json += ',"template":"' + $(formGroup).find('[id*="_xslt_"]').val() + '"';
            }
			json += '}';
		});
		json += ']';
		return json;
	}
	
	var handleLicenseSubmit = function() {
		$('#license_form').submit(function( event ) {
		    event.preventDefault();
		    $("#license_errorBox").hide('fast');
		    var json = "{";
		    json += '"license.key":"' + $('#license_key').val() + '"';
		    json += "}";
		    $.ajax({
		        type: 'POST',
		        url: $('#license_form').attr('action'),
		        data: json,
		        contentType: 'application/json',
		        dataType: 'json',
		        complete: function () {
		            loadLicenseData();
		        },
		        error: function(jqXHR) {
		            $("#license_errorBox").text('Error updating license: ' +  jqXHR.responseJSON.message + ' (' + jqXHR.responseJSON.code + ')');
		            $("#license_errorBox").show('fast');
		        },
				success: function(jqXHR) {
					$("#license_infoBox").text('New license applied');
					$("#license_infoBox").show('fast');
					$("#license_infoBox").delay(infoDelay).hide('fast');
				}			        
		     });
		});
	};
		
	// Add all nodes to the node select.
	$.getJSON('../rest/admin/nodes/', function (data) {
        if (!data) {
            return;
        }
        $.each(data, function(index, nodeData) {
        	$('#node_select').append($('<option></option>').attr("value", nodeData.name).text(nodeData.name));
        });		
	});
    // Add all endpoints to the endpoint select.
    var loadEndpoints = function(currentSelection) {
	    $.getJSON('../rest/admin/endpoints/', function (data) {
	        if (!data) {
	            return;
	        }
	        $('#endpoint_select').children().slice(2).detach();
	        $.each(data, function(index, endpointName) {
	        	var option = $('<option></option>').attr('value', endpointName).text(endpointName);
	        	if (currentSelection === endpointName) {
	        		$(option).attr('selected', 'selected');
		        }
	            $('#endpoint_select').append($(option));
	        });     
	        
	    });
    };
    	
	// Add the change listener to the node select.
	$('#node_select').change(function() {
		var nodeName = $(this).val();
	    $('#node_title').text('ETM Administration - ' + nodeName);
	    if ('cluster' == nodeName) {
            $('#endpoint_tab_header').removeClass('hidden');
            $('#endpoint_tab').removeClass('hidden');
            $('#license_tab_header').removeClass('hidden');
            $('#license_tab').removeClass('hidden');
		} else {
			var activeTab = $("#tabs > ul > li.active > a").attr('href');
            if ('#endpoint_tab' == activeTab || '#license_tab' == activeTab) {
                $('#tabs a[href="#etm_tab"]').tab('show')
            }
			$('#endpoint_tab_header').addClass('hidden');
            $('#endpoint_tab').addClass('hidden');
            $('#license_tab_header').addClass('hidden');
            $('#license_tab').addClass('hidden');
	    }
	    loadData(nodeName);    
	});

	// Add the change listener to the endpoint select.
	$('#endpoint_select').change(function() {
		var endpointName = $('#endpoint_select').val();
		loadEndpointData(endpointName);
	});

	$('#btn_add_eventname_parser').click(function() {
		appendExpressionParser('eventname_parsers', 'eventname_parser', false);
		styleExpressionParserButtons('eventname_parsers');
	});
    $('#btn_add_application_parser').click(function() {
        appendExpressionParser('application_parsers', 'application_parser', false);
        styleExpressionParserButtons('application_parsers');
    });
    $('#btn_add_transactionname_parser').click(function() {
        appendExpressionParser('transactionname_parsers', 'transactionname_parser', false);
        styleExpressionParserButtons('transactionname_parsers');
    });	      
    $('#btn_add_correlation_parser').click(function() {
        appendExpressionParser('correlation_parsers', 'correlation_parser', true);
        styleExpressionParserButtons('correlation_parsers');
    });
    $('#endpoint_form :input[type=submit]').click(function() {
    	$("#endpoint_form :input[type=submit]").removeAttr('clicked');
    	$(this).attr("clicked", "true");        
    });

	loadData('cluster');
    loadEndpoints();
	loadEndpointData('*');
	loadLicenseData();
	handleSubmit('etm_form');
	handleEndpointSubmit();
	handleLicenseSubmit();

});
//]]>
</script>
</body>
</html>

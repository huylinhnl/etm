<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=9">
<title>Enterprise Telemetry Monitor - Administration</title>
<link rel="stylesheet"
	href="../resources/styles/bootstrap-3.3.1.min.css" />
<script src="../resources/scripts/jquery-2.1.3.min.js"></script>
<script src="../resources/scripts/bootstrap-3.3.1.min.js"></script>
</head>
<body>
	<div class="container" style="margin-top: 0.5em;">
		<div class="row">
			<div class="panel panel-default">
				<div class="panel-heading clearfix">
					<div class="panel-title pull-left" id="node_title">ETM
						Administration - cluster</div>
					<div class="pull-right">
						<select id="node_select" class="form-control">
							<option value="cluster">cluster</option>
							<option disabled="disabled">-----</option>
						</select>
					</div>
				</div>
				<div class="panel-body">
					<div id="tabs" role="tabpanel">
						<!-- Nav tabs -->
						<ul class="nav nav-tabs" role="tablist">
							<li id="etm_tab_header" role="presentation" class="active"><a
								href="#etm_tab" aria-controls="home" role="tab"
								data-toggle="tab">ETM</a></li>
							<li id="endpoint_tab_header" role="presentation"><a
								href="#endpoint_tab" aria-controls="home" role="tab"
								data-toggle="tab">Endpoint</a></li>
							<li id="solr_tab_header" role="presentation"><a
								href="#solr_tab" aria-controls="home" role="tab"
								data-toggle="tab">Solr</a></li>
							<li id="cassandra_tab_header" role="presentation"><a
								href="#cassandra_tab" aria-controls="home" role="tab"
								data-toggle="tab">Cassandra</a></li>
							<li id="status_tab_header" role="presentation"><a
								href="#status_tab" aria-controls="home" role="tab"
								data-toggle="tab">Status</a></li>
						</ul>
						<br />
						<!-- Tab panes -->
						<div class="tab-content">
							<div role="tabpanel" class="tab-pane active" id="etm_tab">
								<form id="etm_form" class="form-horizontal"
									enctype="application/json" method="POST">
									<div class="form-group">
										<label for="etm_enhancing_handler_count"
											class="col-sm-3 control-label">Enhancing handler
											count</label>
										<div class="col-sm-3">
											<input id="etm_enhancing_handler_count"
												name="etm.enhancing_handler_count" type="number"
												class="form-control" required="required" min="0" />
										</div>
										<label for="etm_data_correlation_time_offset"
											class="col-sm-3 control-label">Data correlation time
											offset</label>
										<div class="col-sm-3">
											<input id="etm_data_correlation_time_offset"
												name="etm.data_correlation_time_offset" type="number"
												class="form-control" required="required" min="1" />
										</div>
									</div>

									<div class="form-group">
										<label for="etm_indexing_handler_count"
											class="col-sm-3 control-label">Indexing handler count</label>
										<div class="col-sm-3">
											<input id="etm_indexing_handler_count"
												name="etm.indexing_handler_count" type="number"
												class="form-control" required="required" min="0" />
										</div>
										<label for="etm_data_retention_time"
											class="col-sm-3 control-label">Data retention time</label>
										<div class="col-sm-3">
											<input id="etm_data_retention_time"
												name="etm.data_retention_time" type="number"
												class="form-control" required="required" min="-1" />
										</div>
									</div>

									<div class="form-group">
										<label for="etm_persisting_handler_count"
											class="col-sm-3 control-label">Persisting handler
											count</label>
										<div class="col-sm-3">
											<input id="etm_persisting_handler_count"
												name="etm.persisting_handler_count" type="number"
												class="form-control" required="required" min="0" />
										</div>
										<label for="etm_data_retention_check_interval"
											class="col-sm-3 control-label">Data retention check
											interval</label>
										<div class="col-sm-3">
											<input id="etm_data_retention_check_interval"
												name="etm.data_retention_check_interval" type="number"
												class="form-control" required="required" min="1" />
										</div>
									</div>

									<div class="form-group">
										<label for="etm_ringbuffer_size"
											class="col-sm-3 control-label">Ringbuffer size</label>
										<div class="col-sm-3">
											<input id="etm_ringbuffer_size" name="etm.ringbuffer_size"
												type="number" class="form-control" required="required"
												min="255" />
										</div>
										<label for="etm_data_retention_leader_group"
											class="col-sm-3 control-label">Data retention leader
											group</label>
										<div class="col-sm-3">
											<input id="etm_data_retention_leader_group"
												name="etm.data_retention_leader_group" type="number"
												class="form-control" required="required" min="1" />
										</div>
									</div>

									<div class="form-group">
										<label for="etm_endpoint_cache_expiry_time"
											class="col-sm-3 control-label">Endpoint cache expiry
											time</label>
										<div class="col-sm-3">
											<input id="etm_endpoint_cache_expiry_time"
												name="etm.endpoint_cache_expiry_time" type="number"
												class="form-control" required="required" min="1" />
										</div>
										<label for="etm_data_retention_preserve_event_counts"
											class="col-sm-3 control-label">Data retention
											preserve event counts</label>
										<div class="col-sm-3">
											<input id="etm_data_retention_preserve_event_counts"
												name="etm.data_retention_preserve_event_counts"
												type="checkbox" class="form-control" />
										</div>
									</div>

									<div class="form-group">
										<label for="etm_statistics_time_unit"
											class="col-sm-3 control-label">Statistics time unit</label>
										<div class="col-sm-3">
											<select id="etm_statistics_time_unit"
												name="etm.statistics_timeunit" class="form-control">
												<option value="SECONDS">Seconds</option>
												<option value="MINUTES">Minutes</option>
												<option value="HOURS">Hours</option>
												<option value="DAYS">Days</option>
											</select>
										</div>
										<label for="etm_data_retention_preserve_event_performances"
											class="col-sm-3 control-label">Data retention
											preserve event performances</label>
										<div class="col-sm-3">
											<input id="etm_data_retention_preserve_event_performances"
												name="etm.data_retention_preserve_event_performances"
												type="checkbox" class="form-control" />
										</div>
									</div>

									<div class="form-group">
										<label for="etm_data_correlation_max_matches"
											class="col-sm-3 control-label">Data correlation max
											matches</label>
										<div class="col-sm-3">
											<input id="etm_data_correlation_max_matches"
												name="etm.data_correlation_max_matches" type="number"
												class="form-control" required="required" min="1" />
										</div>
										<label for="etm_data_retention_preserve_transaction_slas"
											class="col-sm-3 control-label">Data retention
											preserve event SLA's</label>
										<div class="col-sm-3">
											<input id="etm_data_retention_preserve_transaction_slas"
												name="etm.data_retention_preserve_transaction_slas"
												type="checkbox" class="form-control" />
										</div>
									</div>
									<input type="submit" class="btn btn-default" value="Save" />
								</form>
							</div>
							<div role="tabpanel" class="tab-pane" id="endpoint_tab">
                                <form id="endpoint_selection_form" class="form-horizontal">
                                    <div class="form-group">
                                        <label for="endpoint_select" class="col-sm-3 control-label">Endpoint</label>
                                        <div class="col-sm-9">
					                        <select id="endpoint_select" class="form-control">
					                            <option value="global">*</option>
					                            <option disabled="disabled">-----</option>
					                        </select>                                        
                                        </div>
                                    </div>
                                </form>
                                <form id="endpoint_form" class="form-horizontal">
                                        <label for="endpoint_name" class="col-sm-3 control-label">Name</label>
                                        <div class="col-sm-3">
                                            <input id="endpoint_name" name="endpoint.name" type="text" class="form-control" required="required" />
                                        </div>
                                        <label for="endpoint_direction" class="col-sm-3 control-label">Direction</label>
                                        <div class="col-sm-3">
                                            <select id="endpoint_direction" name="endpoint.direction" class="form-control">
                                                <option value=""></option>
                                                <option value="INCOMING">Incoming</option>
                                                <option value="OUTGOING">Outgoing</option>
                                            </select>                                        
                                        </div>                                
                                </form>
							</div>
							<div role="tabpanel" class="tab-pane" id="solr_tab">
								<form id="solr_form" class="form-horizontal">
									<div class="form-group">
										<label for="solr_zookeeper_connection"
											class="col-sm-3 control-label">Solr zookeeper
											connection</label>
										<div class="col-sm-3">
											<input id="solr_zookeeper_connection"
												name="solr.zookeeper_connection" type="text"
												class="form-control" required="required" />
										</div>
										<label for="solr_collection" class="col-sm-3 control-label">Collection
											name</label>
										<div class="col-sm-3">
											<input id="solr_collection" name="solr.collection"
												type="text" class="form-control" required="required" />
										</div>
									</div>
									<input type="submit" class="btn btn-default" value="Save" />
								</form>
							</div>
							<div role="tabpanel" class="tab-pane" id="cassandra_tab">
								<form id="cassandra_form" class="form-horizontal">
									<div class="form-group">
										<label for="cassandra_contact_points"
											class="col-sm-3 control-label">Contact points</label>
										<div class="col-sm-3">
											<input id="cassandra_contact_points" name="cassandra.contact_points" type="text"
												class="form-control" required="required" />
										</div>
										<label for="cassandra_username" class="col-sm-3 control-label">Username</label>
										<div class="col-sm-3">
											<input id="cassandra_username" name="cassandra.username" type="text"
												class="form-control" />
										</div>
									</div>

									<div class="form-group">
										<label for="cassandra_keyspace" class="col-sm-3 control-label">Keyspace</label>
										<div class="col-sm-3">
											<input id="cassandra_keyspace" name="cassandra.keyspace" type="text"
												class="form-control" required="required" />
										</div>
										<label for="cassandra_password" class="col-sm-3 control-label">Password</label>
										<div class="col-sm-3">
											<input id="cassandra_password" name="cassandra.password" type="password"
												class="form-control" />
										</div>
									</div>
									<input type="submit" class="btn btn-default" value="Save" />
								</form>
							</div>
							<div role="tabpanel" class="tab-pane" id="status_tab"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
//<![CDATA[        
$(function () {
	var loadData = function(nodeName) {
		$('#etm_form').attr('action', '../rest/admin/node/' + encodeURIComponent(nodeName));
		$('#solr_form').attr('action', '../rest/admin/node/' + encodeURIComponent(nodeName));
		$('#cassandra_form').attr('action', '../rest/admin/node/' + encodeURIComponent(nodeName));
		$.getJSON('../rest/admin/node/' + encodeURIComponent(nodeName), function (data) {
			if (!data) {
			    return;
			}
			$('#etm_enhancing_handler_count').val(data['etm.enhancing_handler_count']);
			$('#etm_indexing_handler_count').val(data['etm.indexing_handler_count']);
			$('#etm_persisting_handler_count').val(data['etm.persisting_handler_count']);
			$('#etm_ringbuffer_size').val(data['etm.ringbuffer_size']);
			$('#etm_endpoint_cache_expiry_time').val(data['etm.endpoint_cache_expiry_time']);
			$('#etm_statistics_time_unit').val(data['etm.statistics_timeunit']);
			$('#etm_data_correlation_max_matches').val(data['etm.data_correlation_max_matches']);
			$('#etm_data_correlation_time_offset').val(data['etm.data_correlation_time_offset']);
			$('#etm_data_retention_time').val(data['etm.data_retention_time']);
			$('#etm_data_retention_check_interval').val(data['etm.data_retention_check_interval']);
			$('#etm_data_retention_leader_group').val(data['etm.data_retention_leader_group']);
			if (data['etm.data_retention_preserve_event_counts']) {
				$('#etm_data_retention_preserve_event_counts').attr('checked', 'checked');
			} else {
				$('#etm_data_retention_preserve_event_counts').removeAttr('checked');
			}
            if (data['etm.data_retention_preserve_event_performances']) {
                $('#etm_data_retention_preserve_event_performances').attr('checked', 'checked');
            } else {
                $('#etm_data_retention_preserve_event_performances').removeAttr('checked');
            }
            if (data['etm.data_retention_preserve_transaction_slas']) {
                $('#etm_data_retention_preserve_transaction_slas').attr('checked', 'checked');
            } else {
                $('#etm_data_retention_preserve_transaction_slas').removeAttr('checked');
            }
            $('#solr_zookeeper_connection').val(data['solr.zookeeper_connection']);
            $('#solr_collection').val(data['solr.collection']);
            $('#cassandra_contact_points').val(data['cassandra.contact_points']);
            $('#cassandra_keyspace').val(data['cassandra.keyspace']);
            $('#cassandra_username').val(data['cassandra.username']);
            $('#cassandra_password').val(data['cassandra.password']);
            $('#status_tab').text(data.name + ' is ' + (data.active ? 'up' : 'down'));
		});
	};

	var loadEndpointData = function(endpointName) {
	      $.getJSON('../rest/admin/endpoint/' + encodeURIComponent(endpointName), function (data) {
	            if (!data) {
	                return;
	            }
	            $('#endpoint_name').val(data.name);
	            $('#endpoint_direction').val(data.direction);
	      });
	};

	var handleSubmit = function(formId) {
		  $('#' + formId).submit(function( event ) {
		        event.preventDefault();
		        var json = "{";
		        $('#' + formId + ' :input').each(function(index){
		           if ($(this).attr('name')) {
		               if (index != 0) {
		                   json += ","
		               }
		               if ('number' == $(this).attr('type')) {
		                    json += '"' + $(this).attr('name') +'":' + $(this).val();
		               } else if ('text' == $(this).attr('type') || 'password' == $(this).attr('type') || $(this).is('select')) {
		                   json += '"' + $(this).attr('name') +'":"' + $(this).val() + '"';
		               } else if ('checkbox' == $(this).attr('type')) {
		                   json += '"' + $(this).attr('name') +'":' + $(this).is(':checked');
		               }
		           }
		           
		        });
		        json += "}";
		        $.ajax({
		            type: 'POST',
		            url: $('#' + formId).attr('action'),
		            data: json,
		            contentType: 'application/json',
		            dataType: 'json',
		         });
		    });
	};
	
	// Add all nodes to the node select.
	$.getJSON('../rest/admin/nodes/', function (data) {
        if (!data) {
            return;
        }
        $.each(data, function(index, nodeData) {
        	$('#node_select').append($('<option></option>').attr("value", nodeData.name).text(nodeData.name));
        });		
	});
    // Add all endpoints to the endpoint select.
    $.getJSON('../rest/admin/endpoints/', function (data) {
        if (!data) {
            return;
        }
        $.each(data, function(index, endpointName) {
            $('#endpoint_select').append($('<option></option>').attr("value", endpointName).text(endpointName));
        });     
    });
    	
	// Add the change listener to the node select.
	$('#node_select').change(function() {
		var nodeName = $('#node_select').val();
	    $('#node_title').text('ETM Administration - ' + nodeName);
	    if ('cluster' == nodeName) {
            $('#endpoint_tab_header').removeClass('hidden');
            $('#endpoint_tab').removeClass('hidden');
            $('#solr_tab_header').removeClass('hidden');
            $('#solr_tab').removeClass('hidden');
		} else {
			var activeTab = $("#tabs > ul > li.active > a").attr('href');
            if ('#endpoint_tab' == activeTab || '#solr_tab' == activeTab) {
                $('#tabs a[href="#etm_tab"]').tab('show')
            }
			$('#endpoint_tab_header').addClass('hidden');
            $('#endpoint_tab').addClass('hidden');
            $('#solr_tab_header').addClass('hidden');
            $('#solr_tab').addClass('hidden');
	    }
	    loadData(nodeName);    
	});

	// Ad the change listener to the endpoint select.
	$('#endpoint_select').change(function() {
		var endpointName = $('#endpoint_select').val();
		loadEndpointData(endpointName);
	});

	loadData('cluster');
	loadEndpointData('*');
	handleSubmit('etm_form');
	handleSubmit('solr_form');
	handleSubmit('cassandra_form');

});
//]]>
</script>
</body>
</html>
